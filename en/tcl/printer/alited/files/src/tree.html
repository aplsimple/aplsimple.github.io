<!DOCTYPE html><html><head><meta charset="utf-8"/>
<meta name="author" content="aplsimple">
<meta name="description" content="aplsimple's home page">
<meta name="keywords" content="aplsimple,home">
</head>
<style>
table{
background-color: #f9f9f9;
margin: 0%;
margin-bottom: 2%;
padding: 0%;
box-shadow: none;
filter: none;
}
pre{
margin: 0%;
margin-bottom: 2%;
padding: 0%;
}
</style>
<script>
function homeLINK() {
  homelink = document.baseURI;
  ilen = 19
  ibase = homelink.indexOf('aplsimple.github');
  if (ibase<0) { ibase = homelink.indexOf('aplsimple_github'); ilen += 10 };
  if (ibase>=0) { homelink = homelink.substring(0,ibase+ilen) };
  return homelink;
};
document.write(' \
<link rel="stylesheet" href="'+homeLINK()+'/en/tcl/printer/zoo/style.css">');
document.write(' \
<link rel="icon" type="image/jpg" href="'+homeLINK()+'/zoo/favicon.jpg">');
document.write('<'+'script src="'+homeLINK()+'/zoo/funcs.js">'+'<'+'/script>');
document.write('<'+'script src="'+homeLINK()+'/en/tcl/printer/zoo/this.js">'+'<'+'/script>');
</script>
<body>
<div id="wrapper">
<div name="divd1" ALIGN="CENTER"> <FONT SIZE=5em color=#b01c20><B>
<noscript>THIS PAGE IS NOT WORKING WITHOUT JAVASCRIPT!
<BR>
<BR>PLEASE, SWITCH ON JAVASCRIPT IN SETTINGS OF YOUR BROWSER AND RELOAD THE PAGE.
</noscript>
</B></FONT></div>
<div id='doc3' class='yui-t2'>
<section id=sec2>
<div id='hd' class='banner'>

<title>tree.tcl</title>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../index.html"><font color=#1a1a1a size=6>  <b>README.md</b></font></div></td></table>

<div id="bodyContent" class="dokuwiki">
<div id="dw__toc" class="dw__toc">
<h3 class="toggle open" style="cursor: pointer;">tree.tcl</h3>
<div aria-expanded="true" style="">

<ul class="toc">
<li><b><a href="#tree.tcl">tree.tcl</a></b></li>
<li><b><a href="#Variables">Variables</a></b></li>
<li><b><a href="#Common">Common</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#tree::SwitchTree">SwitchTree</a><span class=tooltiptext> tree::SwitchTree : Switches trees - units to files and vice versa.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::MoveItem">MoveItem</a><span class=tooltiptext> tree::MoveItem : Moves items of the tree (units or files)
to - direction ("up" or "down")
f1112 - true, if started by keypressing (false, if by mouse)</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::OpenFile">OpenFile</a><span class=tooltiptext> tree::OpenFile : Opens file at clicking a file tree's item.
ID - ID of unit tree</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::CurrentItemByLine">CurrentItemByLine</a><span class=tooltiptext> tree::CurrentItemByLine : Gets item ID of unit tree for a current text position.
pos - the current text position
fullinfo - if yes, returns a full info for the found ID.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::CurrentItem">CurrentItem</a><span class=tooltiptext> tree::CurrentItem : Gets ID of selected item of the tree.
Tree - the tree widget's name
wtree - full path to the tree</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::AddTagSel">AddTagSel</a><span class=tooltiptext> tree::AddTagSel : Adds tagSel tag to the unit tree's item.
wtree - the tree's path
ID - the item's ID</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::NewSelection">NewSelection</a><span class=tooltiptext> tree::NewSelection : Selects a new item of the unit tree.
itnew - ID of the new selected item
line - a relative line number inside the item or an absolute position in the text
topos - if yes, 'line' is an absolute position in the text
Returns ID of the newly selected item.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::SaveCursorPos">SaveCursorPos</a><span class=tooltiptext> tree::SaveCursorPos : Saves current unit's cursor position.
See also: favor::GoToUnit</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::SeeSelection">SeeSelection</a><span class=tooltiptext> tree::SeeSelection : Sees (makes visible) a current selected item in the tree.
wtree - tree's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::syOption">syOption</a><span class=tooltiptext> tree::syOption : Gets -geometry option of dialogues.
sy - relative Y-coordinate of dialogue
See also: unit::Delete, file::Delete</span></div></li></ul>
<li><b><a href="#Create_and_handle_a_tree">Create and handle a tree</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#tree::Create">Create</a><span class=tooltiptext> tree::Create : Creates a tree of units/files, at need.
See also: CreateFilesTree</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::UnitTitle">UnitTitle</a><span class=tooltiptext> tree::UnitTitle : Gets a title of a unit (checking for empty string).
title - original title
l1 - first line of the unit
l2 - latst line of the unit</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::CreateUnitsTree">CreateUnitsTree</a><span class=tooltiptext> tree::CreateUnitsTree : Creates a unit tree for a tab.
TID - a current tab's ID
wtree - the tree's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::ColorUnitsTree">ColorUnitsTree</a><span class=tooltiptext> tree::ColorUnitsTree : Color units of the tree.
TID - a current tab's ID
wtxt - text's path
wtree - tree's path
wait - waiting mode: -1 no wait, >0 wait for highlighting done, 0 waiting done</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::CreateFilesTree">CreateFilesTree</a><span class=tooltiptext> tree::CreateFilesTree : Creates a file tree.
wtree - the tree's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::NewItemID">NewItemID</a><span class=tooltiptext> tree::NewItemID : Gets a new ID for the tree item.
iit - index of the new item.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::AddTags">AddTags</a><span class=tooltiptext> tree::AddTags : Creates tags for the tree.
wtree - the tree's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::AddItem">AddItem</a><span class=tooltiptext> tree::AddItem : Adds a new item to the tree.
ID - an item's ID where the new item will be added (for the file tree).</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::DelItem">DelItem</a><span class=tooltiptext> tree::DelItem : Removes an item from the tree.
ID - an item's ID to be deleted.
sy - relative Y-coordinate for a query</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::Delete">Delete</a><span class=tooltiptext> tree::Delete : Removes recursively an item and its children from the tree.
wtree - the tree widget's path
item - ID of the item to be deleted.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::AdjustWidth">AdjustWidth</a><span class=tooltiptext> tree::AdjustWidth : Fixes a problem with the tree scrollbar's width at resizing the panes.
The problem occurs if Frame's width is less than Tree's + Scrollbar's, as
then the scrollbar is squeezed. Thus the Tree's width should be adjusted.
The restart of alited will fully repair this.</span></div></li></ul>
<li><b><a href="#Buttons_handlers">Buttons handlers</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#tree::ShowPopupMenu">ShowPopupMenu</a><span class=tooltiptext> tree::ShowPopupMenu : Creates and opens a popup menu at right clicking the tree.
ID - ID of clicked item
X - x-coordinate of the click
Y - y-coordinate of the click</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::ButtonPress">ButtonPress</a><span class=tooltiptext> tree::ButtonPress : Handles a mouse clicking the tree.
but - mouse button
x - x-coordinate to identify an item
y - y-coordinate to identify an item
X - x-coordinate of the click
Y - x-coordinate of the click</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::DropItems">DropItems</a><span class=tooltiptext> tree::DropItems : Drops (moves) selected items to a current position.
ID - ID of an item to be clicked</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::SelectUnits">SelectUnits</a><span class=tooltiptext> tree::SelectUnits : Selects units at Ctrl/Shift clicking the unit tree.
wtree - path to tree widget
ctrl - 1 if pressed Ctrl/Shift key at clicking</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::ButtonRelease">ButtonRelease</a><span class=tooltiptext> tree::ButtonRelease : Handles a mouse button releasing on the tree, at moving an item.
but - mouse button
s - state (ctrl/alt/shift)
x - x-coordinate to identify an item
y - y-coordinate to identify an item
X - x-coordinate of the click
Y - x-coordinate of the click</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::ButtonMotion">ButtonMotion</a><span class=tooltiptext> tree::ButtonMotion : Starts moving an item of the tree.
but - mouse button
s - state (ctrl/alt/shift)
x - x-coordinate to identify an item
y - y-coordinate to identify an item
X - x-coordinate of the click
Y - x-coordinate of the click</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::DestroyMoveWindow">DestroyMoveWindow</a><span class=tooltiptext> tree::DestroyMoveWindow : Destroys an item moving window.
cancel - if yes, clears also the related variables.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::UnitTooltip">UnitTooltip</a><span class=tooltiptext> tree::UnitTooltip : Gets unit's tooltip.
wtxt - text's path
l1 - 1st line's number
l2 - last line's number</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::GetTooltip">GetTooltip</a><span class=tooltiptext> tree::GetTooltip : Gets a tip for unit / file tree's item.
ID - ID of treeview item
NC - column of treeview item</span></div></li></ul>
<li><b><a href="#Directories_procs">Directories procs</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#tree::PrepareDirectoryContents">PrepareDirectoryContents</a><span class=tooltiptext> tree::PrepareDirectoryContents : Prepares reading a directory's contents.
See also: GetDirectoryContents</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::GetDirectoryContents">GetDirectoryContents</a><span class=tooltiptext> tree::GetDirectoryContents : Gets a directory's contents.
dirname - the directory's name
Returns a list containing the directory's contents.
See also: DirContents</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::DirContents">DirContents</a><span class=tooltiptext> tree::DirContents : Reads a directory's contents.
dirname - a dirtectory's name
lev - level in the directory hierarchy
iroot - index of the directory's parent or -1
globs - list of globs to filter files.
See also:
GetDirectoryContents
AddToDirContents</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::AddToDirContents">AddToDirContents</a><span class=tooltiptext> tree::AddToDirContents : Adds an item to a list of directory's contents.
lev - level in the directory hierarchy
isfile - a flag "file" (if yes) or "directory" (if no)
fname - a file name to be added
iroot - index of the directory's parent or -1</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::IgnoredDir">IgnoredDir</a><span class=tooltiptext> tree::IgnoredDir : Checks if a directory is in the list of the ignored ones.
dir - the directory's name</span></div></li></ul>
<li><b><a href="#Tree_procs">Tree procs</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#tree::ForEach">ForEach</a><span class=tooltiptext> tree::ForEach : Scans all items of the tree.
wtree - the tree's path
aproc - a procedure to run at scanning
lev - level of the tree
branch - ID of the branch to be scanned
The 'aproc' argument can include wildcards to be replaced
appropriate data:
%level - current tree level
%children - children of a current item
%item - ID of a current item
%text - text of a current item
%values - values of a current item</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::GetTree">GetTree</a><span class=tooltiptext> tree::GetTree : Gets a tree or its branch.
parent - ID of the branch
Tree - name of the tree widget
wtree - full path to the tree</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::ExpandContractTree">ExpandContractTree</a><span class=tooltiptext> tree::ExpandContractTree : Expands or contracts the tree.
Tree - the tree's name
isexp - yes, if to expand; no, if to contract</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::RecreateTree">RecreateTree</a><span class=tooltiptext> tree::RecreateTree : Recreates the tree and restores its selections.
wtree - the tree's path
headers - a list of selected items
clearsel - if yes, clears tree's selection</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#tree::UpdateFileTree">UpdateFileTree</a><span class=tooltiptext> tree::UpdateFileTree : Updates the file tree (colors of files).
doit - yes, if run after idle
See also: CreateFilesTree</span></div></li></ul>
<li><b><a href="#EOF">EOF</a></b></li>

</ul>

</div>
</div>
</div>
<!-- TOC END -->

<h1><font color=#ca14ca> alited's source</font></h1>
</p><p>
The <a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/about.html">alited/src</a> directory contains alited's own source files.
</p><p>
Some additional alited's files are also contained in <a href="https://aplsimple.github.io/en/tcl/printer/alited/files/lib/addon/hl_alm.html">alited/lib/addon</a> directory (<i><font color=#1b1baa>alited/lib</font></i> directory contains all library files).
</p><p>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/about.html">about.tcl</a> - "About alited" dialogue.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/alited.html">alited.tcl</a> - The alited's main script to start.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/bar.html">bar.tcl</a> - Handles the bar of tabs.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/check.html">check.tcl</a> - "Check Tcl" dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/complete.html">complete.tcl</a> - Handles auto-completion.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/edit.html">edit.tcl</a> - "Edit" menu's procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/favor.html">favor.tcl</a> - Handles the favorite and last visited units.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/favor_ls.html">favor_ls.tcl</a> - "Saved lists of favorites" dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/file.html">file.tcl</a> - "File" menu's procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/find.html">find.tcl</a> - "Find / Replace" dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/format.html">format.tcl</a> - "Edit / Formats" menu's procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/img.html">img.tcl</a> - List of images used by alited.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/indent.html">indent.tcl</a> - Handles text indentation.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/info.html">info.tcl</a> - Handles the info bar.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/ini.html">ini.tcl</a> - Handles initializing alited.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/keys.html">keys.tcl</a> - Handles keyboard (mapping etc.).</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/main.html">main.tcl</a> - Handles the main form of alited.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/menu.html">menu.tcl</a> - Handles alited's menus.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/msgs.html">msgs.tcl</a> - Localized messages used in several places.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/paver.html">paver.tcl</a> - "Tools / Paver" tool.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/pkgIndex.html">pkgIndex.tcl</a> - Includes README.md text (for Ruff doc generator).</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/pref.html">pref.tcl</a> - "Preferences" dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/preview.html">preview.tcl</a> - "Preview (theme, CS)" dialogue called by "Preferences".</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/printer.html">printer.tcl</a> - "Tools / Project Printer" dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/project.html">project.tcl</a> - "Projects" dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/run.html">run.tcl</a> - "Tools / Run..." dialogue and procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/tool.html">tool.tcl</a> - "Tools" menu's procedures.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/tree.html">tree.tcl</a> - Handles the tree of units and files.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/unit.html">unit.tcl</a> - Handles the unit tree.</li>
<li><a href="https://aplsimple.github.io/en/tcl/printer/alited/files/src/unit_tpl.html">unit_tpl.tcl</a> - "Templates" dialogue and procedures.</li>
</p><p>

</p>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../index.html"><font color=#1a1a1a size=6>  <b>tree.tcl</b></font></div></td></table>

<pre class="code"><i><font color=#4b5d50>###########################################################<a id=tree.tcl></a></font></i>
<i><font color=#4b5d50># Name:    tree.tcl</font></i>
<i><font color=#4b5d50># Author:  Alex Plotnikov  (aplsimple@gmail.com)</font></i>
<i><font color=#4b5d50># Date:    06/23/2021</font></i>
<i><font color=#4b5d50># Brief:   Handles unit/file tree procedures.</font></i>
<i><font color=#4b5d50># License: MIT.</font></i>
<i><font color=#4b5d50>###########################################################</font></i>
<a id=Variables></a>
<i><font color=#4b5d50># ________________________ Variables _________________________ #</font></i>

<b><font color=#ca14ca>namespace</font></b> eval tree {
  <b><font color=#3a6797>variable</font></b> doFocus yes  ;<i><font color=#4b5d50># flag &quot;set focus on a text&quot;</font></i>
  <b><font color=#3a6797>variable</font></b> tipID {}     ;<i><font color=#4b5d50># tree ID with shown tip</font></i>
}
<a id=Common></a>
<i><font color=#4b5d50># ________________________ Common _________________________ #</font></i>
<a id=tree::SwitchTree></a>
<b><font color=#ca14ca>proc</font></b> tree::SwitchTree {} {
  <i><font color=#4b5d50># Switches trees - units to files and vice versa.</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> al(TREE,isunits) [<b><font color=#3a6797>expr</font></b> {!<font color=#1b1baa>$al(TREE,isunits)</font>}]]} {
    <b><font color=#3a6797>unset</font></b> al(widthPanBM)  ;<i><font color=#4b5d50># the variable used to save the panel's size</font></i>
    [<font color=#1b1baa>$obPav</font> PanL] add [<font color=#1b1baa>$obPav</font> FraFV]
    RecreateTree
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> al(widthPanBM) [<b><font color=#134070>winfo</font></b> geometry [<font color=#1b1baa>$::alited::obPav</font> PanBM]]
    [<font color=#1b1baa>$obPav</font> PanL] forget [<font color=#1b1baa>$obPav</font> FraFV]
    <b><font color=#3a6797>set</font></b> al(TREE,files) no
    Create
  }
  alited::main::FocusText
  <b><font color=#3a6797>update</font></b> idletasks
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::MoveItem></a>
<b><font color=#ca14ca>proc</font></b> tree::MoveItem {to {f1112 no}} {
  <i><font color=#4b5d50># Moves items of the tree (units or files)</font></i>
  <i><font color=#4b5d50>#   to - direction (&quot;up&quot; or &quot;down&quot;)</font></i>
  <i><font color=#4b5d50>#   f1112 - true, if started by keypressing (false, if by mouse)</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$al(TREE,isunits)</font> && [alited::file::MoveExternal <font color=#1b1baa>$f1112</font>]} <b><font color=#ca14ca>return</font></b>
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>set</font></b> itemID [<font color=#1b1baa>$wtree</font> selection]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$itemID</font> eq {}} {
    <b><font color=#3a6797>set</font></b> itemID [<font color=#1b1baa>$wtree</font> focus]
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$itemID</font> eq {}} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$f1112</font>} {<b><font color=#3a6797>set</font></b> geo {}} {<b><font color=#3a6797>set</font></b> geo {<font color=#653760>-geometry</font> pointer+10+10}}
    alited::Message {No item selected.} 4
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    alited::unit::MoveUnits <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$to</font> <font color=#1b1baa>$itemID</font> <font color=#1b1baa>$f1112</font>
  } <b><font color=#3a6797>else</font></b> {
    alited::file::MoveFiles <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$to</font> <font color=#1b1baa>$itemID</font> <font color=#1b1baa>$f1112</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::OpenFile></a>
<b><font color=#ca14ca>proc</font></b> tree::OpenFile {{ID <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Opens file at clicking a file tree's item.</font></i>
  <i><font color=#4b5d50>#   ID - ID of unit tree</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ID</font> eq {}} {
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> ID [<font color=#1b1baa>$wtree</font> selection]] eq {}} <b><font color=#ca14ca>return</font></b>
    }
    <b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-values</font>] -&gt; fname isfile
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$isfile</font>} {
      alited::file::OpenFile <font color=#1b1baa>$fname</font>
      <b><font color=#3a6797>after</font></b> idle {alited::bar::BAR draw; alited::tree::UpdateFileTree}
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::CurrentItemByLine></a>
<b><font color=#ca14ca>proc</font></b> tree::CurrentItemByLine {{pos <font color=#8b2a0e>&quot;&quot;</font>} {fullinfo no}} {
  <i><font color=#4b5d50># Gets item ID of unit tree for a current text position.</font></i>
  <i><font color=#4b5d50>#   pos - the current text position</font></i>
  <i><font color=#4b5d50>#  fullinfo - if yes, returns a full info for the found ID.</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$pos</font> eq {}} {
    <b><font color=#3a6797>set</font></b> pos [[alited::main::CurrentWTXT] index insert]
  }
  <b><font color=#3a6797>set</font></b> l [<b><font color=#3a6797>expr</font></b> {int(<font color=#1b1baa>$pos</font>)}]
  <b><font color=#3a6797>set</font></b> TID [alited::bar::CurrentTabID]
  <b><font color=#3a6797>set</font></b> L 0
  <b><font color=#3a6797>set</font></b> R [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$al(_unittree,$TID)</font>]
  <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$L</font>&lt;<font color=#1b1baa>$R</font>} {
    <b><font color=#3a6797>set</font></b> m [<b><font color=#3a6797>expr</font></b> {int((<font color=#1b1baa>$L</font>+<font color=#1b1baa>$R</font>)/2)}]
    <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$al(_unittree,$TID)</font> <font color=#1b1baa>$m</font>] lev leaf fl1 title l1 l2 ID
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$l2</font>&lt;<font color=#1b1baa>$l</font>} {
      <b><font color=#3a6797>set</font></b> L [<b><font color=#3a6797>incr</font></b> m]
    } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$l1</font>&gt;<font color=#1b1baa>$l</font>} {
      <b><font color=#3a6797>set</font></b> R <font color=#1b1baa>$m</font>
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$fullinfo</font>} {
        <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$ID</font> <font color=#1b1baa>$lev</font> <font color=#1b1baa>$leaf</font> <font color=#1b1baa>$fl1</font> <font color=#1b1baa>$title</font> <font color=#1b1baa>$l1</font> <font color=#1b1baa>$l2</font>]
      }
      <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$ID</font>
    }
  }
  <b><font color=#ca14ca>return</font></b> {}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::CurrentItem></a>
<b><font color=#ca14ca>proc</font></b> tree::CurrentItem {{Tree Tree} {wtree <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Gets ID of selected item of the tree.</font></i>
  <i><font color=#4b5d50>#   Tree - the tree widget's name</font></i>
  <i><font color=#4b5d50>#   wtree - full path to the tree</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wtree</font> eq {}} {<b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> <font color=#1b1baa>$Tree</font>]}
  <b><font color=#3a6797>set</font></b> it [<font color=#1b1baa>$wtree</font> focus]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$it</font> eq {}} {<b><font color=#3a6797>set</font></b> it [<b><font color=#3a6797>lindex</font></b> [<font color=#1b1baa>$wtree</font> selection] 0]}
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$it</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::AddTagSel></a>
<b><font color=#ca14ca>proc</font></b> tree::AddTagSel {wtree ID} {
  <i><font color=#4b5d50># Adds tagSel tag to the unit tree's item.</font></i>
  <i><font color=#4b5d50>#   wtree - the tree's path</font></i>
  <i><font color=#4b5d50>#   ID - the item's ID</font></i>

  <b><font color=#3a6797>set</font></b> leaf [<b><font color=#3a6797>lindex</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-values</font>] 5]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> is true <font color=#653760>-strict</font> <font color=#1b1baa>$leaf</font>] && ![<font color=#1b1baa>$wtree</font> tag has tagTODO <font color=#1b1baa>$ID</font>]} {
    <font color=#1b1baa>$wtree</font> tag add tagSel <font color=#1b1baa>$ID</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::NewSelection></a>
<b><font color=#ca14ca>proc</font></b> tree::NewSelection {{itnew <font color=#8b2a0e>&quot;&quot;</font>} {line 0} {topos no}} {
  <i><font color=#4b5d50># Selects a new item of the unit tree.</font></i>
  <i><font color=#4b5d50>#   itnew - ID of the new selected item</font></i>
  <i><font color=#4b5d50>#   line - a relative line number inside the item or an absolute position in the text</font></i>
  <i><font color=#4b5d50>#   topos - if yes, 'line' is an absolute position in the text</font></i>
  <i><font color=#4b5d50># Returns ID of the newly selected item.</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>variable</font></b> doFocus
  <b><font color=#3a6797>set</font></b> TID [alited::bar::CurrentTabID]
  <b><font color=#3a6797>set</font></b> wtxt [alited::main::CurrentWTXT]
  <b><font color=#3a6797>set</font></b> ctab [alited::bar::CurrentTabID]
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <i><font color=#4b5d50># newly selected item</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$itnew</font> eq {}} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$topos</font>} {
      <b><font color=#3a6797>set</font></b> itnew [CurrentItemByLine <font color=#1b1baa>$line</font>]
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> itnew [CurrentItem]
    }
  }
  <b><font color=#3a6797>set</font></b> header [alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$itnew</font>]
  <b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$itnew</font> <font color=#653760>-values</font>] l1 l2
  AddTagSel <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$itnew</font>
  <i><font color=#4b5d50># get saved pos</font></i>
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists al(CPOS,<font color=#1b1baa>$ctab</font>,<font color=#1b1baa>$header</font>)]} {
    <b><font color=#3a6797>set</font></b> pos [::apave::p+ <font color=#1b1baa>$l1</font> <font color=#1b1baa>$al(CPOS,$ctab,$header)</font>]
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> pos [<font color=#1b1baa>$wtxt</font> index insert]
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$topos</font>} {
    <b><font color=#3a6797>set</font></b> pos <font color=#1b1baa>$line</font>
  } <b><font color=#3a6797>elseif</font></b> {[<b><font color=#3a6797>string</font></b> is digit <font color=#653760>-strict</font> <font color=#1b1baa>$l1</font>] && [<b><font color=#3a6797>string</font></b> is digit <font color=#653760>-strict</font> <font color=#1b1baa>$l2</font>]} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> is double <font color=#653760>-strict</font> <font color=#1b1baa>$line</font>] && <font color=#1b1baa>$line</font> != 0 && \
    <font color=#1b1baa>$l1</font>&lt;(<font color=#1b1baa>$l1</font>+<font color=#1b1baa>$line</font>) && (<font color=#1b1baa>$l1</font>+<font color=#1b1baa>$line</font>)&lt;(<font color=#1b1baa>$l2</font>+1)} {
      <i><font color=#4b5d50># it's coming from a saved favorite item</font></i>
      <b><font color=#3a6797>set</font></b> pos [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$l1</font>+<font color=#1b1baa>$line</font>}]
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$pos</font>&lt;<font color=#1b1baa>$l1</font> || <font color=#1b1baa>$pos</font>&gt;=(<font color=#1b1baa>$l2</font>+1)} {
        <i><font color=#4b5d50># if not saved, get it from 1st line</font></i>
        <b><font color=#3a6797>set</font></b> pos <font color=#1b1baa>$l1</font>.0
      }
    }
  }
  <i><font color=#4b5d50># previously selected item</font></i>
  <b><font color=#3a6797>lassign</font></b> [alited::bar::BAR cget <font color=#653760>--currSelTab</font> <font color=#653760>--currSelItem</font>] otab itold
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$itold</font> ne <font color=#8b2a0e>&quot;&quot;</font> && ![<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$itold</font> <font color=#653760>-values</font>] o1 o2}]} {
    <i><font color=#4b5d50># if there was the previously selected item, save its cursor position</font></i>
    <b><font color=#3a6797>catch</font></b> {
      <i><font color=#4b5d50># -values at files' tree is invalid for this =&gt; 'catch'</font></i>
      <i><font color=#4b5d50># (then pos=saved position for the whole file, got from --pos)</font></i>
      <b><font color=#3a6797>set</font></b> opos [<font color=#1b1baa>$wtxt</font> index insert]
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$o1</font>&lt;=<font color=#1b1baa>$opos</font> && <font color=#1b1baa>$opos</font>&lt;(<font color=#1b1baa>$o2</font>+1)} {
        <b><font color=#3a6797>set</font></b> ohead [alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$itold</font>]
        <b><font color=#3a6797>set</font></b> al(CPOS,<font color=#1b1baa>$otab</font>,<font color=#1b1baa>$ohead</font>) [::apave::p+ <font color=#1b1baa>$opos</font> -<font color=#1b1baa>$o1</font>]
      }
    }
  }
  alited::bar::BAR configure <font color=#653760>--currSelTab</font> <font color=#1b1baa>$ctab</font> <font color=#653760>--currSelItem</font> <font color=#1b1baa>$itnew</font>
  <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> al(CPOS,<font color=#1b1baa>$ctab</font>,<font color=#1b1baa>$header</font>) [::apave::p+ <font color=#1b1baa>$pos</font> -<font color=#1b1baa>$l1</font>]}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$doFocus</font>} {
    alited::main::FocusText <font color=#1b1baa>$TID</font> <font color=#1b1baa>$pos</font>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font> && <font color=#1b1baa>$al(dolastvisited)</font>} {
    alited::favor::LastVisited [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$itnew</font>] <font color=#1b1baa>$header</font>
  }
  alited::main::UpdateGutter
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$itnew</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::SaveCursorPos></a>
<b><font color=#ca14ca>proc</font></b> tree::SaveCursorPos {} {
  <i><font color=#4b5d50># Saves current unit's cursor position.</font></i>
  <i><font color=#4b5d50># See also: favor::GoToUnit</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> TID [alited::bar::CurrentTabID]
  <b><font color=#3a6797>set</font></b> wtxt [alited::main::CurrentWTXT]
  <b><font color=#3a6797>set</font></b> pos [<font color=#1b1baa>$wtxt</font> index insert]
  <i><font color=#4b5d50># catch is needed at creating text, as the tree doesn't exist</font></i>
  <b><font color=#3a6797>catch</font></b> {
    <b><font color=#3a6797>set</font></b> itnew [CurrentItemByLine <font color=#1b1baa>$pos</font>]
    <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
    <b><font color=#3a6797>set</font></b> header [alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$itnew</font>]
    <i><font color=#4b5d50># save the position to unit tree list, to restore it in favor::GoToUnit</font></i>
    <b><font color=#3a6797>set</font></b> it [<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-exact</font> <font color=#653760>-index</font> 6 <font color=#1b1baa>$al(_unittree,$TID)</font> <font color=#1b1baa>$itnew</font>]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$it</font>&gt;-1} {
      <b><font color=#3a6797>set</font></b> item [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$al(_unittree,$TID)</font> <font color=#1b1baa>$it</font>]
      <b><font color=#3a6797>set</font></b> item [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$item</font> 7 7 <font color=#1b1baa>$pos</font>]
      <b><font color=#3a6797>set</font></b> al(_unittree,<font color=#1b1baa>$TID</font>) [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$al(_unittree,$TID)</font> <font color=#1b1baa>$it</font> <font color=#1b1baa>$it</font> <font color=#1b1baa>$item</font>]
    }
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$pos</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::SeeSelection></a>
<b><font color=#ca14ca>proc</font></b> tree::SeeSelection {{wtree <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Sees (makes visible) a current selected item in the tree.</font></i>
  <i><font color=#4b5d50>#   wtree - tree's path</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wtree</font> eq {}} {<b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]}
  <b><font color=#3a6797>set</font></b> selection [<font color=#1b1baa>$wtree</font> selection]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$selection</font>]==1} {<font color=#1b1baa>$wtree</font> see <font color=#1b1baa>$selection</font>}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::syOption></a>
<b><font color=#ca14ca>proc</font></b> tree::syOption {sy} {
  <i><font color=#4b5d50># Gets -geometry option of dialogues.</font></i>
  <i><font color=#4b5d50>#   sy - relative Y-coordinate of dialogue</font></i>
  <i><font color=#4b5d50># See also: unit::Delete, file::Delete</font></i>

  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$sy</font> eq {}} {
    <b><font color=#3a6797>set</font></b> opt {}
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> opt [<b><font color=#3a6797>list</font></b> <font color=#653760>-geometry</font> pointer+10+<font color=#1b1baa>$sy</font>]
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$opt</font>
}
<a id=Create_and_handle_a_tree></a>
<i><font color=#4b5d50># ________________________ Create and handle a tree _________________________ #</font></i>
<a id=tree::Create></a>
<b><font color=#ca14ca>proc</font></b> tree::Create {} {
  <i><font color=#4b5d50># Creates a tree of units/files, at need.</font></i>
  <i><font color=#4b5d50># See also: CreateFilesTree</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font> && <font color=#1b1baa>$al(TREE,units)</font> \
  || !<font color=#1b1baa>$al(TREE,isunits)</font> && <font color=#1b1baa>$al(TREE,files)</font>} <b><font color=#ca14ca>return</font></b>  ;<i><font color=#4b5d50># no need</font></i>
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <b><font color=#134070>pack</font></b> forget [<font color=#1b1baa>$obPav</font> BtTRenT] ;<i><font color=#4b5d50># hide file buttons for unit tree</font></i>
    <b><font color=#134070>pack</font></b> forget [<font color=#1b1baa>$obPav</font> BtTCloT]
    <b><font color=#134070>pack</font></b> forget [<font color=#1b1baa>$obPav</font> BtTOpen]
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#134070>pack</font></b> [<font color=#1b1baa>$obPav</font> BtTRenT] <font color=#653760>-side</font> left <font color=#653760>-after</font> [<font color=#1b1baa>$obPav</font> BtTAddT]  ;<i><font color=#4b5d50># show file buttons</font></i>
    <b><font color=#134070>pack</font></b> [<font color=#1b1baa>$obPav</font> BtTCloT] <font color=#653760>-side</font> left <font color=#653760>-after</font> [<font color=#1b1baa>$obPav</font> BtTDelT]
    <b><font color=#134070>pack</font></b> [<font color=#1b1baa>$obPav</font> BtTOpen] <font color=#653760>-side</font> left <font color=#653760>-after</font> [<font color=#1b1baa>$obPav</font> BtTCloT]
    <i><font color=#4b5d50># for file tree: get its current &quot;open branch&quot; flags</font></i>
    <i><font color=#4b5d50># in order to check them in CreateFilesTree</font></i>
    <b><font color=#3a6797>set</font></b> al(SAVED_FILE_TREE) [<b><font color=#3a6797>list</font></b>]
    <b><font color=#3a6797>foreach</font></b> item [GetTree] {
      <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$item</font> - - ID - values
      <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$values</font> -&gt; fname isfile
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> is false <font color=#653760>-strict</font> <font color=#1b1baa>$isfile</font>]} {
        <b><font color=#3a6797>lappend</font></b> al(SAVED_FILE_TREE) [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$fname</font> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-open</font>]]
      }
    }
  }
  <b><font color=#3a6797>set</font></b> TID [alited::bar::CurrentTabID]
  Delete <font color=#1b1baa>$wtree</font> {} <font color=#1b1baa>$TID</font>
  AddTags <font color=#1b1baa>$wtree</font>
  <font color=#1b1baa>$wtree</font> tag bind tagNorm &lt;ButtonPress&gt; {<b><font color=#3a6797>after</font></b> idle {alited::tree::ButtonPress %b %x %y %X %Y}}
  <font color=#1b1baa>$wtree</font> tag bind tagNorm &lt;ButtonRelease&gt; {<b><font color=#3a6797>after</font></b> idle {alited::tree::ButtonRelease %b %s %x %y %X %Y}}
  <font color=#1b1baa>$wtree</font> tag bind tagNorm &lt;Motion&gt; {<b><font color=#3a6797>after</font></b> idle {alited::tree::ButtonMotion %b %s %x %y %X %Y}}
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wtree</font> &lt;ButtonRelease&gt; {alited::tree::DestroyMoveWindow no}
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wtree</font> &lt;Leave&gt; {alited::tree::DestroyMoveWindow yes}
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wtree</font> &lt;F2&gt; {alited::file::RenameFileInTree 0 -}
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wtree</font> &lt;Insert&gt; {alited::tree::AddItem}
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wtree</font> &lt;Delete&gt; {alited::tree::DelItem {} {}}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    CreateUnitsTree <font color=#1b1baa>$TID</font> <font color=#1b1baa>$wtree</font>
  } <b><font color=#3a6797>else</font></b> {
    CreateFilesTree <font color=#1b1baa>$wtree</font>
    <b><font color=#3a6797>unset</font></b> al(SAVED_FILE_TREE)
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::UnitTitle></a>
<b><font color=#ca14ca>proc</font></b> tree::UnitTitle {title l1 l2} {
  <i><font color=#4b5d50># Gets a title of a unit (checking for empty string).</font></i>
  <i><font color=#4b5d50>#   title - original title</font></i>
  <i><font color=#4b5d50>#   l1 - first line of the unit</font></i>
  <i><font color=#4b5d50>#   l2 - latst line of the unit</font></i>

  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$title</font> eq {}} {<b><font color=#3a6797>set</font></b> title <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>::alited::al(MC,lines) <font color=#1b1baa>$</font>l1-<font color=#1b1baa>$</font>l2&quot;</font>}
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$title</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::CreateUnitsTree></a>
<b><font color=#ca14ca>proc</font></b> tree::CreateUnitsTree {TID wtree} {
  <i><font color=#4b5d50># Creates a unit tree for a tab.</font></i>
  <i><font color=#4b5d50>#   TID - a current tab's ID</font></i>
  <i><font color=#4b5d50>#   wtree - the tree's path</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> al(TREE,units) yes
  [<font color=#1b1baa>$obPav</font> BtTswitch] configure <font color=#653760>-image</font> alimg_folder
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTswitch] <font color=#1b1baa>$al(MC,swunits)</font>
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTAddT] <font color=#1b1baa>$al(MC,tpl)</font>
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTDelT] <font color=#1b1baa>$al(MC,unitsdel)</font>
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTUp] <font color=#1b1baa>$al(MC,moveupU)</font>
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTDown] <font color=#1b1baa>$al(MC,movedownU)</font>
  <font color=#1b1baa>$wtree</font> heading #0 <font color=#653760>-text</font> [alited::bar::CurrentTab 1]
  <font color=#1b1baa>$wtree</font> heading #1 <font color=#653760>-text</font> [msgcat::mc Row]
  <b><font color=#3a6797>set</font></b> parents [<b><font color=#3a6797>list</font></b> {}]
  <b><font color=#3a6797>set</font></b> parent {}
  <b><font color=#3a6797>set</font></b> levprev -1
  <b><font color=#3a6797>set</font></b> wtxt [alited::main::GetWTXT <font color=#1b1baa>$TID</font>]
  <b><font color=#3a6797>foreach</font></b> item <font color=#1b1baa>$al(_unittree,$TID)</font> {
    <b><font color=#3a6797>incr</font></b> iiuni
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$item</font>]&lt;3} <b><font color=#ca14ca>continue</font></b>
    <b><font color=#3a6797>set</font></b> itemID  [alited::tree::NewItemID [<b><font color=#3a6797>incr</font></b> iit]]
    <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$item</font> lev leaf fl1 title l1 l2
    <b><font color=#3a6797>set</font></b> title [UnitTitle <font color=#1b1baa>$title</font> <font color=#1b1baa>$l1</font> <font color=#1b1baa>$l2</font>]
    <b><font color=#3a6797>set</font></b> lev [<b><font color=#3a6797>expr</font></b> {min(<font color=#1b1baa>$lev</font>,[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$parents</font>])}]
    <b><font color=#3a6797>set</font></b> parent [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$parents</font> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$lev</font>-1}]]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$leaf</font>} {
      <b><font color=#3a6797>set</font></b> title <font color=#8b2a0e>&quot; <font color=#1b1baa>$</font>title&quot;</font>
      <b><font color=#3a6797>set</font></b> pr [<b><font color=#3a6797>expr</font></b> {max(0,min(7,(<font color=#1b1baa>$l2</font>-<font color=#1b1baa>$l1</font>-<font color=#1b1baa>$::alited::al(minredunit)</font>)/<font color=#1b1baa>$al(prjredunit)</font>))}]
      <b><font color=#3a6797>set</font></b> imgopt <font color=#8b2a0e>&quot;-image alimg_pro<font color=#1b1baa>$</font>pr&quot;</font>
      <b><font color=#3a6797>set</font></b> isopen no
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> imgopt <font color=#8b2a0e>&quot;-image alimg_gulls&quot;</font>
      <b><font color=#3a6797>set</font></b> levtmp [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$al(_unittree,$TID)</font> <font color=#1b1baa>$iiuni</font> 0]
      <b><font color=#3a6797>set</font></b> isopen [<b><font color=#3a6797>expr</font></b> (<font color=#1b1baa>$levtmp</font>+0)&gt;<font color=#1b1baa>$lev</font>]
    }
    <font color=#1b1baa>$wtree</font> insert <font color=#1b1baa>$parent</font> end <font color=#653760>-id</font> <font color=#1b1baa>$itemID</font> <font color=#653760>-text</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>title&quot;</font> \
      <font color=#653760>-values</font> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$l1</font> <font color=#1b1baa>$l2</font> {} <font color=#1b1baa>$itemID</font> <font color=#1b1baa>$lev</font> <font color=#1b1baa>$leaf</font> <font color=#1b1baa>$fl1</font>] <font color=#653760>-open</font> <font color=#1b1baa>$isopen</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$imgopt</font>
    <font color=#1b1baa>$wtree</font> tag add tagNorm <font color=#1b1baa>$itemID</font>
    <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$leaf</font>} {
      <b><font color=#3a6797>set</font></b> parent <font color=#1b1baa>$itemID</font>
      <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> parents [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$parents</font> <font color=#1b1baa>$lev</font> end <font color=#1b1baa>$parent</font>]}
    }
    <b><font color=#3a6797>set</font></b> levprev <font color=#1b1baa>$lev</font>
  }
  alited::tree::ColorUnitsTree <font color=#1b1baa>$TID</font> <font color=#1b1baa>$wtxt</font> <font color=#1b1baa>$wtree</font> -1  ;<i><font color=#4b5d50># color without todos, then with</font></i>
  <b><font color=#3a6797>after</font></b> idle [<b><font color=#3a6797>list</font></b> after 10 [<b><font color=#3a6797>list</font></b> alited::tree::ColorUnitsTree <font color=#1b1baa>$TID</font> <font color=#1b1baa>$wtxt</font> <font color=#1b1baa>$wtree</font> 50]]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::ColorUnitsTree></a>
<b><font color=#ca14ca>proc</font></b> tree::ColorUnitsTree {TID wtxt wtree wait} {
  <i><font color=#4b5d50># Color units of the tree.</font></i>
  <i><font color=#4b5d50>#   TID - a current tab's ID</font></i>
  <i><font color=#4b5d50>#   wtxt - text's path</font></i>
  <i><font color=#4b5d50>#   wtree - tree's path</font></i>
  <i><font color=#4b5d50>#   wait - waiting mode: -1 no wait, &gt;0 wait for highlighting done, 0 waiting done</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$TID</font> ne [alited::bar::CurrentTabID]} <b><font color=#ca14ca>return</font></b>
  <i><font color=#4b5d50># colorizing should wait for the highlighting done</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wait</font>&gt;0} {
    <b><font color=#3a6797>if</font></b> {[alited::file::IsClang [alited::bar::FileName <font color=#1b1baa>$TID</font>]]} {
      <b><font color=#3a6797>set</font></b> dowait [<b><font color=#3a6797>expr</font></b> {![::hl_c::isdone <font color=#1b1baa>$wtxt</font>]}]
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> dowait [<b><font color=#3a6797>expr</font></b> {![::hl_tcl::isdone <font color=#1b1baa>$wtxt</font>]}]
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dowait</font>} {
      <b><font color=#3a6797>incr</font></b> wait -1
      <b><font color=#3a6797>after</font></b> 100 [<b><font color=#3a6797>list</font></b> alited::tree::ColorUnitsTree <font color=#1b1baa>$TID</font> <font color=#1b1baa>$wtxt</font> <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$wait</font>]
      <b><font color=#ca14ca>return</font></b>
    }
  }
  <b><font color=#3a6797>set</font></b> ctab [alited::bar::CurrentTabID]
  <b><font color=#3a6797>set</font></b> todolist [<b><font color=#3a6797>list</font></b>]
  <b><font color=#3a6797>foreach</font></b> {tr1 tr2} [<font color=#1b1baa>$wtxt</font> tag ranges tagCMN2] {
    <b><font color=#3a6797>lappend</font></b> todolist [<b><font color=#3a6797>expr</font></b> {int(<font color=#1b1baa>$tr1</font>)}]
  }
  <font color=#1b1baa>$wtree</font> tag remove tagTODO
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wait</font>==-1} {
    <font color=#1b1baa>$wtree</font> tag remove tagBranch
    <font color=#1b1baa>$wtree</font> tag remove tagSel
  }
  <b><font color=#3a6797>foreach</font></b> item <font color=#1b1baa>$al(_unittree,$TID)</font> {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$item</font>]&lt;3} <b><font color=#ca14ca>continue</font></b>
    <b><font color=#3a6797>set</font></b> itemID  [alited::tree::NewItemID [<b><font color=#3a6797>incr</font></b> iit]]
    <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$item</font> lev leaf fl1 title l1 l2
    <b><font color=#3a6797>set</font></b> tag tagNorm
    <b><font color=#3a6797>foreach</font></b> tr <font color=#1b1baa>$todolist</font> {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$tr</font>&gt;=<font color=#1b1baa>$l1</font> && <font color=#1b1baa>$tr</font>&lt;=<font color=#1b1baa>$l2</font>} {
        <b><font color=#3a6797>set</font></b> tag tagTODO
        <b><font color=#ca14ca>break</font></b>
      }
    }
    <b><font color=#3a6797>catch</font></b> {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$leaf</font> && \
      [<b><font color=#3a6797>info</font></b> exists al(CPOS,<font color=#1b1baa>$ctab</font>,[alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$itemID</font>])]} {
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$tag</font> ne {tagTODO}} {<b><font color=#3a6797>set</font></b> tag tagSel}
      }
    }
    <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$leaf</font>} {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$tag</font> ne {tagTODO}} {<b><font color=#3a6797>set</font></b> tag tagBranch}
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$tag</font> ne {tagNorm} && (<font color=#1b1baa>$wait</font>==-1 && <font color=#1b1baa>$tag</font> ne {tagTODO} || <font color=#1b1baa>$tag</font> eq {tagTODO})} {
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<font color=#1b1baa>$wtree</font> tag add <font color=#1b1baa>$tag</font> <font color=#1b1baa>$itemID</font>}]} <b><font color=#ca14ca>break</font></b>
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::CreateFilesTree></a>
<b><font color=#ca14ca>proc</font></b> tree::CreateFilesTree {wtree} {
  <i><font color=#4b5d50># Creates a file tree.</font></i>
  <i><font color=#4b5d50>#   wtree - the tree's path</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> al(TREE,files) yes
  [<font color=#1b1baa>$obPav</font> BtTswitch] configure <font color=#653760>-image</font> alimg_gulls
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTswitch] <font color=#1b1baa>$al(MC,swfiles)</font>
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTAddT] <font color=#1b1baa>$al(MC,filesadd)</font>\nInsert
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTDelT] <font color=#1b1baa>$al(MC,filesdel)</font>\nDelete
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTUp] <font color=#1b1baa>$al(MC,moveupF)</font>
  baltip::tip [<font color=#1b1baa>$obPav</font> BtTDown] <font color=#1b1baa>$al(MC,movedownF)</font>
  <font color=#1b1baa>$wtree</font> heading #0 <font color=#653760>-text</font> <font color=#8b2a0e>&quot;:: <font color=#1b1baa>$</font>al(prjname) ::&quot;</font>
  <font color=#1b1baa>$wtree</font> heading #1 <font color=#653760>-text</font> <font color=#1b1baa>$al(MC,files)</font>
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wtree</font> &lt;Return&gt; {::alited::tree::OpenFile}
  <b><font color=#3a6797>set</font></b> selID <font color=#8b2a0e>&quot;&quot;</font>
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> selfile [alited::bar::FileName]}]} {
    <b><font color=#3a6797>set</font></b> selfile {} ;<i><font color=#4b5d50># at closing by Ctrl+W with file tree open: no current file</font></i>
  }
  <b><font color=#3a6797>set</font></b> filesTIDs [alited::bar::FilesTIDs]
  PrepareDirectoryContents
  <b><font color=#3a6797>foreach</font></b> item [GetDirectoryContents <font color=#1b1baa>$al(prjroot)</font>] {
    <b><font color=#3a6797>set</font></b> itemID  [alited::tree::NewItemID [<b><font color=#3a6797>incr</font></b> iit]]
    <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$item</font> lev isfile fname fcount iroot
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$selfile</font> eq <font color=#1b1baa>$fname</font>} {<b><font color=#3a6797>set</font></b> selID <font color=#1b1baa>$itemID</font>}
    <b><font color=#3a6797>set</font></b> title [<b><font color=#3a6797>file</font></b> tail <font color=#1b1baa>$fname</font>]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$iroot</font>&lt;0} {
      <b><font color=#3a6797>set</font></b> parent {}
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> parent [alited::tree::NewItemID [<b><font color=#3a6797>incr</font></b> iroot]]
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$isfile</font>} {
      <b><font color=#3a6797>if</font></b> {[alited::file::IsTcl <font color=#1b1baa>$fname</font>]} {
        <b><font color=#3a6797>set</font></b> imgopt {<font color=#653760>-image</font> alimg_tclfile}
      } <b><font color=#3a6797>else</font></b> {
        <b><font color=#3a6797>set</font></b> imgopt {<font color=#653760>-image</font> alimg_file}
      }
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> imgopt {<font color=#653760>-image</font> alimg_folder}
      <i><font color=#4b5d50># get the directory's flag of expanded branch (in the file tree)</font></i>
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$fcount</font>} {<b><font color=#3a6797>set</font></b> fc <font color=#1b1baa>$fcount</font>} {<b><font color=#3a6797>set</font></b> fc {}}
    <font color=#1b1baa>$wtree</font> insert <font color=#1b1baa>$parent</font> end <font color=#653760>-id</font> <font color=#1b1baa>$itemID</font> <font color=#653760>-text</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>title&quot;</font> \
      <font color=#653760>-values</font> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$fc</font> <font color=#1b1baa>$fname</font> <font color=#1b1baa>$isfile</font> <font color=#1b1baa>$itemID</font>] <font color=#653760>-open</font> no {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$imgopt</font>
    <font color=#1b1baa>$wtree</font> tag add tagNorm <font color=#1b1baa>$itemID</font>
    <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$isfile</font>} {
      <font color=#1b1baa>$wtree</font> tag add tagBranch <font color=#1b1baa>$itemID</font>
    } <b><font color=#3a6797>elseif</font></b> {[alited::bar::FileTID <font color=#1b1baa>$fname</font> <font color=#1b1baa>$filesTIDs</font>] ne {}} {
      <font color=#1b1baa>$wtree</font> tag add tagSel <font color=#1b1baa>$itemID</font>
    }
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$selID</font> ne {}} {
    <font color=#1b1baa>$wtree</font> see <font color=#1b1baa>$selID</font>
    <font color=#1b1baa>$wtree</font> selection set <font color=#1b1baa>$selID</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::NewItemID></a>
<b><font color=#ca14ca>proc</font></b> tree::NewItemID {iit} {
  <i><font color=#4b5d50># Gets a new ID for the tree item.</font></i>
  <i><font color=#4b5d50>#   iit - index of the new item.</font></i>

  <b><font color=#ca14ca>return</font></b> <font color=#8b2a0e>&quot;al<font color=#1b1baa>$</font>iit&quot;</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::AddTags></a>
<b><font color=#ca14ca>proc</font></b> tree::AddTags {wtree} {
  <i><font color=#4b5d50># Creates tags for the tree.</font></i>
  <i><font color=#4b5d50>#   wtree - the tree's path</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>lassign</font></b> [alited::FgAdditional] fgbr fgred fgtodo
  <b><font color=#3a6797>append</font></b> fontN <font color=#8b2a0e>&quot;-font <font color=#1b1baa>$</font>::alited::al(FONT,defsmall)&quot;</font>
  <b><font color=#3a6797>append</font></b> fontS <font color=#1b1baa>$fontN</font> <font color=#8b2a0e>&quot; -foreground <font color=#1b1baa>$</font>fgred&quot;</font>
  <font color=#1b1baa>$wtree</font> tag configure tagNorm {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$fontN</font>
  <font color=#1b1baa>$wtree</font> tag configure tagSel  {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$fontS</font>
  <font color=#1b1baa>$wtree</font> tag configure tagBold <font color=#653760>-foreground</font> magenta
  <font color=#1b1baa>$wtree</font> tag configure tagTODO <font color=#653760>-foreground</font> <font color=#1b1baa>$fgtodo</font>
  <font color=#1b1baa>$wtree</font> tag configure tagBranch <font color=#653760>-foreground</font> <font color=#1b1baa>$fgbr</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::AddItem></a>
<b><font color=#ca14ca>proc</font></b> tree::AddItem {{ID <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Adds a new item to the tree.</font></i>
  <i><font color=#4b5d50>#   ID - an item's ID where the new item will be added (for the file tree).</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    alited::unit::Add
  } <b><font color=#3a6797>else</font></b> {
    alited::file::Add <font color=#1b1baa>$ID</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::DelItem></a>
<b><font color=#ca14ca>proc</font></b> tree::DelItem {{ID <font color=#8b2a0e>&quot;&quot;</font>} {sy 10}} {
  <i><font color=#4b5d50># Removes an item from the tree.</font></i>
  <i><font color=#4b5d50>#   ID - an item's ID to be deleted.</font></i>
  <i><font color=#4b5d50>#   sy - relative Y-coordinate for a query</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ID</font> eq {} && [<b><font color=#3a6797>set</font></b> ID [alited::tree::CurrentItem]] eq {}} {
    <b><font color=#134070>bell</font></b>
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>set</font></b> fname [alited::bar::FileName]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    alited::unit::Delete <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$fname</font> <font color=#1b1baa>$sy</font>
  } <b><font color=#3a6797>else</font></b> {
    alited::file::Delete <font color=#1b1baa>$ID</font> <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$sy</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::Delete></a>
<b><font color=#ca14ca>proc</font></b> tree::Delete {wtree item TID} {
  <i><font color=#4b5d50># Removes recursively an item and its children from the tree.</font></i>
  <i><font color=#4b5d50>#   wtree - the tree widget's path</font></i>
  <i><font color=#4b5d50>#   item - ID of the item to be deleted.</font></i>

  <b><font color=#3a6797>foreach</font></b> child [<font color=#1b1baa>$wtree</font> children <font color=#1b1baa>$item</font>] {
    alited::tree::Delete <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$child</font> <font color=#1b1baa>$TID</font>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$item</font> ne {}} {<font color=#1b1baa>$wtree</font> delete <font color=#1b1baa>$item</font>}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::AdjustWidth></a>
<b><font color=#ca14ca>proc</font></b> tree::AdjustWidth {} {
  <i><font color=#4b5d50># Fixes a problem with the tree scrollbar's width at resizing the panes.</font></i>
  <i><font color=#4b5d50># The problem occurs if Frame's width is less than Tree's + Scrollbar's, as</font></i>
  <i><font color=#4b5d50># then the scrollbar is squeezed. Thus the Tree's width should be adjusted.</font></i>
  <i><font color=#4b5d50># The restart of alited will fully repair this.</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> wpf [<b><font color=#134070>winfo</font></b> width [<font color=#1b1baa>$obPav</font> FraTree]]
  <b><font color=#3a6797>set</font></b> ws1 [<b><font color=#134070>winfo</font></b> width [<font color=#1b1baa>$obPav</font> SbvTree]]
  <b><font color=#3a6797>set</font></b> ws2 [<b><font color=#134070>winfo</font></b> width [<font color=#1b1baa>$obPav</font> SbvFavor]]
  <b><font color=#3a6797>set</font></b> w2 [[<font color=#1b1baa>$obPav</font> Tree] column #1 <font color=#653760>-width</font>]
  [<font color=#1b1baa>$obPav</font> Tree] column #0 <font color=#653760>-width</font> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$wpf</font>-<font color=#1b1baa>$w2</font>-<font color=#1b1baa>$ws2</font>-4}]
}
<a id=Buttons_handlers></a>
<i><font color=#4b5d50># ________________________ Buttons handlers _________________________ #</font></i>
<a id=tree::ShowPopupMenu></a>
<b><font color=#ca14ca>proc</font></b> tree::ShowPopupMenu {ID X Y} {
  <i><font color=#4b5d50># Creates and opens a popup menu at right clicking the tree.</font></i>
  <i><font color=#4b5d50>#   ID - ID of clicked item</font></i>
  <i><font color=#4b5d50>#   X - x-coordinate of the click</font></i>
  <i><font color=#4b5d50>#   Y - y-coordinate of the click</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  ::baltip sleep 1000
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>set</font></b> popm <font color=#1b1baa>$wtree</font>.popup
  <b><font color=#3a6797>catch</font></b> {<b><font color=#134070>destroy</font></b> <font color=#1b1baa>$popm</font>}
  <b><font color=#134070>menu</font></b> <font color=#1b1baa>$popm</font> <font color=#653760>-tearoff</font> 0
  <b><font color=#3a6797>set</font></b> header [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>split</font></b> [alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$ID</font>] \n] 0]
  <b><font color=#3a6797>set</font></b> sname [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-text</font>]
  <b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-values</font>] -&gt; fname isfile - - isunit
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <b><font color=#3a6797>set</font></b> img alimg_folder
    <b><font color=#3a6797>set</font></b> m1 <font color=#1b1baa>$al(MC,swunits)</font>
    <b><font color=#3a6797>set</font></b> m2 <font color=#1b1baa>$al(MC,tpl)</font>
    <b><font color=#3a6797>set</font></b> m3 <font color=#1b1baa>$al(MC,unitsdel)</font>
    <b><font color=#3a6797>set</font></b> moveup <font color=#1b1baa>$al(MC,moveupU)</font>
    <b><font color=#3a6797>set</font></b> movedown <font color=#1b1baa>$al(MC,movedownU)</font>
    <b><font color=#3a6797>set</font></b> dropitem [msgcat::mc {Drop Selected Units Here}]
    <b><font color=#3a6797>set</font></b> accins {}
    <b><font color=#3a6797>set</font></b> accdel {}
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> img alimg_gulls
    <b><font color=#3a6797>set</font></b> m1 <font color=#1b1baa>$al(MC,swfiles)</font>
    <b><font color=#3a6797>set</font></b> m2 <font color=#1b1baa>$al(MC,filesadd...)</font>
    <b><font color=#3a6797>set</font></b> m3 <font color=#1b1baa>$al(MC,filesdel)</font>
    <b><font color=#3a6797>set</font></b> moveup <font color=#1b1baa>$al(MC,moveupF)</font>
    <b><font color=#3a6797>set</font></b> movedown <font color=#1b1baa>$al(MC,movedownF)</font>
    <b><font color=#3a6797>set</font></b> dropitem [msgcat::mc {Drop Selected Files Here}]
    <b><font color=#3a6797>set</font></b> accins {<font color=#653760>-accelerator</font> Insert}
    <b><font color=#3a6797>set</font></b> accdel {<font color=#653760>-accelerator</font> Delete}
  }
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$sname</font>]&gt;25} {<b><font color=#3a6797>set</font></b> sname <font color=#8b2a0e>&quot;<font color=#1b1baa>[</font>string range <font color=#1b1baa>$</font>sname 0 21<font color=#1b1baa>]</font>...&quot;</font>}
  <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$m1</font> \
    <font color=#653760>-command</font> ::alited::tree::SwitchTree <font color=#653760>-image</font> <font color=#1b1baa>$img</font>
  <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,updtree)</font> \
    <font color=#653760>-command</font> alited::tree::RecreateTree <font color=#653760>-image</font> alimg_retry
  <font color=#1b1baa>$popm</font> add separator
  <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$moveup</font> \
    <font color=#653760>-command</font> {::alited::tree::MoveItem up} <font color=#653760>-image</font> alimg_up
  <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$movedown</font> \
    <font color=#653760>-command</font> {::alited::tree::MoveItem down} <font color=#653760>-image</font> alimg_down
  <font color=#1b1baa>$popm</font> add separator
  <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$m2</font> \
    <font color=#653760>-command</font> <font color=#8b2a0e>&quot;::alited::tree::AddItem <font color=#1b1baa>$</font>ID&quot;</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$accins</font> <font color=#653760>-image</font> alimg_add
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA change] \
      <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,renamefile...)</font> <font color=#653760>-accelerator</font> F2 \
      <font color=#653760>-command</font> {::alited::file::RenameFileInTree no}
  }
  <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$m3</font> \
    <font color=#653760>-command</font> <font color=#8b2a0e>&quot;::alited::tree::DelItem <font color=#1b1baa>$</font>ID -100&quot;</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$accdel</font> <font color=#653760>-image</font> alimg_delete
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(FAV,IsFavor)</font>} {
      <font color=#1b1baa>$popm</font> add separator
      <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA heart] <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,favoradd)</font> \
        <font color=#653760>-command</font> ::alited::favor::AddFromTree
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$isunit</font>} {
      <font color=#1b1baa>$popm</font> add separator
      <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,copydecl)</font> \
        <font color=#653760>-command</font> <font color=#8b2a0e>&quot;clipboard clear ; clipboard append <font color=#1b1baa>{$</font>header<font color=#1b1baa>}</font>&quot;</font>
    }
  } <b><font color=#3a6797>else</font></b> {
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA copy] \
      <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,clonefile...)</font> <font color=#653760>-command</font> ::alited::file::CloneFile
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA OpenFile] <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,openwith)</font> \
      <font color=#653760>-command</font> ::alited::file::OpenWith
    <font color=#1b1baa>$popm</font> add separator
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$isfile</font>} {<b><font color=#3a6797>set</font></b> fname [<b><font color=#3a6797>file</font></b> dirname <font color=#1b1baa>$fname</font>]}
    <b><font color=#3a6797>set</font></b> sname [<b><font color=#3a6797>file</font></b> tail <font color=#1b1baa>$fname</font>]
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,openselfile)</font> <font color=#653760>-command</font> ::alited::file::OpenFiles
    <b><font color=#3a6797>set</font></b> msg [<b><font color=#3a6797>string</font></b> map [<b><font color=#3a6797>list</font></b> %n <font color=#1b1baa>$sname</font>] <font color=#1b1baa>$al(MC,openofdir)</font>]
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$msg</font> \
      <font color=#653760>-command</font> <font color=#8b2a0e>&quot;::alited::file::OpenOfDir <font color=#1b1baa>{$</font>fname<font color=#1b1baa>}</font>&quot;</font>
    <font color=#1b1baa>$popm</font> add separator
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$al(MC,detachsel)</font> \
      <font color=#653760>-command</font> ::alited::file::DetachFromTree
  }
  <b><font color=#3a6797>set</font></b> addsel {}
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> [<font color=#1b1baa>$wtree</font> selection]]&gt;1} {
    <font color=#1b1baa>$popm</font> add separator
    <font color=#1b1baa>$popm</font> add command {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$obPav</font> iconA none] <font color=#653760>-label</font> <font color=#1b1baa>$dropitem</font> \
      <font color=#653760>-command</font> <font color=#8b2a0e>&quot;::alited::tree::DropItems <font color=#1b1baa>$</font>ID&quot;</font> <font color=#653760>-image</font> alimg_paste
    <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$wtree</font> tag has tagSel <font color=#1b1baa>$ID</font>]} {
      <i><font color=#4b5d50># the added tagSel tag should be overrided</font></i>
      <font color=#1b1baa>$wtree</font> tag remove tagSel <font color=#1b1baa>$ID</font>
      <b><font color=#3a6797>set</font></b> addsel <font color=#8b2a0e>&quot;; <font color=#1b1baa>$</font>wtree tag add tagSel <font color=#1b1baa>$</font>ID&quot;</font>
    }
  }
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$popm</font> &lt;FocusIn&gt; <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>wtree tag add tagBold <font color=#1b1baa>$</font>ID&quot;</font>
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$popm</font> &lt;FocusOut&gt; <font color=#8b2a0e>&quot;catch <font color=#1b1baa>{$</font>wtree tag remove tagBold <font color=#1b1baa>$</font>ID; <font color=#1b1baa>$</font>addsel<font color=#1b1baa>}</font>&quot;</font>
  <font color=#1b1baa>$obPav</font> themePopup <font color=#1b1baa>$popm</font>
  <b><font color=#134070>tk_popup</font></b> <font color=#1b1baa>$popm</font> <font color=#1b1baa>$X</font> <font color=#1b1baa>$Y</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::ButtonPress></a>
<b><font color=#ca14ca>proc</font></b> tree::ButtonPress {but x y X Y} {
  <i><font color=#4b5d50># Handles a mouse clicking the tree.</font></i>
  <i><font color=#4b5d50>#   but - mouse button</font></i>
  <i><font color=#4b5d50>#   x - x-coordinate to identify an item</font></i>
  <i><font color=#4b5d50>#   y - y-coordinate to identify an item</font></i>
  <i><font color=#4b5d50>#   X - x-coordinate of the click</font></i>
  <i><font color=#4b5d50>#   Y - x-coordinate of the click</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>set</font></b> ID [<font color=#1b1baa>$wtree</font> identify item <font color=#1b1baa>$x</font> <font color=#1b1baa>$y</font>]
  <b><font color=#3a6797>set</font></b> region [<font color=#1b1baa>$wtree</font> identify region <font color=#1b1baa>$x</font> <font color=#1b1baa>$y</font>]
  <b><font color=#3a6797>set</font></b> al(movID) [<b><font color=#3a6797>set</font></b> al(movWin) {}]
  <b><font color=#3a6797>if</font></b> {![<font color=#1b1baa>$wtree</font> exists <font color=#1b1baa>$ID</font>] || <font color=#1b1baa>$region</font> ni {tree cell}} {
    <b><font color=#ca14ca>return</font></b>  ;<i><font color=#4b5d50># only tree items are processed</font></i>
  }
  <b><font color=#3a6797>switch</font></b> <font color=#1b1baa>$but</font> {
    {3} {
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> [<font color=#1b1baa>$wtree</font> selection]]&lt;2} {
        <font color=#1b1baa>$wtree</font> selection set <font color=#1b1baa>$ID</font>
      }
      ShowPopupMenu <font color=#1b1baa>$ID</font> <font color=#1b1baa>$X</font> <font color=#1b1baa>$Y</font>
    }
    {1} {
      <b><font color=#3a6797>set</font></b> al(movID) <font color=#1b1baa>$ID</font>
      <b><font color=#3a6797>set</font></b> al(movWin) .tritem_move
      <b><font color=#3a6797>set</font></b> msec [<b><font color=#3a6797>clock</font></b> milliseconds]
      <b><font color=#3a6797>set</font></b> doubleclick [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>info</font></b> exists al(_MSEC)] && [<b><font color=#3a6797>expr</font></b> {(<font color=#1b1baa>$msec</font>-<font color=#1b1baa>$al(_MSEC)</font>)&lt;400}]}]
      <b><font color=#3a6797>set</font></b> al(_MSEC) <font color=#1b1baa>$msec</font>
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$doubleclick</font>} {     ;<i><font color=#4b5d50># at double click:</font></i>
        DestroyMoveWindow yes ;<i><font color=#4b5d50># disable any drag-drop</font></i>
      }
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
        NewSelection <font color=#1b1baa>$ID</font>
        alited::main::SaveVisitInfo
      } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$doubleclick</font>} {
        OpenFile <font color=#1b1baa>$ID</font>
      }
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::DropItems></a>
<b><font color=#ca14ca>proc</font></b> tree::DropItems {ID} {
  <i><font color=#4b5d50># Drops (moves) selected items to a current position.</font></i>
  <i><font color=#4b5d50>#   ID - ID of an item to be clicked</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>set</font></b> selection [<font color=#1b1baa>$wtree</font> selection]
  <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$wtree</font> exists <font color=#1b1baa>$ID</font>] && <font color=#1b1baa>$selection</font> ne {} && <font color=#1b1baa>$ID</font> ne {} && <font color=#1b1baa>$selection</font> ne <font color=#1b1baa>$ID</font>} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
      alited::unit::MoveUnits <font color=#1b1baa>$wtree</font> move <font color=#1b1baa>$selection</font> <font color=#1b1baa>$ID</font>
    } <b><font color=#3a6797>else</font></b> {
      alited::file::MoveFiles <font color=#1b1baa>$wtree</font> move <font color=#1b1baa>$selection</font> <font color=#1b1baa>$ID</font>
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::SelectUnits></a>
<b><font color=#ca14ca>proc</font></b> tree::SelectUnits {wtree ctrl} {
  <i><font color=#4b5d50># Selects units at Ctrl/Shift clicking the unit tree.</font></i>
  <i><font color=#4b5d50>#   wtree - path to tree widget</font></i>
  <i><font color=#4b5d50>#   ctrl - 1 if pressed Ctrl/Shift key at clicking</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$ctrl</font> || !<font color=#1b1baa>$al(TREE,isunits)</font>} <b><font color=#ca14ca>return</font></b>
  <b><font color=#3a6797>set</font></b> wtxt [alited::main::CurrentWTXT]
  <font color=#1b1baa>$wtxt</font> tag remove sel 1.0 end
  <b><font color=#3a6797>foreach</font></b> ID [<font color=#1b1baa>$wtree</font> selection] {
    <b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-values</font>] l1 l2
    <font color=#1b1baa>$wtxt</font> tag add sel <font color=#1b1baa>$l1</font>.0 [<b><font color=#3a6797>incr</font></b> l2].0
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::ButtonRelease></a>
<b><font color=#ca14ca>proc</font></b> tree::ButtonRelease {but s x y X Y} {
  <i><font color=#4b5d50># Handles a mouse button releasing on the tree, at moving an item.</font></i>
  <i><font color=#4b5d50>#   but - mouse button</font></i>
  <i><font color=#4b5d50>#   s - state (ctrl/alt/shift)</font></i>
  <i><font color=#4b5d50>#   x - x-coordinate to identify an item</font></i>
  <i><font color=#4b5d50>#   y - y-coordinate to identify an item</font></i>
  <i><font color=#4b5d50>#   X - x-coordinate of the click</font></i>
  <i><font color=#4b5d50>#   Y - x-coordinate of the click</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>set</font></b> ID [<font color=#1b1baa>$wtree</font> identify item <font color=#1b1baa>$x</font> <font color=#1b1baa>$y</font>]
  DestroyMoveWindow no
  <b><font color=#3a6797>set</font></b> msec [<b><font color=#3a6797>clock</font></b> milliseconds]
  <b><font color=#3a6797>set</font></b> ctrl [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$s</font> & 0b100}]
  <b><font color=#3a6797>if</font></b> {([<b><font color=#3a6797>info</font></b> exists al(_MSEC)] && [<b><font color=#3a6797>expr</font></b> {(<font color=#1b1baa>$msec</font>-<font color=#1b1baa>$al(_MSEC)</font>)&lt;400}]) || <font color=#1b1baa>$ctrl</font>} {
    SelectUnits <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$ctrl</font>
    <b><font color=#3a6797>set</font></b> al(movWin) {}
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$wtree</font> exists <font color=#1b1baa>$ID</font>] && [<b><font color=#3a6797>info</font></b> exists al(movID)] && \
  <font color=#1b1baa>$al(movID)</font> ne {} && <font color=#1b1baa>$ID</font> ne {} && <font color=#1b1baa>$al(movID)</font> ne <font color=#1b1baa>$ID</font> && \
  [<font color=#1b1baa>$wtree</font> identify region <font color=#1b1baa>$x</font> <font color=#1b1baa>$y</font>] eq {tree}} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
      alited::unit::MoveUnits <font color=#1b1baa>$wtree</font> move <font color=#1b1baa>$al(movID)</font> <font color=#1b1baa>$ID</font>
    } <b><font color=#3a6797>else</font></b> {
      alited::file::MoveFiles <font color=#1b1baa>$wtree</font> move <font color=#1b1baa>$al(movID)</font> <font color=#1b1baa>$ID</font>
    }
  }
  DestroyMoveWindow yes
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::ButtonMotion></a>
<b><font color=#ca14ca>proc</font></b> tree::ButtonMotion {but s x y X Y} {
  <i><font color=#4b5d50># Starts moving an item of the tree.</font></i>
  <i><font color=#4b5d50>#   but - mouse button</font></i>
  <i><font color=#4b5d50>#   s - state (ctrl/alt/shift)</font></i>
  <i><font color=#4b5d50>#   x - x-coordinate to identify an item</font></i>
  <i><font color=#4b5d50>#   y - y-coordinate to identify an item</font></i>
  <i><font color=#4b5d50>#   X - x-coordinate of the click</font></i>
  <i><font color=#4b5d50>#   Y - x-coordinate of the click</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists al(movWin)] || <font color=#1b1baa>$al(movWin)</font> eq {}} {
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$s</font> & 0b111} {
    <b><font color=#3a6797>set</font></b> al(movWin) {}
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <i><font color=#4b5d50># dragging the tab</font></i>
  <b><font color=#3a6797>if</font></b> {![<b><font color=#134070>winfo</font></b> exists <font color=#1b1baa>$al(movWin)</font>]} {
    <i><font color=#4b5d50># make the tab's replica to be dragged</font></i>
    <b><font color=#134070>toplevel</font></b> <font color=#1b1baa>$al(movWin)</font>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(IsWindows)</font>} {
      <b><font color=#134070>wm</font></b> attributes <font color=#1b1baa>$al(movWin)</font> <font color=#653760>-alpha</font> 0.0
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#134070>wm</font></b> withdraw <font color=#1b1baa>$al(movWin)</font>
    }
    <b><font color=#3a6797>if</font></b> {[<b><font color=#134070>tk</font></b> windowingsystem] eq {aqua}} {
      ::tk::unsupported::MacWindowStyle style <font color=#1b1baa>$al(movWin)</font> help none
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#134070>wm</font></b> overrideredirect <font color=#1b1baa>$al(movWin)</font> 1
    }
    <b><font color=#3a6797>set</font></b> selection [<font color=#1b1baa>$wtree</font> selection]
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> il [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$selection</font>]]&gt;1} {
      <b><font color=#3a6797>set</font></b> al(movID) <font color=#1b1baa>$selection</font>
      <b><font color=#3a6797>set</font></b> text <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>il items&quot;</font>
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> text [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$al(movID)</font> <font color=#653760>-text</font>]
    }
    <b><font color=#134070>label</font></b> <font color=#1b1baa>$al(movWin)</font>.label <font color=#653760>-text</font> <font color=#1b1baa>$text</font> <font color=#653760>-relief</font> solid \
      <font color=#653760>-foreground</font> <font color=#1b1baa>$al(MOVEFG)</font> <font color=#653760>-background</font> <font color=#1b1baa>$al(MOVEBG)</font>
    <b><font color=#134070>pack</font></b> <font color=#1b1baa>$al(movWin)</font>.label <font color=#653760>-expand</font> 1 <font color=#653760>-fill</font> both <font color=#653760>-ipadx</font> 1
  }
  <b><font color=#3a6797>set</font></b> ID [<font color=#1b1baa>$wtree</font> identify item <font color=#1b1baa>$x</font> <font color=#1b1baa>$y</font>]
  <b><font color=#134070>wm</font></b> geometry <font color=#1b1baa>$al(movWin)</font> +[<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$X</font>+10}]+[<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$Y</font>+10}]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(IsWindows)</font>} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#134070>wm</font></b> attributes <font color=#1b1baa>$al(movWin)</font> <font color=#653760>-alpha</font>] &lt; 0.1} {<b><font color=#134070>wm</font></b> attributes <font color=#1b1baa>$al(movWin)</font> <font color=#653760>-alpha</font> 1.0}
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>catch</font></b> {<b><font color=#134070>wm</font></b> deiconify <font color=#1b1baa>$al(movWin)</font> ; <b><font color=#134070>raise</font></b> <font color=#1b1baa>$al(movWin)</font>}
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::DestroyMoveWindow></a>
<b><font color=#ca14ca>proc</font></b> tree::DestroyMoveWindow {cancel} {
  <i><font color=#4b5d50># Destroys an item moving window.</font></i>
  <i><font color=#4b5d50>#   cancel - if yes, clears also the related variables.</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>catch</font></b> {<b><font color=#134070>destroy</font></b> <font color=#1b1baa>$al(movWin)</font>}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$cancel</font>} {<b><font color=#3a6797>lassign</font></b> {} al(movWin) al(movID)}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::UnitTooltip></a>
<b><font color=#ca14ca>proc</font></b> tree::UnitTooltip {wtxt l1 l2} {
  <i><font color=#4b5d50># Gets unit's tooltip.</font></i>
  <i><font color=#4b5d50>#   wtxt - text's path</font></i>
  <i><font color=#4b5d50>#   l1 - 1st line's number</font></i>
  <i><font color=#4b5d50>#   l2 - last line's number</font></i>

  <b><font color=#3a6797>set</font></b> tip {}
  <b><font color=#3a6797>foreach</font></b> {p1 p2} [<font color=#1b1baa>$wtxt</font> tag ranges tagCMN2] {
    <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$wtxt</font> compare <font color=#1b1baa>$l1</font>.0 &lt;= <font color=#1b1baa>$p1</font>] && [<font color=#1b1baa>$wtxt</font> compare <font color=#1b1baa>$p2</font> &lt;= <font color=#1b1baa>$l2</font>.end]} {
      <b><font color=#3a6797>set</font></b> todo [<b><font color=#3a6797>string</font></b> trimleft [<font color=#1b1baa>$wtxt</font> get <font color=#1b1baa>$p1</font> <font color=#1b1baa>$p2</font>] #!]
      <b><font color=#3a6797>switch</font></b> [<b><font color=#3a6797>incr</font></b> tiplines] {
        1  {<b><font color=#3a6797>append</font></b> tip \n_______________________\n}
        13 {<b><font color=#ca14ca>break</font></b>}
      }
      <b><font color=#3a6797>append</font></b> tip \n <font color=#1b1baa>$todo</font>
    }
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$tip</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::GetTooltip></a>
<b><font color=#ca14ca>proc</font></b> tree::GetTooltip {ID NC} {
  <i><font color=#4b5d50># Gets a tip for unit / file tree's item.</font></i>
  <i><font color=#4b5d50>#   ID - ID of treeview item</font></i>
  <i><font color=#4b5d50>#   NC - column of treeview item</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists al(movWin)] && <font color=#1b1baa>$al(movWin)</font> ne {} || ![::alited::IsTipable]} {
    <b><font color=#ca14ca>return</font></b> {}  ;<i><font color=#4b5d50># no tips while drag-n-dropping or focusing somewhere else</font></i>
  }
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <i><font color=#4b5d50># for units</font></i>
    <b><font color=#3a6797>set</font></b> tip [alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$ID</font> <font color=#1b1baa>$NC</font>]
    <i><font color=#4b5d50># try to read and add TODOs for this unit</font></i>
    <b><font color=#3a6797>catch</font></b> {
      <b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-values</font>] l1 l2
      <b><font color=#3a6797>set</font></b> wtxt [alited::main::CurrentWTXT]
      <b><font color=#3a6797>append</font></b> tip [UnitTooltip <font color=#1b1baa>$wtxt</font> <font color=#1b1baa>$l1</font> <font color=#1b1baa>$l2</font>]
    }
    <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$al(TIPS,Tree)</font> && ![<b><font color=#3a6797>info</font></b> exists todo]} {
      <i><font color=#4b5d50># no tips while switched off (excepting for TODOs)</font></i>
      <b><font color=#ca14ca>return</font></b> {}
    }
  } <b><font color=#3a6797>else</font></b> {
    <i><font color=#4b5d50># for files</font></i>
    <b><font color=#3a6797>lassign</font></b> [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-values</font>] -&gt; tip isfile
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$isfile</font>} {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,showinfo)</font>} {
        <b><font color=#3a6797>set</font></b> tip [alited::file::FileStat <font color=#1b1baa>$tip</font>]
      } <b><font color=#3a6797>else</font></b> {
        <b><font color=#3a6797>set</font></b> tip {}
      }
    }
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$tip</font>
}
<a id=Directories_procs></a>
<i><font color=#4b5d50># ________________________ Directories procs _________________________ #</font></i>
<a id=tree::PrepareDirectoryContents></a>
<b><font color=#ca14ca>proc</font></b> tree::PrepareDirectoryContents {} {
  <i><font color=#4b5d50># Prepares reading a directory's contents.</font></i>
  <i><font color=#4b5d50># See also: GetDirectoryContents</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al _dirtree _dirtree
  <b><font color=#3a6797>set</font></b> _dirtree [<b><font color=#3a6797>set</font></b> al(_dirignore) [<b><font color=#3a6797>list</font></b>]]
  <b><font color=#3a6797>catch</font></b> {    ;<i><font color=#4b5d50># there might be an incorrect list -&gt; catch it</font></i>
    <b><font color=#3a6797>foreach</font></b> d <font color=#1b1baa>$al(prjdirign)</font> {
      <b><font color=#3a6797>lappend</font></b> al(_dirignore) [<b><font color=#3a6797>string</font></b> toupper [<b><font color=#3a6797>string</font></b> trim <font color=#1b1baa>$d</font> \&quot;]]
    }
  }
  <b><font color=#3a6797>lappend</font></b> al(_dirignore) [<b><font color=#3a6797>string</font></b> toupper [<b><font color=#3a6797>file</font></b> tail [alited::Tclexe]]] . ..
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::GetDirectoryContents></a>
<b><font color=#ca14ca>proc</font></b> tree::GetDirectoryContents {dirname} {
  <i><font color=#4b5d50># Gets a directory's contents.</font></i>
  <i><font color=#4b5d50>#   dirname - the directory's name</font></i>
  <i><font color=#4b5d50># Returns a list containing the directory's contents.</font></i>
  <i><font color=#4b5d50># See also: DirContents</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited _dirtree _dirtree
  DirContents <font color=#1b1baa>$dirname</font>
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$_dirtree</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::DirContents></a>
<b><font color=#ca14ca>proc</font></b> tree::DirContents {dirname {lev 0} {iroot -1} {globs <font color=#8b2a0e>&quot;*&quot;</font>}} {
  <i><font color=#4b5d50># Reads a directory's contents.</font></i>
  <i><font color=#4b5d50>#   dirname - a dirtectory's name</font></i>
  <i><font color=#4b5d50>#   lev - level in the directory hierarchy</font></i>
  <i><font color=#4b5d50>#   iroot - index of the directory's parent or -1</font></i>
  <i><font color=#4b5d50>#   globs - list of globs to filter files.</font></i>
  <i><font color=#4b5d50># See also:</font></i>
  <i><font color=#4b5d50>#   GetDirectoryContents</font></i>
  <i><font color=#4b5d50>#   AddToDirContents</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al _dirtree _dirtree
  <b><font color=#3a6797>incr</font></b> lev
  <b><font color=#3a6797>set</font></b> tpl [<b><font color=#3a6797>file</font></b> join <font color=#1b1baa>$dirname</font> *]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> dcont [<b><font color=#3a6797>glob</font></b> <font color=#1b1baa>$tpl</font>]}]} {
    <b><font color=#3a6797>set</font></b> dcont [<b><font color=#3a6797>list</font></b>]
  }
  <b><font color=#3a6797>catch</font></b> {
    <b><font color=#3a6797>lappend</font></b> dcont {<b><font color=#3a6797>*</font></b>}[<b><font color=#3a6797>glob</font></b> <font color=#653760>-type</font> hidden <font color=#1b1baa>$tpl</font>]
  }
  <b><font color=#3a6797>set</font></b> dcont [<b><font color=#3a6797>lsort</font></b> <font color=#653760>-dictionary</font> <font color=#1b1baa>$dcont</font>]
  <i><font color=#4b5d50># firstly directories:</font></i>
  <i><font color=#4b5d50># 1. skip the ignored ones</font></i>
  <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$dcont</font>]} {<font color=#1b1baa>$i</font>} {} {
    <b><font color=#3a6797>incr</font></b> i -1
    <b><font color=#3a6797>if</font></b> {[IgnoredDir [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$dcont</font> <font color=#1b1baa>$i</font>]]} {
      <b><font color=#3a6797>set</font></b> dcont [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$dcont</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$i</font>]
    }
  }
  <i><font color=#4b5d50># 2. put the directories to the beginning of the file list</font></i>
  <b><font color=#3a6797>set</font></b> i 0
  <b><font color=#3a6797>foreach</font></b> fname <font color=#1b1baa>$dcont</font> {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>file</font></b> isdirectory <font color=#1b1baa>$fname</font>]} {
      <b><font color=#3a6797>set</font></b> dcont [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$dcont</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$i</font> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$fname</font> <font color=#8b2a0e>&quot;y&quot;</font>]]
      <b><font color=#3a6797>set</font></b> nroot [AddToDirContents <font color=#1b1baa>$lev</font> 0 <font color=#1b1baa>$fname</font> <font color=#1b1baa>$iroot</font>]
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$_dirtree</font>] &lt; <font color=#1b1baa>$al(MAXFILES)</font>} {
        DirContents <font color=#1b1baa>$fname</font> <font color=#1b1baa>$lev</font> <font color=#1b1baa>$nroot</font> <font color=#1b1baa>$globs</font>
      } <b><font color=#3a6797>else</font></b> {
        <b><font color=#ca14ca>break</font></b>
      }
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> dcont [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$dcont</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$i</font> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$fname</font>]]
    }
    <b><font color=#3a6797>incr</font></b> i
  }
  <i><font color=#4b5d50># then files</font></i>
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$_dirtree</font>] &lt; <font color=#1b1baa>$al(MAXFILES)</font>} {
    <b><font color=#3a6797>foreach</font></b> fname <font color=#1b1baa>$dcont</font> {
      <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$fname</font> fname d
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$d</font> ne <font color=#8b2a0e>&quot;y&quot;</font>} {
        <b><font color=#3a6797>foreach</font></b> gl [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$globs</font> <font color=#8b2a0e>&quot;,&quot;</font>] {
          <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> match <font color=#1b1baa>$gl</font> <font color=#1b1baa>$fname</font>]} {
            AddToDirContents <font color=#1b1baa>$lev</font> 1 <font color=#1b1baa>$fname</font> <font color=#1b1baa>$iroot</font>
            <b><font color=#ca14ca>break</font></b>
          }
        }
      }
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::AddToDirContents></a>
<b><font color=#ca14ca>proc</font></b> tree::AddToDirContents {lev isfile fname iroot} {
  <i><font color=#4b5d50># Adds an item to a list of directory's contents.</font></i>
  <i><font color=#4b5d50>#   lev - level in the directory hierarchy</font></i>
  <i><font color=#4b5d50>#   isfile - a flag &quot;file&quot; (if yes) or &quot;directory&quot; (if no)</font></i>
  <i><font color=#4b5d50>#   fname - a file name to be added</font></i>
  <i><font color=#4b5d50>#   iroot - index of the directory's parent or -1</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al _dirtree _dirtree
  <b><font color=#3a6797>set</font></b> dllen [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$_dirtree</font>]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dllen</font> &lt; <font color=#1b1baa>$al(MAXFILES)</font>} {
    <b><font color=#3a6797>lappend</font></b> _dirtree [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$lev</font> <font color=#1b1baa>$isfile</font> <font color=#1b1baa>$fname</font> 0 <font color=#1b1baa>$iroot</font>]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$iroot</font>&gt;-1} {
      <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$_dirtree</font> <font color=#1b1baa>$iroot</font>] lev isfile fname fcount sroot
      <b><font color=#3a6797>set</font></b> _dirtree [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$_dirtree</font> <font color=#1b1baa>$iroot</font> <font color=#1b1baa>$iroot</font> \
        [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$lev</font> <font color=#1b1baa>$isfile</font> <font color=#1b1baa>$fname</font> [<b><font color=#3a6797>incr</font></b> fcount] <font color=#1b1baa>$sroot</font>]]
    }
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$dllen</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::IgnoredDir></a>
<b><font color=#ca14ca>proc</font></b> tree::IgnoredDir {dir} {
  <i><font color=#4b5d50># Checks if a directory is in the list of the ignored ones.</font></i>
  <i><font color=#4b5d50>#   dir - the directory's name</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al
  <b><font color=#3a6797>set</font></b> dir [<b><font color=#3a6797>string</font></b> toupper [<b><font color=#3a6797>file</font></b> tail <font color=#1b1baa>$dir</font>]]
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-exact</font> <font color=#1b1baa>$al(_dirignore)</font> <font color=#1b1baa>$dir</font>]&gt;-1}]
}
<a id=Tree_procs></a>
<i><font color=#4b5d50># ________________________ Tree procs _________________________ #</font></i>
<a id=tree::ForEach></a>
<b><font color=#ca14ca>proc</font></b> tree::ForEach {wtree aproc {lev 0} {branch {}}} {
  <i><font color=#4b5d50># Scans all items of the tree.</font></i>
  <i><font color=#4b5d50>#   wtree - the tree's path</font></i>
  <i><font color=#4b5d50>#   aproc - a procedure to run at scanning</font></i>
  <i><font color=#4b5d50>#   lev - level of the tree</font></i>
  <i><font color=#4b5d50>#   branch - ID of the branch to be scanned</font></i>
  <i><font color=#4b5d50># The 'aproc' argument can include wildcards to be replaced</font></i>
  <i><font color=#4b5d50># appropriate data:</font></i>
  <i><font color=#4b5d50>#    %level - current tree level</font></i>
  <i><font color=#4b5d50>#    %children - children of a current item</font></i>
  <i><font color=#4b5d50>#    %item - ID of a current item</font></i>
  <i><font color=#4b5d50>#    %text - text of a current item</font></i>
  <i><font color=#4b5d50>#    %values - values of a current item</font></i>

  <b><font color=#3a6797>set</font></b> children [<font color=#1b1baa>$wtree</font> children <font color=#1b1baa>$branch</font>]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$lev</font>} {
    <b><font color=#3a6797>set</font></b> proc [<b><font color=#3a6797>string</font></b> map [<b><font color=#3a6797>list</font></b> \
      %level <font color=#1b1baa>$lev</font> \
      %children [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$children</font>] \
      %item <font color=#1b1baa>$branch</font> \
      %text [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$branch</font> <font color=#653760>-text</font>] \
      %values [<font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$branch</font> <font color=#653760>-values</font>]] \
      <font color=#1b1baa>$aproc</font>]
    <b><font color=#3a6797>uplevel</font></b> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$lev</font>+1}] <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>proc&quot;</font>
  }
  <b><font color=#3a6797>incr</font></b> lev
  <b><font color=#3a6797>foreach</font></b> child <font color=#1b1baa>$children</font> {
    ForEach <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$aproc</font> <font color=#1b1baa>$lev</font> <font color=#1b1baa>$child</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::GetTree></a>
<b><font color=#ca14ca>proc</font></b> tree::GetTree {{parent {}} {Tree Tree} {wtree <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Gets a tree or its branch.</font></i>
  <i><font color=#4b5d50>#   parent - ID of the branch</font></i>
  <i><font color=#4b5d50>#   Tree - name of the tree widget</font></i>
  <i><font color=#4b5d50>#   wtree - full path to the tree</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wtree</font> eq {}} {<b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> <font color=#1b1baa>$Tree</font>]}
  <b><font color=#3a6797>set</font></b> tree [<b><font color=#3a6797>list</font></b>]
  <b><font color=#3a6797>set</font></b> levp -1
  ForEach <font color=#1b1baa>$wtree</font> {
    <b><font color=#3a6797>set</font></b> item <font color=#8b2a0e>&quot;%item&quot;</font>
    <b><font color=#3a6797>set</font></b> lev %level
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$levp</font>&gt;-1 || <font color=#1b1baa>$item</font> eq <font color=#1b1baa>$parent</font>} {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$lev</font>&lt;=<font color=#1b1baa>$levp</font>} {<b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> break}  ;<i><font color=#4b5d50># all of branch fetched</font></i>
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$item</font> eq <font color=#1b1baa>$parent</font>} {<b><font color=#3a6797>set</font></b> levp <font color=#1b1baa>$lev</font>}
    }
    <b><font color=#3a6797>catch</font></b> {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$parent</font> eq {} || <font color=#1b1baa>$levp</font>&gt;-1} {
        <b><font color=#3a6797>lappend</font></b> tree [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$lev</font> %children <font color=#1b1baa>$item</font> {%text} {%values}]
      }
    }
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$tree</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::ExpandContractTree></a>
<b><font color=#ca14ca>proc</font></b> tree::ExpandContractTree {Tree {isexp yes}} {
  <i><font color=#4b5d50># Expands or contracts the tree.</font></i>
  <i><font color=#4b5d50>#   Tree - the tree's name</font></i>
  <i><font color=#4b5d50>#   isexp - yes, if to expand; no, if to contract</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> <font color=#1b1baa>$Tree</font>]
  <b><font color=#3a6797>set</font></b> pos [[alited::main::CurrentWTXT] index insert]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <b><font color=#3a6797>lassign</font></b> [CurrentItemByLine <font color=#1b1baa>$pos</font> 1] itemID
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> itemID [CurrentItem]
  }
  <b><font color=#3a6797>set</font></b> branch [<b><font color=#3a6797>set</font></b> selbranch {}]
  <b><font color=#3a6797>foreach</font></b> item [GetTree {} <font color=#1b1baa>$Tree</font>] {
    <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$item</font> lev cnt ID
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> [<font color=#1b1baa>$wtree</font> children <font color=#1b1baa>$ID</font>]]} {
      <b><font color=#3a6797>set</font></b> branch <font color=#1b1baa>$ID</font>
      <font color=#1b1baa>$wtree</font> item <font color=#1b1baa>$ID</font> <font color=#653760>-open</font> <font color=#1b1baa>$isexp</font>
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ID</font> eq <font color=#1b1baa>$itemID</font>} {<b><font color=#3a6797>set</font></b> selbranch <font color=#1b1baa>$branch</font>}
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$isexp</font>} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$itemID</font> ne {}} {<font color=#1b1baa>$wtree</font> selection set <font color=#1b1baa>$itemID</font>}
    SeeSelection
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$selbranch</font> ne {}} {
    <font color=#1b1baa>$wtree</font> selection set <font color=#1b1baa>$selbranch</font>
    SeeSelection
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::RecreateTree></a>
<b><font color=#ca14ca>proc</font></b> tree::RecreateTree {{wtree <font color=#8b2a0e>&quot;&quot;</font>} {headers <font color=#8b2a0e>&quot;&quot;</font>} {clearsel no}} {
  <i><font color=#4b5d50># Recreates the tree and restores its selections.</font></i>
  <i><font color=#4b5d50>#   wtree - the tree's path</font></i>
  <i><font color=#4b5d50>#   headers - a list of selected items</font></i>
  <i><font color=#4b5d50>#   clearsel - if yes, clears tree's selection</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wtree</font> eq {}} {<b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$clearsel</font> || [<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> selection [<font color=#1b1baa>$wtree</font> selection]}]} {
    <b><font color=#3a6797>set</font></b> selection [<b><font color=#3a6797>list</font></b>]
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} {
    <b><font color=#3a6797>set</font></b> al(TREE,units) no
    <b><font color=#3a6797>set</font></b> TID [alited::bar::CurrentTabID]
    <b><font color=#3a6797>set</font></b> wtxt [alited::main::CurrentWTXT]
    alited::unit::RecreateUnits <font color=#1b1baa>$TID</font> <font color=#1b1baa>$wtxt</font>
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> al(TREE,files) no
  }
  Create
  <i><font color=#4b5d50># restore selections</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$headers</font> eq {-}} <b><font color=#ca14ca>return</font></b>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$headers</font> ne {}} {
    <b><font color=#3a6797>set</font></b> selection [<b><font color=#3a6797>list</font></b>]
    <b><font color=#3a6797>foreach</font></b> item [alited::tree::GetTree] {
      <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$item</font> lev cnt ID
      <b><font color=#3a6797>foreach</font></b> hd <font color=#1b1baa>$headers</font> {
        <b><font color=#3a6797>if</font></b> {[alited::unit::GetHeader <font color=#1b1baa>$wtree</font> <font color=#1b1baa>$ID</font>] eq <font color=#1b1baa>$hd</font>} {
          <b><font color=#3a6797>lappend</font></b> selection <font color=#1b1baa>$ID</font>
          <b><font color=#ca14ca>break</font></b>
        }
      }
    }
    <font color=#1b1baa>$wtree</font> selection set <font color=#1b1baa>$selection</font>
  } <b><font color=#3a6797>else</font></b> {
    <i><font color=#4b5d50># try to restore selections</font></i>
    <b><font color=#3a6797>foreach</font></b> item <font color=#1b1baa>$selection</font> {
      <b><font color=#3a6797>catch</font></b> {<font color=#1b1baa>$wtree</font> selection add <font color=#1b1baa>$item</font>}
    }
  }
  <b><font color=#3a6797>catch</font></b> {<font color=#1b1baa>$wtree</font> see [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$selection</font> 0]}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=tree::UpdateFileTree></a>
<b><font color=#ca14ca>proc</font></b> tree::UpdateFileTree {{doit no}} {
  <i><font color=#4b5d50># Updates the file tree (colors of files).</font></i>
  <i><font color=#4b5d50>#   doit - yes, if run after idle</font></i>
  <i><font color=#4b5d50># See also: CreateFilesTree</font></i>

  <b><font color=#3a6797>namespace</font></b> upvar ::alited al al obPav obPav
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$al(TREE,isunits)</font>} <b><font color=#ca14ca>return</font></b>  ;<i><font color=#4b5d50># no need</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$doit</font>} {
    <b><font color=#3a6797>set</font></b> wtree [<font color=#1b1baa>$obPav</font> Tree]
    <b><font color=#3a6797>foreach</font></b> item [GetTree {} Tree] {
      <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$item</font> 4] - fname leaf itemID
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$leaf</font>} {
        <b><font color=#3a6797>if</font></b> {[alited::bar::FileTID <font color=#1b1baa>$fname</font>] ne {}} {
          <font color=#1b1baa>$wtree</font> tag add tagSel <font color=#1b1baa>$itemID</font>
        } <b><font color=#3a6797>else</font></b> {
          <font color=#1b1baa>$wtree</font> tag remove tagSel <font color=#1b1baa>$itemID</font>
        }
      }
    }
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>after</font></b> cancel <font color=#1b1baa>$al(_UPDATEFILETREE_)</font>}
    <b><font color=#3a6797>set</font></b> al(_UPDATEFILETREE_) [<b><font color=#3a6797>after</font></b> idle {alited::tree::UpdateFileTree yes}]
  }
}
<a id=EOF></a>
<i><font color=#4b5d50># _________________________________ EOF _________________________________ #</font></i>

</pre>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../index.html"><font color=#1a1a1a size=6>  <b>tree.tcl</b></font></div></td></table>

</section>
<script>
  writeFooter('Generated by <a href="'+homeLINK()+'/en/tcl/alited/index.html">alited</a> &amp; <a href="'+homeLINK()+'/en/tcl/mulster/index.html">mulster</a></a>');
</script>
</div>
</body>
</html>