<!DOCTYPE html><html><head><meta charset="utf-8"/>
<meta name="author" content="aplsimple">
<meta name="description" content="aplsimple's home page">
<meta name="keywords" content="aplsimple,home">
</head>
<style>
table{
background-color: #f9f9f9;
margin: 0%;
margin-bottom: 2%;
padding: 0%;
box-shadow: none;
filter: none;
}
pre{
margin: 0%;
margin-bottom: 2%;
padding: 0%;
}
</style>
<script>
function homeLINK() {
  homelink = document.baseURI;
  ilen = 19
  ibase = homelink.indexOf('aplsimple.github');
  if (ibase<0) { ibase = homelink.indexOf('aplsimple_github'); ilen += 10 };
  if (ibase>=0) { homelink = homelink.substring(0,ibase+ilen) };
  return homelink;
};
document.write(' \
<link rel="stylesheet" href="'+homeLINK()+'/en/tcl/printer/zoo/style.css">');
document.write(' \
<link rel="icon" type="image/jpg" href="'+homeLINK()+'/zoo/favicon.jpg">');
document.write('<'+'script src="'+homeLINK()+'/zoo/funcs.js">'+'<'+'/script>');
document.write('<'+'script src="'+homeLINK()+'/en/tcl/printer/zoo/this.js">'+'<'+'/script>');
</script>
<body>
<div id="wrapper">
<div name="divd1" ALIGN="CENTER"> <FONT SIZE=5em color=#b01c20><B>
<noscript>THIS PAGE IS NOT WORKING WITHOUT JAVASCRIPT!
<BR>
<BR>PLEASE, SWITCH ON JAVASCRIPT IN SETTINGS OF YOUR BROWSER AND RELOAD THE PAGE.
</noscript>
</B></FONT></div>
<div id='doc3' class='yui-t2'>
<section id=sec2>
<div id='hd' class='banner'>

<title>hl_tcl.tcl</title>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../index.html"><font color=#1a1a1a size=6>  <b>README.md</b></font></div></td></table>

<div id="bodyContent" class="dokuwiki">
<div id="dw__toc" class="dw__toc">
<h3 class="toggle open" style="cursor: pointer;">hl_tcl.tcl</h3>
<div aria-expanded="true" style="">

<ul class="toc">
<li><b><a href="#hl_tcl.tcl">hl_tcl.tcl</a></b></li>
<li><b><a href="#Common_data">Common data</a></b></li>
<li><b><a href="#STATIC_highlighting">STATIC highlighting</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::AuxEnding">AuxEnding</a><span class=tooltiptext> my::AuxEnding : Auxiliary procedure to process the ending comments in the line.
kName - variable's name for 'k'
lineName - variable's name for 'line'
iName - variable's name for 'i'
See also: HighlightLine</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::NotEscaped">NotEscaped</a><span class=tooltiptext> my::NotEscaped : Checks if a character escaped in a line.
line - line
i - the character's position in 'line'
Returns "1" if the character not escaped.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::RemoveTags">RemoveTags</a><span class=tooltiptext> my::RemoveTags : Removes tags in text.
txt - text widget's path
from - starting index
to - ending index</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightCmd">HighlightCmd</a><span class=tooltiptext> my::HighlightCmd : Highlights Tcl/Tk commands.
txt - text widget's path
line - line to be highlighted
ln - line number
pri - column number to highlighted from
i - current position in 'line'</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightStr">HighlightStr</a><span class=tooltiptext> my::HighlightStr : Highlights strings.
txt - text widget's path
p1 - starting index of the string in 'txt'
p2 - ending index of the string in 'txt'</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::FirstQtd">FirstQtd</a><span class=tooltiptext> my::FirstQtd : Searches the quote characters in line.
lineName - variable's name for 'line'
iName - variable's name for 'i'
currQtd - yes, if searching inside the quoted
Returns "yes" if a quote character was found.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightComment">HighlightComment</a><span class=tooltiptext> my::HighlightComment : Highlights comments.
txt - text widget's path
line - current line
ln - line's number
k - comment's starting position in line</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightLine">HighlightLine</a><span class=tooltiptext> my::HighlightLine : Highlights a line in text.
txt - text widget's path
ln - line's number
prevQtd - flag of "being quoted" from the previous line</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightAll">HighlightAll</a><span class=tooltiptext> my::HighlightAll : Highlights all of a text.
txt - text widget's path
Makes a coroutine from this.
See also: CoroHighlightAll
let them work one by one:</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::CoroHighlightAll">CoroHighlightAll</a><span class=tooltiptext> my::CoroHighlightAll : Highlights all of a text as a coroutine.
txt - text widget's path
See also: HighlightAll</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::BindToEvent">BindToEvent</a><span class=tooltiptext> my::BindToEvent : Binds an event on a widget to a command.
w - the widget's path
event - the event
args - the command</span></div></li></ul>
<li><b><a href="#DYNAMIC_highlighting">DYNAMIC highlighting</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::CountQSH">CountQSH</a><span class=tooltiptext> my::CountQSH : Counts quotes, slashes, hashes in a line
txt - text widget's path
ln - line's index</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::IsCurline">IsCurline</a><span class=tooltiptext> my::IsCurline : Sets / gets "highlight a current line" flag for a text.
txt - the text's path
flag - the flag</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::ShowCurrentLine">ShowCurrentLine</a><span class=tooltiptext> my::ShowCurrentLine : Shows the current line.
txt - text widget's path
doit - if yes, forces updating current line's background
Returns a current position of cursor.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::MemPos1">MemPos1</a><span class=tooltiptext> my::MemPos1 : Checks and sets the cursor's width, depending on its position.
txt - text widget's path
donorm - if yes, forces "normal" cursor
K - key (%K of bind)
s - state (%s of bind)
This fixes an issue with text cursor: less width at 0th column.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::MemPos">MemPos</a><span class=tooltiptext> my::MemPos : Remembers the state of current line.
txt - text widget's path
doit - argument for ShowCurrentLine
See also: ShowCurrentLine</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::RunCoroAfterIdle">RunCoroAfterIdle</a><span class=tooltiptext> my::RunCoroAfterIdle : Runs a "modified" corotine after idle.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::Modified">Modified</a><span class=tooltiptext> my::Modified : Handles modifications of text.
txt - text widget's path
Makes a coroutine from this.
See also: CoroModified</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::CoroRun">CoroRun</a><span class=tooltiptext> my::CoroRun</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::CoroModified">CoroModified</a><span class=tooltiptext> my::CoroModified : Handles modifications of text.
txt - text widget's path
i1 - 1st index of changes
i2 - 2nd index of changes
args - arguments for a command called after the modifications
See also: Modified</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::InRange">InRange</a><span class=tooltiptext> my::InRange : Checks if a text position is in a range of text positions.
p1 - 1st position of range
p2 - 2nd position of range
l - line position to check (or 'l.c' if 'c' not set)
c - column position to check</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::SearchTag">SearchTag</a><span class=tooltiptext> my::SearchTag : Searches a position in tag ranges.
tagpos - tag position ranges
l1 - the position to find
Returns a found range's index of -1 if not found.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::LineState">LineState</a><span class=tooltiptext> my::LineState : Gets an initial state of line.
txt - text widget's path
tSTR - ranges of string tags
tCMN - ranges of comment tags
l1 - the line's index
Returns: 0 if no tags for the line; 1 if the line is a string's continuation; -1 if the line is a comment's continuation.</span></div></li></ul>
<li><b><a href="#HEROIC_EFFORTS_to_highlight_the_matching_brackets">HEROIC EFFORTS to highlight the matching brackets</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::MergePosList">MergePosList</a><span class=tooltiptext> my::MergePosList : Merges lists of numbers that are not-coinciding and sorted.
none - a number to be not allowed in the lists (e.g. less than minimal)
args - list of the lists to be merged
Returns a list of pairs: index of list + item of list.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::CountChar">CountChar</a><span class=tooltiptext> my::CountChar : Counts a character in a string.
str - the string
ch - the character
plistName - variable name for a list of positions of *ch*
escaped - true, if the character is escaped.
Returns a number of any occurences of character *ch* in string *str*
if the character is escaped, but if it is not escaped, only non-escaped
characters are counted.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::Escaped">Escaped</a><span class=tooltiptext> my::Escaped : Checks if a character is escaped in a string.
line - the string
curpos - position of the character in the line
Returns 1 if the character is escaped in the string.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::MatchedBrackets">MatchedBrackets</a><span class=tooltiptext> my::MatchedBrackets : Finds a match of characters (dchar for schar).
w - text widget's path
inplist - list of strings where to find a match
curpos - position of schar in nl.nc form where nl=1.., nc=0..
schar - source character
dchar - destination character
dir - search direction: 1 to the end, -1 to the beginning of list</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightBrackets">HighlightBrackets</a><span class=tooltiptext> my::HighlightBrackets : Highlights matching brackets if any.
w - text widget's path</span></div></li></ul>
<li><b><a href="#INTERFACE_procedures">INTERFACE procedures</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_readonly">hl_readonly</a><span class=tooltiptext> hl_tcl::hl_readonly : Makes the text widget be readonly or gets its 'read-only' state.
txt - text widget's path
ro - flag "the text widget is readonly"
com2 - command to be called at viewing and after changes
If 'ro' argument is omitted, returns the widget's 'read-only' state.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_init">hl_init</a><span class=tooltiptext> hl_tcl::hl_init : Initializes highlighting.
txt - text widget's path
args - dict of options
The 'args' options include:
-- - means that only args' options will be initialized (defaults skipped)
-dark - flag "the text widget has dark background"
-readonly - flag "read-only"
-optRE - flag "use of RE to highlight options"
-multiline - flag "allowed multi-line strings"
-cmd - command to watch editing/viewing
-cmdpos - command to watch cursor positioning
-colors - list of colors as set in hl_tcl::hl_colorNames
-font - attributes of font
-seen - lines seen at start
-keywords - additional commands to highlight (as Tk ones)
-dobind - if yes, forces key bindings
This procedure has to be called before writing a text in the text widget.
See also: hl_colorNames</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_text">hl_text</a><span class=tooltiptext> hl_tcl::hl_text : Highlights Tcl code of a text widget.
txt - text widget's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_all">hl_all</a><span class=tooltiptext> hl_tcl::hl_all : Updates ("rehighlights") all highlighted and existing text widgets.
args - dict of options
See also: hl_init</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_colorNames">hl_colorNames</a><span class=tooltiptext> hl_tcl::hl_colorNames : Returns a list of color names for syntax highlighting.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_colors">hl_colors</a><span class=tooltiptext> hl_tcl::hl_colors : Gets/sets the main colors for highlighting (except for "curr.line").
txt - text widget's path or {} or an index of default colors
dark - flag "dark scheme"
args - a list of colors to set for *txt*
Returns a list of colors for COM COMTK STR VAR CMN PROC OPT BRAC \</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_line">hl_line</a><span class=tooltiptext> hl_tcl::hl_line : Updates a current line's highlighting.
txt - text's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::addingColors">addingColors</a><span class=tooltiptext> hl_tcl::addingColors : Sets/gets colors for a text syntax highlighting.
dark - yes, if the current theme is dark
txt - path to the text or {}
cs - color scheme
If *txt* omitted, returns a list of resting colors.
The resting colors are:
- current line's background
- #TODO and #! comment's foreground</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::hl_commands">hl_commands</a><span class=tooltiptext> hl_tcl::hl_commands : Lists all Tcl/Tk commands registered here.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::iscurline">iscurline</a><span class=tooltiptext> hl_tcl::iscurline : Sets / gets "highlight a current line" flag for a text.
txt - the text's path
flag - the flag</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::isdone">isdone</a><span class=tooltiptext> hl_tcl::isdone : Checks if the highlighting of the text is done.
txt - text's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::clearup">clearup</a><span class=tooltiptext> hl_tcl::clearup : Clears data related to text (esp. at deleting it).
txt - text's path</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::cget">cget</a><span class=tooltiptext> hl_tcl::cget : Gets a highlighting option's value.
txt - text's path
opt - option's name</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::configure">configure</a><span class=tooltiptext> hl_tcl::configure : Sets a highlighting option's value.
txt - text's path
opt - option's name
val - option's value</span></div></li></ul>
<li><b><a href="#Helpers">Helpers</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#hl_tcl::OptName">OptName</a><span class=tooltiptext> hl_tcl::OptName : Gets hl_tcl option's name.
txt - text's path
opt - option</span></div></li></ul>
<li><b><a href="#EOF">EOF</a></b></li>

</ul>

</div>
</div>
</div>
<!-- TOC END -->

<h1><font color=#ca14ca> hl_tcl</font></h1>
</p><p>
The <i><font color=#1b1baa>hl_tcl</font></i> package is a syntax highlighter for Tcl/Tk code.
</p><p>
It can be applied to a <i><font color=#1b1baa>Tk text</font></i> widget or to a static html page.
</p><p>
The <i><font color=#1b1baa>Tk text</font></i> widget may be made read-only or editable. Also, the <i><font color=#1b1baa>hl_tcl</font></i> may take an argument, sort of command to watch the viewing / editing.
</p><p>
When applied to html pages, the <i><font color=#1b1baa>hl_tcl</font></i> highlights Tcl/Tk code snippets embedded between <a href="&lt;">&lt;</a>code<a href="&gt;">&gt;</a> <a href="&lt;">&lt;</a>/code<a href="&gt;">&gt;</a> tags.
</p><p>
The <i><font color=#1b1baa>hl_tcl</font></i> has highlighted its own code in <a href="https://aplsimple.github.io/en/tcl/hl_tcl/hl_tcl.html">Reference</a>.
</p><p>
<h1><font color=#ca14ca> Some of blah-blah</font></h1>
</p><p>
The Tcl being incredibly dynamic language sets a lot of problems before any Tcl syntax highlighter. Probably, the usage of quotes and esp. the strings spanning several lines are the main challenges.
</p><p>
Below is a line that brings most (not <i><font color=#1b1baa>hl_tcl</font></i>, as seen in <a href="https://aplsimple.github.io/en/tcl/hl_tcl/hl_tcl.html">Reference</a>) of Tcl highlighters in a stupor:
<pre class="code"><b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>string</font></b> first {&quot;} <font color=#1b1baa>$line</font> <font color=#1b1baa>$i</font>]]==-1} {<b><font color=#ca14ca>return</font></b> no}</pre>... as well as this one:
<pre class="code"><b><font color=#3a6797>regsub</font></b> <font color=#653760>-all</font> {(([^A-Z@]|\\@)[.?!](&quot;|'|'')?([])])?) } <font color=#1b1baa>$fieldText</font> {\1  } fieldText</pre>Good luck for a highlighter when the second line (or similar) follows the first, giving it a matching quote and thus bringing it out of the stupor.
</p><p>
Those orphan quotes are often used in <code><b><font color=#3a6797>regexp</font></b></code> and <code><b><font color=#3a6797>regsub</font></b></code> Tcl commands, so that when a honest Tcl highlighter (like <a href="https://www.geany.org" title="Geany IDE">Geany</a>) stumbles upon an orphan quote, it tries its best to highlight the rest of code as a string, till the next unmatched quote.
</p><p>
Thus, we have
</p><p>
<img src="https://aplsimple.github.io/en/tcl/hl_tcl/files/hltcl1.png" class="media" alt="">
</p><p>
... instead of
</p><p>
<img src="https://aplsimple.github.io/en/tcl/hl_tcl/files/hltcl2.png" class="media" alt="">
</p><p>
There are "tricky" highlighters (like <a href="https://wiki.gnome.org/Apps/Gedit" title="Gedit editor">Gedit</a>) that behave more wisely at the stumbling an orphan quote: they permit only a one-line Tcl strings (if not continued with \\), so that the string highlighting would be most likely finished in the same line it started. No problems except for this silly line. And no delays due to the highlighting the rest of code...
</p><p>
... as seen in:
</p><p>
<img src="https://aplsimple.github.io/en/tcl/hl_tcl/files/hltcl3.png" class="media" alt="">
</p><p>
<h1><font color=#ca14ca> Some of editors</font></h1>
</p><p>
<a href="https://www.geany.org" title="Geany IDE">Geany</a>. Probably, the best Tcl highlighter. And the great programming tool at that. Still, it has few drawbacks:
</p><p>
<li>doesn't highlight the above mentioned Tcl lines properly</li>
<li>doesn't highlight <code><font color=#1b1baa>${var}</font></code> in contrast with <code><font color=#1b1baa>$var</font></code></li>
<li>tries to highlight any (even hexidecimal) number it encounters, thus <code><b><font color=#3a6797>set</font></b> a 1fix</code> or <code><b><font color=#3a6797>set</font></b> b #abxxx</code> looks a bit peculiar</li>
<li><code><b><font color=#3a6797>set</font></b> c {{#000} #FFF}</code> is quite a legal Tcl command as well as <code><b><font color=#3a6797>set</font></b> c {#000 #FFF}</code>, not for Geany</li>
<li>no highlighting TclOO (<code><b><font color=#ca14ca>method</font></b></code>, <code><b><font color=#ca14ca>my</font></b></code>, <code><b><font color=#3a6797>mixin</font></b></code> etc.)</li>
</p><p>
<a href="http://www.vim.org/" title="Vim editor">Vim</a>. Probably, the fastest Tcl highlighter. Great and awful. Nonetheless:
</p><p>
<li>tricky with those above mentioned Tcl lines</li>
<li>doesn't highlight ttk commands (Tk only) and TclOO</li>
<li>tries to highlight every bit of Tcl, e.g. <code><b><font color=#3a6797>set</font></b> set set</code> is highlighted as three <code><b><font color=#3a6797>set</font></b></code> commands ;)</li>
<li>as a result, much more florid than most of others</li>
</p><p>
<a href="https://kate-editor.org" title="Kate editor">Kate</a>. As nearly good as Geany. As nearly florid as Vim (<code><b><font color=#3a6797>set</font></b> set set</code>). Doesn't highlight ttk and TclOO.
</p><p>
<a href="https://github.com/phase1geo/tke/" title="TKE editor">TKE</a>. Written in Tcl/Tk, it might be the best of all to highlight the Tcl/Tk. In spite of its suspended state it still can. Issues with highlighting strings and the performance.
</p><p>
<a href="http://mate-desktop.org" title="Pluma editor">Pluma</a> and <a href="https://wiki.gnome.org/Apps/Gedit" title="Gedit editor">Gedit</a> seem to use the same Tcl highlighting engine that gives rather good results. Still, the mentioned above drawbacks are here too. And no highlighting of tk, ttk, TclOO.
</p><p>
<a href="https://notepad-plus-plus.org/" title="Notepad++ official site">Notepad++</a>. Very fast Tcl highlighter. And very basic. All the same drawbacks. No highlighting of tk, ttk, TclOO. <i><font color=#1b1baa>Plus</font></i> an obsolete version of Tcl, i.e. no highlighting <code><b><font color=#3a6797>lset</font></b></code>, <code><b><font color=#3a6797>lassign</font></b></code> etc.
</p><p>
<h1><font color=#ca14ca> What can we do?</font></h1>
</p><p>
To develop an ideal (correct and fast) Tcl/Tk highlighter, we would have to dive into Tcl core. Though, no hopes to achieve the ideal through repeating the core in Tcl/Tk or massively using the regular expressions.
</p><p>
That said, while implementing Tcl/Tk highlighter <i><font color=#1b1baa>in pure Tcl/Tk</font></i>, we might hope to achieve a reasonable compromise between the performance and the elimination of blunders.
</p><p>
It seems <i><font color=#1b1baa>hl_tcl</font></i> got close to this compromise. Specifically, it provides:
</p><p>
<li>special highlighting for Tcl and TclOO commands</li>
<li>special highlighting for Tk and ttk commands</li>
<li>allowing additional commands to highlight (as Tk ones)</li>
<li>special highlighting for declarations <code><b><font color=#ca14ca>proc</font></b></code>, <code><b><font color=#ca14ca>method</font></b></code>, <code><b><font color=#ca14ca>oo::class</font></b></code> etc. as well as <code><b><font color=#ca14ca>return</font></b></code>, <code><b><font color=#ca14ca>yield</font></b></code></li>
<li>special highlighting for <code><i><font color=#4b5d50>#comments</font></i></code>, <code><font color=#1b1baa>$variables</font></code>, <code><font color=#8b2a0e>&quot;strings&quot;</font></code>, <code><font color=#653760>-options</font></code></li>
<li>in-line comments being recognized and thus highlighted only after <code>;<i><font color=#4b5d50>#</font></i></code></li>
<li>proper handling of most <code><b><font color=#3a6797>regexp</font></b></code> and <code><b><font color=#3a6797>regsub</font></b></code> expressions containing a quote</li>
<li>highlighting the multi-line strings, with possible switching this mode off (a-la Gedit) to improve the performance</li>
<li>customizing colors of the highlighting</li>
<li>highlighting viewable/editable <i><font color=#1b1baa>Tk text</font></i> widget and static html pages</li>
<li>good performance at editing 1000-4000 LOC and rather acceptable for 4000-9000 LOC</li>
<li>even monstrous 10000 LOC and more are handled fast at the "tricky" mode a-la Gedit</li>
</p><p>
The <i><font color=#1b1baa>hl_tcl</font></i> doesn't provide the following:
</p><p>
<li>highlighting <i><font color=#1b1baa>numbers</font></i></li>
<li>highlighting <i><font color=#1b1baa>brackets</font></i>, except for matched ones and inside the strings</li>
</p><p>
These are in no way critical drawbacks. A little less florid Tcl code might be even preferable for other tastes.
</p><p>
The Tcl can arrange its pitfalls for <i><font color=#1b1baa>hl_tcl</font></i> (I know where). Also, tricky practices or tastes can make a fool of <i><font color=#1b1baa>hl_tcl</font></i>. Still hopefully these pranks are few and rare to encounter.
</p><p>
<h1><font color=#ca14ca> Use for text widget</font></h1>
</p><p>
The code below:
<pre class="code"><b><font color=#3a6797>package</font></b> require hl_tcl

<b><font color=#ca14ca>proc</font></b> ::stub {args} {<b><font color=#3a6797>puts</font></b> <font color=#8b2a0e>&quot;stub: <font color=#1b1baa>$</font>args&quot;</font>}

::hl_tcl::hl_init <font color=#1b1baa>$::txt</font> <font color=#653760>-readonly</font> yes <font color=#653760>-cmd</font> ::stub

<i><font color=#4b5d50>#... inserting a text into the text widget</font></i>

::hl_tcl::hl_text <font color=#1b1baa>$::txt</font></pre>sets an example of <i><font color=#1b1baa>hl_tcl</font></i> usage. Here are the details:
</p><p>
<li><i><font color=#1b1baa>::stub</font></i> is a procedure to watch the text editing; here it simply puts out the text's last index;</li>
</p><p>
<li><i><font color=#1b1baa>hl_init</font></i> is called <i><font color=#1b1baa>before</font></i> filling the text widget with a Tcl code; it sets the highlighting options and disables the highlighting till <i><font color=#1b1baa>hl_text</font></i> runs;</li>
</p><p>
<li><i><font color=#1b1baa>hl_text</font></i> runs to highlight the Tcl code of the text widget and to view/edit it.</li>
</p><p>
The <i><font color=#1b1baa>hl_init</font></i> takes arguments:
</p><p>
<li><i><font color=#1b1baa>txt</font></i> is the text widget's path</li>
<li><i><font color=#1b1baa>args</font></i> contains options of text widget (omittable)</li>
</p><p>
The <i><font color=#1b1baa>args</font></i> is a list of <code><font color=#653760>-option</font> <font color=#8b2a0e>&quot;value&quot;</font></code> where <code><font color=#653760>-option</font></code> may be:
</p><p>
<li><code><font color=#653760>-colors</font></code> - list of colors: clrCOM, clrCOMTK, clrSTR, clrVAR, clrCMN, clrPROC, clrOPT</li>
<li><code><font color=#653760>-dark</font></code> - flag "dark background of text", i.e. simplified <code><font color=#653760>-colors</font></code> (default "no")</li>
<li><code><font color=#653760>-font</font></code> - attributes of text font</li>
<li><code><font color=#653760>-readonly</font></code> - flag "text is read-only" (default "no")</li>
<li><code><font color=#653760>-multiline</font></code> - flag "multi-line strings" (default "yes")</li>
<li><code><font color=#653760>-cmd</font></code> - command to watch editing/viewing (default "")</li>
<li><code><font color=#653760>-cmdpos</font></code> - command to watch cursor positioning (default "")</li>
<li><code><font color=#653760>-seen</font></code> - number of first lines seen at start (default 500)</li>
<li><code><font color=#653760>-optRE</font></code> - flag "use a regular expression to highlight options" (default "yes")</li>
<li><code><font color=#653760>-keywords</font></code> - additional commands to highlight (as Tk ones)</li>
<li><code><font color=#653760>-dobind</font></code> - if <code>true</code>, forces keys binding at repeating calls of hl_init</li>
<li><code><font color=#653760>-plaintext</font></code> - <code>true</code> for plain texts with no highlighting</li>
<li><code><font color=#653760>-plaincom</font></code> - a command for plain highlighting line by line</li>
</p><p>
<b><font color=#1b1baa>Note</font></b>: <code><font color=#653760>-seen</font> 500</code> and <code><font color=#653760>-multiline</font> no</code> can improve the performance a lot. It's recommended to use <code><font color=#653760>-seen</font> 500</code> (or any other reasonable limit, e.g. <code><font color=#653760>-seen</font> 200</code>) at any rate, except for static html pages.
</p><p>
A command for <code><font color=#653760>-plaincom</font></code> option has two arguments: a current text's path and a current line's number. It should highlight the current line and return <code>true</code>, otherwise (if the current line is Tcl code) it returns <code>false</code>. An example of its usage is presented by <a href="https://github.com/aplsimple/alited">alited editor</a> (<b><font color=#1b1baa>lib/addon</font></b> directory).
</p><p>
The rest of <i><font color=#1b1baa>hl_tcl</font></i> procedures are:
</p><p>
<li> <code>hl_all</code> updates all highlighted existing text widgets, e.g. at changing a color scheme of application</li>
<li> <code>hl_readonly</code> gets/sets a read-only mode and/or a command to watch a text widget at viewing/editing it</li>
<li> <code>hl_colors</code> gets a list of colors for highlighting</li>
</p><p>
See details in <a href="https://aplsimple.github.io/en/tcl/hl_tcl/hl_tcl.html">Reference</a>.
</p><p>

<h1><font color=#ca14ca> Use for static html</font></h1>
</p><p>
In the <a href="https://chiselapp.com/user/aplsimple/repository/hl_tcl/download">hl_tcl.zip</a>, there is a Tcl script named <i><font color=#1b1baa>tcl_html.tcl</font></i> that highlights Tcl snippets of static html page(s).
</p><p>
It runs as follows:
<pre class="code">tclsh tcl_html.tcl <font color=#8b2a0e>&quot;glob-pattern-of-html-files&quot;</font></pre>For example:
<pre class="code">tclsh ~/UTILS/hl_tcl/tcl_html.tcl <font color=#8b2a0e>&quot;~/UTILS/mulster/tasks/ruff/src/*&quot;</font></pre>In this example, the html files are located in <code>~/UTILS/mulster/tasks/ruff/src</code>.
</p><p>
Perhaps, you would want to modify the <i><font color=#1b1baa>tcl_html.tcl</font></i>, this way:
</p><p>
<li>replace <code><font color=#8b2a0e>&quot;no&quot;</font></code> with <code><font color=#8b2a0e>&quot;yes&quot;</font></code> for dark html pages</li>
</p><p>
<li>replace <code>&lt;code class=<font color=#8b2a0e>&quot;tcl&quot;</font>&gt;</code> with html tags <i><font color=#1b1baa>starting</font></i> the Tcl code in your html files</li>
</p><p>
<li>replace <code>&lt;/code&gt;</code> with html tags <i><font color=#1b1baa>finishing</font></i> the Tcl code in your html files</li>
</p><p>
These are arguments of <code>::hl_tcl_html::highlight</code> procedure.
</p><p>
The tag pairs can be multiple if the html pages contain them, e.g.
<pre class="code">::hl_tcl_html::highlight <font color=#1b1baa>$fhtml</font> <font color=#8b2a0e>&quot;no&quot;</font> \
  {&lt;code class=<font color=#8b2a0e>&quot;tcl&quot;</font>&gt;} {&lt;/code&gt;} \
  {&lt;pre class=<font color=#8b2a0e>&quot;code&quot;</font>&gt;} {&lt;/pre&gt;}</pre><h1><font color=#ca14ca> Links</font></h1>
</p><p>
<li><a href="https://aplsimple.github.io/en/tcl/hl_tcl/hl_tcl.html">Reference</a></li>
</p><p>
<li><a href="https://chiselapp.com/user/aplsimple/repository/hl_tcl/download">Source</a> (hl_tcl.zip)</li>
</p><p>
<li><a href="https://github.com/aplsimple/hl_tcl/releases/download/hl_tcl-0.6.1/hl_tcl-0.6.1.mp4">Demo of hl_tcl v0.6.1</a> (25 Mb)</li>
</p><p>
Note that <a href="https://aplsimple.github.io/en/tcl/hl_tcl/hl_tcl.html">hl_tcl</a> is still disposed to update.
</p><p>

</p>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../index.html"><font color=#1a1a1a size=6>  <b>hl_tcl.tcl</b></font></div></td></table>

<pre class="code"><i><font color=#4b5d50>###########################################################<a id=hl_tcl.tcl></a></font></i>
<i><font color=#4b5d50># Name:    hl_tcl.tcl</font></i>
<i><font color=#4b5d50># Author:  Alex Plotnikov  (aplsimple@gmail.com)</font></i>
<i><font color=#4b5d50># Date:    06/16/2021</font></i>
<i><font color=#4b5d50># Brief:   Handles highlighting Tcl code.</font></i>
<i><font color=#4b5d50># License: MIT.</font></i>
<i><font color=#4b5d50>###########################################################</font></i>

<b><font color=#3a6797>package</font></b> provide hl_tcl 1.1.4
<a id=Common_data></a>
<i><font color=#4b5d50># ______________________ Common data ____________________ #</font></i>

<b><font color=#ca14ca>namespace</font></b> eval ::hl_tcl {

  <b><font color=#ca14ca>namespace</font></b> eval my {

    <b><font color=#3a6797>variable</font></b> data;  <b><font color=#3a6797>array</font></b> set data [<b><font color=#3a6797>list</font></b>]

    <i><font color=#4b5d50># Tcl commands</font></i>
    <b><font color=#3a6797>set</font></b> data(PROC_TCL) [<b><font color=#3a6797>lsort</font></b> [<b><font color=#3a6797>list</font></b> \
      <b><font color=#ca14ca>return</font></b> proc method self my coroutine yield yieldto constructor destructor \
      <b><font color=#ca14ca>break</font></b> continue namespace oo::define oo::class oo::objdefine oo::object test
    ]]
    <b><font color=#3a6797>set</font></b> data(CMD_TCL) [<b><font color=#3a6797>lsort</font></b> [<b><font color=#3a6797>list</font></b> \
      <b><font color=#3a6797>set</font></b> incr if else elseif string expr list lindex lrange llength lappend \
      <b><font color=#3a6797>lreplace</font></b> lsearch lassign append split info array dict foreach for while \
      <b><font color=#3a6797>switch</font></b> default linsert lsort lset lmap lrepeat catch variable \
      <b><font color=#3a6797>concat</font></b> format scan regexp regsub upvar uplevel try finally throw read eval \
      <b><font color=#3a6797>after</font></b> update error global puts file chan open close eof seek flush mixin \
      <b><font color=#3a6797>msgcat</font></b> gets rename glob fconfigure fblocked fcopy cd pwd mathfunc then \
      <b><font color=#3a6797>mathop</font></b> apply fileevent unset join next exec refchan package source \
      <b><font color=#3a6797>exit</font></b> vwait binary lreverse registry auto_execok subst encoding load \
      <b><font color=#3a6797>auto_load</font></b> tell auto_mkindex memory trace time clock timerate auto_qualify \
      <b><font color=#3a6797>auto_reset</font></b> socket bgerror oo::copy unload history tailcall \
      <b><font color=#3a6797>interp</font></b> parray pid transchan nextto unknown dde pkg_mkIndex zlib auto_import \
      <b><font color=#3a6797>pkg::create</font></b> tcl::prefix \
      <b><font color=#3a6797>http::config</font></b> http::geturl http::formatQuery http::reset http::wait \
      <b><font color=#3a6797>http::status</font></b> http::size http::code http::ncode http::meta http::data \
      <b><font color=#3a6797>http::error</font></b> http::cleanup http::register http::unregister * \
    ]]

    <i><font color=#4b5d50># Ttk commands</font></i>
    <b><font color=#3a6797>set</font></b> data(CMD_TTK) [<b><font color=#3a6797>list</font></b> \
      <b><font color=#134070>ttk::button</font></b> ttk::frame ttk::label ttk::entry ttk::checkbutton \
      <b><font color=#134070>ttk::radiobutton</font></b> ttk::combobox ttk::labelframe ttk::scrollbar \
      <b><font color=#134070>tk_optionMenu</font></b> ttk::menubutton ttk::style ttk::notebook ttk::panedwindow \
      <b><font color=#134070>ttk::separator</font></b> ttk::progressbar ttk::scale ttk::sizegrip ttk::spinbox \
      <b><font color=#134070>ttk::treeview</font></b> ttk::intro ttk::widget tk_focusNext tk_getOpenFile \
    ]

    <i><font color=#4b5d50># Tk commands</font></i>
    <b><font color=#3a6797>set</font></b> data(CMD_TK2) [<b><font color=#3a6797>list</font></b> \
      <b><font color=#134070>tk_popup</font></b> tk tkwait tkerror tk_setPalette tk_textCut tk_textCopy tk_bisque \
      <b><font color=#134070>tk_chooseDirectory</font></b> tk_textPaste ttk_vsapi tk_focusPrev tk_messageBox \
      <b><font color=#134070>tk_focusFollowsMouse</font></b> tk_getSaveFile tk_menuSetFocus tk_dialog tk_chooseColor \
    ]

    <i><font color=#4b5d50># Tk/ttk commands united</font></i>
    <b><font color=#3a6797>set</font></b> data(CMD_TK) [<b><font color=#3a6797>concat</font></b> <font color=#1b1baa>$data(CMD_TTK)</font> <font color=#1b1baa>$data(CMD_TK2)</font> [<b><font color=#3a6797>list</font></b> \
      <b><font color=#134070>button</font></b> entry checkbutton radiobutton label menubutton menu wm winfo bind \
      <b><font color=#134070>grid</font></b> pack event bell text canvas frame listbox grab scale scrollbar \
      <b><font color=#134070>labelframe</font></b> focus font bindtags image selection toplevel destroy \
      <b><font color=#134070>option</font></b> options spinbox bitmap photo keysyms send lower clipboard colors \
      <b><font color=#134070>console</font></b> message cursors panedwindow place raise \
    ]]

    <i><font color=#4b5d50># allowed edges of string (as one and only)</font></i>
    <b><font color=#3a6797>set</font></b> data(S_LEFT) [<b><font color=#3a6797>list</font></b> \{ \[]
    <b><font color=#3a6797>set</font></b> data(S_RIGHT) [<b><font color=#3a6797>list</font></b> \} \]]
    <i><font color=#4b5d50># allowed edges of string (as one or both)</font></i>
    <b><font color=#3a6797>set</font></b> data(S_SPACE) [<b><font color=#3a6797>list</font></b> {} { } \t {;}]
    <b><font color=#3a6797>set</font></b> data(S_SPACE2) [<b><font color=#3a6797>concat</font></b> <font color=#1b1baa>$data(S_SPACE)</font> [<b><font color=#3a6797>list</font></b> \{]]
    <b><font color=#3a6797>set</font></b> data(S_BOTH) [<b><font color=#3a6797>concat</font></b> <font color=#1b1baa>$data(S_SPACE)</font> [<b><font color=#3a6797>list</font></b> \&quot; \}]]

<i><font color=#4b5d50>#    set data(RE0) {(^|[\{\}\[;]+)\s*([:\w*]+)(\s|\]|\}|\\|$|;)}</font></i>
<i><font color=#4b5d50>#    set data(RE0) {(^|[\{\}\[;]+)\s*([:\w*]+)(\s|\]|\}|\\|$|;)?}</font></i>
    <b><font color=#3a6797>set</font></b> data(RE0) {(^|[\{\}\[;]+)\s*([:\w*]+)(\s|\]|\}|\\|$|;){0}} ;<i><font color=#4b5d50># test: pwd;pwd;pwd</font></i>
    <b><font color=#3a6797>set</font></b> data(RE1) {([\{\}\[;])+\s*([:\w*]+)(\s|\]|\}|\\|$)}
    <b><font color=#3a6797>set</font></b> data(RE5) {(^|[^\\])(\[|\]|\$|\{|\})}
    <b><font color=#3a6797>set</font></b> data(RETODO) {^\s*#\s*(!|TODO)}

    <b><font color=#3a6797>set</font></b> data(LBR) {\{(\[\&quot;}
    <b><font color=#3a6797>set</font></b> data(RBR) {\})\]\&quot;}

    <i><font color=#4b5d50># default syntax colors arrays (for a light & black themes)</font></i>
    <i><font color=#4b5d50>#  COM     COMTK    STR      VAR     CMN     PROC    OPT    BRAC</font></i>
    <b><font color=#3a6797>set</font></b> data(SYNTAXCOLORS,0) {
      {#121212 #000000 #0c560c #4A181B #606060 #923B23 #463e11 #FF0000}
      {#e0e0e0 #efefef #b1fabd #eebabf #888888 #ffa500 #c2ba8d #ff33ff}
    }
    <b><font color=#3a6797>set</font></b> data(SYNTAXCOLORS,1) {
      {#923B23 #7d1c00 #035103 #4A181B #4b5d50 #ca14ca #463e11 #FF0000}
      {#ffa500 #ff7e00 #90ee90 #f1b479 #76a396 #fe6efe #b9b96e #ff33ff}
    }
    <b><font color=#3a6797>set</font></b> data(SYNTAXCOLORS,2) {
      {#3a6797 #134070 #8b2a0e #1b1baa #4b5d50 #ca14ca #653760 #FF0000}
      {#95c2f2 #73a0d0 #ffc27e #a9a9f7 #76a396 #fe6efe #e2b4dd #ff33ff}
    }
    <b><font color=#3a6797>set</font></b> data(SYNTAXCOLORS,3) {
      {#2b6b2b #0b4b0b #8e0e8e #004080 #606060 #8a3407 #463e11 #FF0000}
      {#aad5ab #86c686 #ff86ff #96c5f8 #888888 #fab481 #b1a97c #ff33ff}
    }
  }
}
<a id=STATIC_highlighting></a>
<i><font color=#4b5d50># _________________________ STATIC highlighting _________________________ #</font></i>
<a id=my::AuxEnding></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::AuxEnding {kName lineName iName} {
  <i><font color=#4b5d50># Auxiliary procedure to process the ending comments in the line.</font></i>
  <i><font color=#4b5d50>#   kName - variable's name for 'k'</font></i>
  <i><font color=#4b5d50>#   lineName - variable's name for 'line'</font></i>
  <i><font color=#4b5d50>#   iName - variable's name for 'i'</font></i>
  <i><font color=#4b5d50># See also: HighlightLine</font></i>

  <b><font color=#3a6797>upvar</font></b> 1 <font color=#1b1baa>$kName</font> k <font color=#1b1baa>$lineName</font> line <font color=#1b1baa>$iName</font> i
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> k [<b><font color=#3a6797>string</font></b> first # <font color=#1b1baa>$line</font> <font color=#1b1baa>$i</font>]]&gt;-1 && \
  [<b><font color=#3a6797>string</font></b> index [<b><font color=#3a6797>string</font></b> trimleft <font color=#1b1baa>$line</font>] 0] eq {#}} {
    <b><font color=#ca14ca>return</font></b> 1
  }
  <i><font color=#4b5d50># not found a full line comment =&gt; try to find &quot;good&quot; ending comments i.e. &quot;;# ...&quot;</font></i>
  <i><font color=#4b5d50># at that even proper comments like</font></i>
  <i><font color=#4b5d50>#   if {cond} { #...</font></i>
  <i><font color=#4b5d50>#   }</font></i>
  <i><font color=#4b5d50># are skipped as &quot;bad&quot;</font></i>
  <b><font color=#3a6797>set</font></b> k [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>regexp</font></b> <font color=#653760>-inline</font> <font color=#653760>-indices</font> {;\s*#} [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$line</font> <font color=#1b1baa>$i</font> end]] 0 0]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$k</font> eq {}} {
    <b><font color=#3a6797>set</font></b> k -1
    <b><font color=#ca14ca>return</font></b> 0
  }
  <b><font color=#3a6797>set</font></b> k [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$k</font>+<font color=#1b1baa>$i</font>+1}]
  <b><font color=#ca14ca>return</font></b> 1
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::NotEscaped></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::NotEscaped {line i} {
  <i><font color=#4b5d50># Checks if a character escaped in a line.</font></i>
  <i><font color=#4b5d50>#   line - line</font></i>
  <i><font color=#4b5d50>#   i - the character's position in 'line'</font></i>
  <i><font color=#4b5d50># Returns &quot;1&quot; if the character not escaped.</font></i>

  <b><font color=#3a6797>set</font></b> cntq 0
  <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$i</font>&gt;0} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> [<b><font color=#3a6797>incr</font></b> i -1]] ne <font color=#8b2a0e>&quot;\\&quot;</font>} {
      <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {(<font color=#1b1baa>$cntq</font>%2)==0}]
    }
    <b><font color=#3a6797>incr</font></b> cntq
  }
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {(<font color=#1b1baa>$cntq</font>%2)==0}]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::RemoveTags></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::RemoveTags {txt from to} {
  <i><font color=#4b5d50># Removes tags in text.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   from - starting index</font></i>
  <i><font color=#4b5d50>#   to - ending index</font></i>

  <b><font color=#3a6797>foreach</font></b> tag {tagCOM tagCOMTK tagSTR tagVAR tagCMN tagCMN2 tagPROC tagOPT} {
    <font color=#1b1baa>$txt</font> tag remove <font color=#1b1baa>$tag</font> <font color=#1b1baa>$from</font> <font color=#1b1baa>$to</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightCmd></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::HighlightCmd {txt line ln pri i} {
  <i><font color=#4b5d50># Highlights Tcl/Tk commands.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   line - line to be highlighted</font></i>
  <i><font color=#4b5d50>#   ln - line number</font></i>
  <i><font color=#4b5d50>#   pri - column number to highlighted from</font></i>
  <i><font color=#4b5d50>#   i - current position in 'line'</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <font color=#1b1baa>$txt</font> tag add tagSTD <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>i +1 chars&quot;</font>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$pri</font>} {
    <b><font color=#3a6797>incr</font></b> pri -1
    <b><font color=#3a6797>set</font></b> RE <font color=#1b1baa>$data(RE1)</font>
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> RE <font color=#1b1baa>$data(RE0)</font>
  }
  <b><font color=#3a6797>set</font></b> st [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$line</font> <font color=#1b1baa>$pri</font> <font color=#1b1baa>$i</font>-1]
  <b><font color=#3a6797>set</font></b> lcom [<b><font color=#3a6797>regexp</font></b> <font color=#653760>-inline</font> <font color=#653760>-all</font> <font color=#653760>-indices</font> <font color=#1b1baa>$RE</font> <font color=#1b1baa>$st</font>]
  <i><font color=#4b5d50># commands</font></i>
  <b><font color=#3a6797>foreach</font></b> {- - lc -} <font color=#1b1baa>$lcom</font> {
    <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$lc</font> i1 i2
    <b><font color=#3a6797>set</font></b> c [<b><font color=#3a6797>string</font></b> trim [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$st</font> <font color=#1b1baa>$i1</font> <font color=#1b1baa>$i2</font>] <font color=#8b2a0e>&quot;\{\}\[;\t &quot;</font>]
    <b><font color=#3a6797>set</font></b> ik [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$i2</font>-<font color=#1b1baa>$i1</font>+1-[<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$c</font>]}]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$c</font> ne {}} {
      <b><font color=#3a6797>incr</font></b> i1 <font color=#1b1baa>$ik</font>
      <b><font color=#3a6797>incr</font></b> i2
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-exact</font> <font color=#653760>-sorted</font> <font color=#1b1baa>$data(CMD_TCL)</font> <font color=#1b1baa>$c</font>]&gt;-1} {
        <font color=#1b1baa>$txt</font> tag add tagCOM <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>i1 char&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>i2 char&quot;</font>
      } <b><font color=#3a6797>elseif</font></b> {[<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-exact</font> <font color=#653760>-sorted</font> <font color=#1b1baa>$data(PROC_TCL)</font> <font color=#1b1baa>$c</font>]&gt;-1} {
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$c</font> eq {<b><font color=#3a6797>namespace</font></b>} &&
        ![<b><font color=#3a6797>regexp</font></b> {^namespace[\s]+eval([\s]|$)+} [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$st</font> <font color=#1b1baa>$i1</font> end]]} {
          <b><font color=#3a6797>set</font></b> tag tagCOM ;<i><font color=#4b5d50># let &quot;namespace eval&quot; only be highlighted as proc/return</font></i>
        } <b><font color=#3a6797>else</font></b> {
          <b><font color=#3a6797>set</font></b> tag tagPROC
        }
        <font color=#1b1baa>$txt</font> tag add <font color=#1b1baa>$tag</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>i1 char&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>i2 char&quot;</font>
      } <b><font color=#3a6797>elseif</font></b> {[<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-exact</font> <font color=#653760>-sorted</font> <font color=#1b1baa>$data(CMD_TK_EXP)</font> <font color=#1b1baa>$c</font>]&gt;-1} {
        <font color=#1b1baa>$txt</font> tag add tagCOMTK <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>i1 char&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>i2 char&quot;</font>
      }
    }
  }
  <i><font color=#4b5d50># $variables:</font></i>
  <b><font color=#3a6797>set</font></b> dlist [<b><font color=#3a6797>list</font></b>]
  <b><font color=#3a6797>set</font></b> slen [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$st</font>]-1}]
  <b><font color=#3a6797>set</font></b> cnt [CountChar <font color=#1b1baa>$st</font> \$ dlist no]
  <b><font color=#3a6797>foreach</font></b> dl <font color=#1b1baa>$dlist</font> {
    <b><font color=#3a6797>if</font></b> { [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$dl</font>+1] eq <font color=#8b2a0e>&quot;\{&quot;</font> } {
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> br2 [<b><font color=#3a6797>string</font></b> first \} <font color=#1b1baa>$st</font> <font color=#1b1baa>$dl</font>+2]]!=-1} {
        <font color=#1b1baa>$txt</font> tag add tagVAR <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>dl char&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>[</font>incr br2<font color=#1b1baa>]</font> char&quot;</font>
      }
      <b><font color=#ca14ca>continue</font></b>
    }
    <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>set</font></b> dl2 <font color=#1b1baa>$dl</font>]} {<font color=#1b1baa>$i</font>&lt;<font color=#1b1baa>$slen</font>} {} {
      <b><font color=#3a6797>incr</font></b> i
      <b><font color=#3a6797>set</font></b> ch [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$i</font>]
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> is wordchar <font color=#1b1baa>$ch</font>] || <font color=#1b1baa>$ch</font> eq {:}} {
        <b><font color=#3a6797>set</font></b> dl2 <font color=#1b1baa>$i</font>
        <b><font color=#ca14ca>continue</font></b>
      } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$ch</font> eq {(}} {
        <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> br2 [<b><font color=#3a6797>string</font></b> first {)} <font color=#1b1baa>$st</font> <font color=#1b1baa>$i</font>+1]]&gt;-1} {
          <b><font color=#3a6797>set</font></b> dl2 <font color=#1b1baa>$br2</font>
        }
      }
      <b><font color=#ca14ca>break</font></b>
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dl2</font>&gt;<font color=#1b1baa>$dl</font>} {
      <font color=#1b1baa>$txt</font> tag add tagVAR <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>dl char&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>[</font>incr dl2<font color=#1b1baa>]</font> char&quot;</font>
    }
  }
  <i><font color=#4b5d50># -options</font></i>
  <b><font color=#3a6797>set</font></b> dl -1
  <b><font color=#3a6797>while</font></b> {[<b><font color=#3a6797>set</font></b> dl [<b><font color=#3a6797>string</font></b> first - <font color=#1b1baa>$st</font> [<b><font color=#3a6797>incr</font></b> dl]]]&gt;-1} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$dl</font>-1] ni <font color=#1b1baa>$data(S_SPACE2)</font>} <b><font color=#ca14ca>continue</font></b>
    <b><font color=#3a6797>set</font></b> idx1 <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>$</font>dl char&quot;</font>
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$dl</font>+1] eq {-}} {
      <b><font color=#3a6797>incr</font></b> dl ;<i><font color=#4b5d50># for --longoption</font></i>
    }
    <b><font color=#3a6797>set</font></b> i <font color=#1b1baa>$dl</font>
    <b><font color=#3a6797>set</font></b> ch [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$i</font>+1]
    <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>string</font></b> is alpha <font color=#653760>-strict</font> <font color=#1b1baa>$ch</font>]} { ;<i><font color=#4b5d50># || ![string is ascii -strict $ch]</font></i>
      <b><font color=#ca14ca>continue</font></b> ;<i><font color=#4b5d50># first, a Latin letter</font></i>
    }
    <b><font color=#3a6797>set</font></b> dl2 -1
    <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$i</font>&lt;<font color=#1b1baa>$slen</font>} {
      <b><font color=#3a6797>incr</font></b> i
      <b><font color=#3a6797>set</font></b> ch [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$i</font>]
      <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>string</font></b> is wordchar <font color=#1b1baa>$ch</font>] && <font color=#1b1baa>$ch</font> ne {-}} <b><font color=#ca14ca>break</font></b>
      <b><font color=#3a6797>set</font></b> dl2 <font color=#1b1baa>$i</font>
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dl2</font>&gt;-1} {
      <font color=#1b1baa>$txt</font> tag add tagOPT <font color=#1b1baa>$idx1</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>pri +<font color=#1b1baa>[</font>incr dl2<font color=#1b1baa>]</font> char&quot;</font>
      <b><font color=#3a6797>set</font></b> dl <font color=#1b1baa>$dl2</font>
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightStr></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::HighlightStr {txt p1 p2} {
  <i><font color=#4b5d50># Highlights strings.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   p1 - starting index of the string in 'txt'</font></i>
  <i><font color=#4b5d50>#   p2 - ending index of the string in 'txt'</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>set</font></b> p1 [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$p1</font>]
  <b><font color=#3a6797>set</font></b> p2 [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$p2</font>]
  <font color=#1b1baa>$txt</font> tag add tagSTR <font color=#1b1baa>$p1</font> <font color=#1b1baa>$p2</font>
  <b><font color=#3a6797>set</font></b> st [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$p1</font> <font color=#1b1baa>$p2</font>]
  <b><font color=#3a6797>set</font></b> lcom [<b><font color=#3a6797>regexp</font></b> <font color=#653760>-inline</font> <font color=#653760>-all</font> <font color=#653760>-indices</font> <font color=#1b1baa>$data(RE5)</font> <font color=#1b1baa>$st</font>]
  <b><font color=#3a6797>foreach</font></b> {lc g1 g2} <font color=#1b1baa>$lcom</font> {
    <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$lc</font> i1 i2
    <b><font color=#3a6797>incr</font></b> i2
    <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$i1</font>&lt;<font color=#1b1baa>$i2</font>} {
      <b><font color=#3a6797>incr</font></b> i1
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> first [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$st</font> <font color=#1b1baa>$i1</font>] <font color=#8b2a0e>&quot;\[\]\$\{\}&quot;</font>]&gt;-1} {
        <b><font color=#3a6797>set</font></b> i12 [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$i1</font>+1}]
        <font color=#1b1baa>$txt</font> tag add tagVAR <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>p1 +<font color=#1b1baa>$</font>i1 char&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>p1 +<font color=#1b1baa>$</font>i12 char&quot;</font>
      }
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::FirstQtd></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::FirstQtd {lineName iName currQtd} {
  <i><font color=#4b5d50># Searches the quote characters in line.</font></i>
  <i><font color=#4b5d50>#   lineName - variable's name for 'line'</font></i>
  <i><font color=#4b5d50>#   iName - variable's name for 'i'</font></i>
  <i><font color=#4b5d50>#   currQtd - yes, if searching inside the quoted</font></i>
  <i><font color=#4b5d50># Returns &quot;yes&quot; if a quote character was found.</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>upvar</font></b> 1 <font color=#1b1baa>$lineName</font> line <font color=#1b1baa>$iName</font> i
  <b><font color=#3a6797>while</font></b> {1} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>string</font></b> first \&quot; <font color=#1b1baa>$line</font> <font color=#1b1baa>$i</font>]]==-1} {<b><font color=#ca14ca>return</font></b> no}
    <b><font color=#3a6797>if</font></b> {[NotEscaped <font color=#1b1baa>$line</font> <font color=#1b1baa>$i</font>]} {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$currQtd</font>||<font color=#1b1baa>$i</font>==0} {<b><font color=#ca14ca>return</font></b> yes}
      <b><font color=#3a6797>set</font></b> i1 [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$i</font>-1}]
      <b><font color=#3a6797>set</font></b> i2 [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$i</font>+1}]
      <b><font color=#3a6797>if</font></b> {[NotEscaped <font color=#1b1baa>$line</font> <font color=#1b1baa>$i1</font>]} {
        <b><font color=#3a6797>set</font></b> c1 [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> <font color=#1b1baa>$i1</font>]  ;<i><font color=#4b5d50># check the string ends</font></i>
        <b><font color=#3a6797>set</font></b> c2 [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> <font color=#1b1baa>$i2</font>]
        <i><font color=#4b5d50># not needed: $c1 in $data(S_BOTH) && $c2 ni $data(S_BOTH) ||</font></i>
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$c1</font> in <font color=#1b1baa>$data(S_LEFT)</font> && <font color=#1b1baa>$c2</font> ni <font color=#1b1baa>$data(S_RIGHT)</font>
        || <font color=#1b1baa>$c1</font> ni <font color=#1b1baa>$data(S_LEFT)</font> && <font color=#1b1baa>$c2</font> in <font color=#1b1baa>$data(S_RIGHT)</font>} {
          <b><font color=#ca14ca>return</font></b> yes
        }
        <i><font color=#4b5d50># last reverence: for braced expression</font></i>
        <b><font color=#3a6797>set</font></b> i1 <font color=#1b1baa>$i</font>
        <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$i1</font>&gt;0} {
          <b><font color=#3a6797>set</font></b> c1 [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> <font color=#1b1baa>$i1</font>-1]
          <b><font color=#3a6797>set</font></b> c2 [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> <font color=#1b1baa>$i1</font>]
          <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$c1</font> in <font color=#1b1baa>$data(S_SPACE)</font>} {<b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> { <font color=#1b1baa>$c2</font> ne <font color=#8b2a0e>&quot;\{&quot;</font> }]}
          <b><font color=#3a6797>incr</font></b> i1 -1
        }
        <b><font color=#ca14ca>return</font></b> no
      }
      <b><font color=#ca14ca>return</font></b> yes
    }
    <b><font color=#3a6797>incr</font></b> i
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightComment></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::HighlightComment {txt line ln k} {
  <i><font color=#4b5d50># Highlights comments.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   line - current line</font></i>
  <i><font color=#4b5d50>#   ln - line's number</font></i>
  <i><font color=#4b5d50>#   k - comment's starting position in line</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>set</font></b> stcom [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$line</font> <font color=#1b1baa>$k</font> end]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>regexp</font></b> <font color=#1b1baa>$data(RETODO)</font> <font color=#1b1baa>$stcom</font>]} {
    <font color=#1b1baa>$txt</font> tag add tagCMN2 <font color=#1b1baa>$ln</font>.<font color=#1b1baa>$k</font> <font color=#1b1baa>$ln</font>.end  ;<i><font color=#4b5d50># &quot;!&quot; and TODO comments</font></i>
  } <b><font color=#3a6797>else</font></b> {
    <font color=#1b1baa>$txt</font> tag add tagCMN <font color=#1b1baa>$ln</font>.<font color=#1b1baa>$k</font> <font color=#1b1baa>$ln</font>.end
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightLine></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::HighlightLine {txt ln prevQtd} {
  <i><font color=#4b5d50># Highlights a line in text.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   ln - line's number</font></i>
  <i><font color=#4b5d50>#   prevQtd - flag of &quot;being quoted&quot; from the previous line</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$data(ISPLAINCOM,$txt)</font>} {
    <i><font color=#4b5d50># plain highlighting: for the current line</font></i>
    <b><font color=#3a6797>set</font></b> res [{<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$data(PLAINCOM,$txt)</font> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln</font> <font color=#1b1baa>$prevQtd</font>]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$res</font> in {-1 0 1}} {
      <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$res</font> ;<i><font color=#4b5d50># to be continued in a next line with prevQtd</font></i>
    }
    <i><font color=#4b5d50># if the line was highlighted okay, skip the highlighting as Tcl code</font></i>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$res</font>} {<b><font color=#ca14ca>return</font></b> 0}
    <i><font color=#4b5d50># otherwise highlight it below as Tcl code</font></i>
  }
  <b><font color=#3a6797>set</font></b> line [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$ln</font>.0 <font color=#1b1baa>$ln</font>.end]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$prevQtd</font>==-1} {  ;<i><font color=#4b5d50># comments continued</font></i>
    HighlightComment <font color=#1b1baa>$txt</font> <font color=#1b1baa>$line</font> <font color=#1b1baa>$ln</font> 0
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> end] ne <font color=#8b2a0e>&quot;\\&quot;</font>} {<b><font color=#3a6797>set</font></b> prevQtd 0}
    <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$prevQtd</font>
  }
  <b><font color=#3a6797>set</font></b> currQtd <font color=#1b1baa>$prevQtd</font>  ;<i><font color=#4b5d50># current state of being quoted</font></i>
  <b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>set</font></b> pri [<b><font color=#3a6797>set</font></b> lasti 0]]
  <b><font color=#3a6797>set</font></b> k -1
  <b><font color=#3a6797>while</font></b> {1} {
    <b><font color=#3a6797>if</font></b> {![FirstQtd line i <font color=#1b1baa>$currQtd</font>]} <b><font color=#ca14ca>break</font></b>
    <b><font color=#3a6797>set</font></b> lasti <font color=#1b1baa>$i</font>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$currQtd</font>} {
      HighlightStr <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln</font>.<font color=#1b1baa>$pri</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln.<font color=#1b1baa>$</font>i +1 char&quot;</font>
      <b><font color=#3a6797>set</font></b> currQtd 0
      <b><font color=#3a6797>incr</font></b> lasti
      <b><font color=#3a6797>if</font></b> {[AuxEnding j line lasti]} {
        <b><font color=#3a6797>set</font></b> i <font color=#1b1baa>$lasti</font>
        <b><font color=#3a6797>set</font></b> st [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$line</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$j</font>]
        <b><font color=#3a6797>set</font></b> it 0
        <b><font color=#3a6797>if</font></b> {[FirstQtd st it <font color=#1b1baa>$currQtd</font>]} <b><font color=#ca14ca>continue</font></b>  ;<i><font color=#4b5d50># there is a quote yet</font></i>
        <b><font color=#3a6797>set</font></b> k <font color=#1b1baa>$j</font>
        <b><font color=#ca14ca>break</font></b>
      }
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>if</font></b> {[AuxEnding j line pri] && <font color=#1b1baa>$j</font>&lt;<font color=#1b1baa>$i</font>} {
        <b><font color=#3a6797>set</font></b> lasti <font color=#1b1baa>$pri</font>
        <b><font color=#3a6797>set</font></b> k <font color=#1b1baa>$j</font>
        <b><font color=#ca14ca>break</font></b>
      }
      HighlightCmd <font color=#1b1baa>$txt</font> <font color=#1b1baa>$line</font> <font color=#1b1baa>$ln</font> <font color=#1b1baa>$pri</font> <font color=#1b1baa>$i</font>
      <b><font color=#3a6797>set</font></b> currQtd 1
    }
    <b><font color=#3a6797>set</font></b> pri <font color=#1b1baa>$i</font>
    <b><font color=#3a6797>incr</font></b> i
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$currQtd</font>} {
    HighlightStr <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln</font>.<font color=#1b1baa>$pri</font> <font color=#1b1baa>$ln</font>.end
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$k</font>&gt;-1 || [AuxEnding k line lasti]} {
    HighlightCmd <font color=#1b1baa>$txt</font> <font color=#1b1baa>$line</font> <font color=#1b1baa>$ln</font> <font color=#1b1baa>$lasti</font> <font color=#1b1baa>$k</font>
    HighlightComment <font color=#1b1baa>$txt</font> <font color=#1b1baa>$line</font> <font color=#1b1baa>$ln</font> <font color=#1b1baa>$k</font>
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> end] eq <font color=#8b2a0e>&quot;\\&quot;</font>} {<b><font color=#3a6797>set</font></b> currQtd -1}
  } <b><font color=#3a6797>else</font></b> {
    HighlightCmd <font color=#1b1baa>$txt</font> <font color=#1b1baa>$line</font> <font color=#1b1baa>$ln</font> <font color=#1b1baa>$lasti</font> [<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$line</font>]
  }
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$data(MULTILINE,$txt)</font> && <font color=#1b1baa>$currQtd</font> && [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$line</font> end] ne <font color=#8b2a0e>&quot;\\&quot;</font>} {
    <b><font color=#3a6797>set</font></b> currQtd 0
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$currQtd</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightAll></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::HighlightAll {txt} {
  <i><font color=#4b5d50># Highlights all of a text.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50># Makes a coroutine from this.</font></i>
  <i><font color=#4b5d50># See also: CoroHighlightAll</font></i>

  <i><font color=#4b5d50># let them work one by one:</font></i>
  <b><font color=#3a6797>set</font></b> coroNo [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>incr</font></b> ::hl_tcl::my::data(CORALL)] % 10000000}]
  <b><font color=#ca14ca>coroutine</font></b> co_HlAll<font color=#1b1baa>$coroNo</font> ::hl_tcl::my::CoroHighlightAll <font color=#1b1baa>$txt</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::CoroHighlightAll></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::CoroHighlightAll {txt} {
  <i><font color=#4b5d50># Highlights all of a text as a coroutine.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50># See also: HighlightAll</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>catch</font></b> {  ;<i><font color=#4b5d50># $txt may be destroyed, so catch this</font></i>
    <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$data(PLAINTEXT,$txt)</font>} {
      <b><font color=#3a6797>set</font></b> tlen [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>split</font></b> [<font color=#1b1baa>$txt</font> index end] .] 0]
      RemoveTags <font color=#1b1baa>$txt</font> 1.0 end
      <b><font color=#3a6797>set</font></b> maxl [<b><font color=#3a6797>expr</font></b> {min(<font color=#1b1baa>$data(SEEN,$txt)</font>,<font color=#1b1baa>$tlen</font>)}]
      <b><font color=#3a6797>set</font></b> maxl [<b><font color=#3a6797>expr</font></b> {min(<font color=#1b1baa>$data(SEEN,$txt)</font>,<font color=#1b1baa>$tlen</font>)}]
      <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> currQtd [<b><font color=#3a6797>set</font></b> ln [<b><font color=#3a6797>set</font></b> lnseen 0]]} {<font color=#1b1baa>$ln</font>&lt;<font color=#1b1baa>$tlen</font>} {} {
        <b><font color=#3a6797>incr</font></b> ln
        <b><font color=#3a6797>set</font></b> currQtd [HighlightLine <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln</font> <font color=#1b1baa>$currQtd</font>]
        <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>incr</font></b> lnseen]&gt;<font color=#1b1baa>$data(SEEN,$txt)</font>} {
          <b><font color=#3a6797>set</font></b> lnseen 0
          <b><font color=#3a6797>after</font></b> idle after 1 [<b><font color=#3a6797>info</font></b> coroutine]
          <b><font color=#ca14ca>yield</font></b>
        }
      }
    }
  }
  <b><font color=#3a6797>set</font></b> data(REG_TXT,<font color=#1b1baa>$txt</font>) {1}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::BindToEvent></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::BindToEvent {w event args} {
  <i><font color=#4b5d50># Binds an event on a widget to a command.</font></i>
  <i><font color=#4b5d50>#   w - the widget's path</font></i>
  <i><font color=#4b5d50>#   event - the event</font></i>
  <i><font color=#4b5d50>#   args - the command</font></i>

  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> first <font color=#1b1baa>$args</font> [<b><font color=#134070>bind</font></b> <font color=#1b1baa>$w</font> <font color=#1b1baa>$event</font>]]&lt;0} {
    <b><font color=#134070>bind</font></b> <font color=#1b1baa>$w</font> <font color=#1b1baa>$event</font> [<b><font color=#3a6797>list</font></b> + {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>]
  }
  <b><font color=#ca14ca>return</font></b>
}
<a id=DYNAMIC_highlighting></a>
<i><font color=#4b5d50># _________________________ DYNAMIC highlighting ________________________ #</font></i>
<a id=my::CountQSH></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::CountQSH {txt ln} {
  <i><font color=#4b5d50># Counts quotes, slashes, hashes in a line</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   ln - line's index</font></i>

  <b><font color=#3a6797>set</font></b> ln [<b><font color=#3a6797>expr</font></b> {int(<font color=#1b1baa>$ln</font>)}]
  <b><font color=#3a6797>set</font></b> st [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$ln</font>.0 <font color=#1b1baa>$ln</font>.end]
  <b><font color=#3a6797>list</font></b> [CountChar <font color=#1b1baa>$st</font> \&quot;] [CountChar <font color=#1b1baa>$st</font> \\] [CountChar <font color=#1b1baa>$st</font> #]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::IsCurline></a>
<b><font color=#ca14ca>proc</font></b> hl_tcl::my::IsCurline {txt {flag <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Sets / gets &quot;highlight a current line&quot; flag for a text.</font></i>
  <i><font color=#4b5d50>#   txt - the text's path</font></i>
  <i><font color=#4b5d50>#   flag - the flag</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$flag</font> eq {}} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists data(HL_CURLINE,<font color=#1b1baa>$txt</font>)]} {
      <b><font color=#3a6797>set</font></b> flag <font color=#1b1baa>$data(HL_CURLINE,$txt)</font>
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> flag 0
    }
    <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$flag</font>
  }
  <b><font color=#3a6797>set</font></b> data(HL_CURLINE,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$flag</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::ShowCurrentLine></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::ShowCurrentLine {txt {doit no}} {
  <i><font color=#4b5d50># Shows the current line.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   doit - if yes, forces updating current line's background</font></i>
  <i><font color=#4b5d50># Returns a current position of cursor.</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>set</font></b> pos [<font color=#1b1baa>$txt</font> index insert]
  <b><font color=#3a6797>set</font></b> nlines [<b><font color=#3a6797>expr</font></b> {int([<font color=#1b1baa>$txt</font> index end])}]
  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$pos</font> .] ln cn
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$data(CURPOS,$txt)</font> .] ln2 cn2}]} {
    <b><font color=#3a6797>set</font></b> ln2 <font color=#1b1baa>$ln</font>
    <b><font color=#3a6797>set</font></b> cn2 <font color=#1b1baa>$cn</font>
    <b><font color=#3a6797>set</font></b> data(CURPOS,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>set</font></b> data(NLINES,<font color=#1b1baa>$txt</font>) 0]
  }
  <b><font color=#3a6797>if</font></b> {[IsCurline <font color=#1b1baa>$txt</font>]} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$doit</font> || int(<font color=#1b1baa>$data(CURPOS,$txt)</font>)!=<font color=#1b1baa>$ln</font> || <font color=#1b1baa>$data(NLINES,$txt)</font>!=<font color=#1b1baa>$nlines</font> \
    || <font color=#1b1baa>$ln</font>!=<font color=#1b1baa>$ln2</font> || abs(<font color=#1b1baa>$cn</font>-<font color=#1b1baa>$cn2</font>)&gt;1 || <font color=#1b1baa>$cn</font>&lt;2} {
      <font color=#1b1baa>$txt</font> tag remove tagCURLINE 1.0 end
      <font color=#1b1baa>$txt</font> tag add tagCURLINE [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$pos</font> linestart] [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$pos</font> lineend]+1displayindices
    }
  }
  <b><font color=#3a6797>set</font></b> data(NLINES,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$nlines</font>
  <b><font color=#3a6797>set</font></b> data(CURPOS,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$pos</font>
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$pos</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::MemPos1></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::MemPos1 {txt {donorm yes} {K <font color=#8b2a0e>&quot;&quot;</font>} {s <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Checks and sets the cursor's width, depending on its position.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   donorm - if yes, forces &quot;normal&quot; cursor</font></i>
  <i><font color=#4b5d50>#   K - key (%K of bind)</font></i>
  <i><font color=#4b5d50>#   s - state (%s of bind)</font></i>
  <i><font color=#4b5d50># This fixes an issue with text cursor: less width at 0th column.</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$K</font> eq {Home} && [<b><font color=#3a6797>string</font></b> is digit <font color=#653760>-strict</font> <font color=#1b1baa>$s</font>] && \
  [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$s</font> & 4}]==0 && [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$s</font> & 1}]==0} {
    <i><font color=#4b5d50># Ctrl-Home & Shift-Home are passed</font></i>
    <b><font color=#3a6797>set</font></b> p1 [<font color=#1b1baa>$txt</font> index insert]
    <b><font color=#3a6797>set</font></b> line [<font color=#1b1baa>$txt</font> get <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>p1 linestart&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>p1 lineend&quot;</font>]
    <b><font color=#3a6797>set</font></b> p [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$line</font>]-[<b><font color=#3a6797>string</font></b> length [<b><font color=#3a6797>string</font></b> trimleft <font color=#1b1baa>$line</font>]]}]
    <b><font color=#3a6797>set</font></b> p2 [<b><font color=#3a6797>expr</font></b> {int(<font color=#1b1baa>$p1</font>)}].<font color=#1b1baa>$p</font>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$p</font> && <font color=#1b1baa>$p2</font> ne <font color=#1b1baa>$p1</font>} {
      <b><font color=#3a6797>after</font></b> idle <font color=#8b2a0e>&quot;::tk::TextSetCursor <font color=#1b1baa>$</font>txt <font color=#1b1baa>$</font>p2&quot;</font>
      <b><font color=#ca14ca>return</font></b> 0
    }
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$data(INSERTWIDTH,$txt)</font>==1} {
    <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$txt</font> cget <font color=#653760>-insertwidth</font>]!=1} {<font color=#1b1baa>$txt</font> configure <font color=#653760>-insertwidth</font> 1}
    <b><font color=#ca14ca>return</font></b> 0
  }
  <b><font color=#3a6797>set</font></b> insLC [<font color=#1b1baa>$txt</font> index insert]
  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$insLC</font> .] L C
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$data(_INSPOS_,$txt)</font> eq {}} {
    <b><font color=#3a6797>set</font></b> L2 [<b><font color=#3a6797>set</font></b> C2 0]
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$data(_INSPOS_,$txt)</font> .] L2 C2
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$L</font>!=<font color=#1b1baa>$L2</font> || <font color=#1b1baa>$C</font>==0 || <font color=#1b1baa>$C2</font>==0} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$C</font> || <font color=#1b1baa>$donorm</font>} {
      <font color=#1b1baa>$txt</font> configure <font color=#653760>-insertwidth</font> <font color=#1b1baa>$data(INSERTWIDTH,$txt)</font>
    } <b><font color=#3a6797>else</font></b> {
      <font color=#1b1baa>$txt</font> configure <font color=#653760>-insertwidth</font> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$data(INSERTWIDTH,$txt)</font>*2-1}]
    }
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$insLC</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::MemPos></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::MemPos {txt {doit no}} {
  <i><font color=#4b5d50># Remembers the state of current line.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   doit - argument for ShowCurrentLine</font></i>
  <i><font color=#4b5d50># See also: ShowCurrentLine</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>catch</font></b> {
    <b><font color=#3a6797>set</font></b> data(_INSPOS_,<font color=#1b1baa>$txt</font>) [MemPos1 <font color=#1b1baa>$txt</font> no]
    <b><font color=#3a6797>set</font></b> ln [ShowCurrentLine <font color=#1b1baa>$txt</font> <font color=#1b1baa>$doit</font>]
    <b><font color=#3a6797>set</font></b> data(CUR_LEN,<font color=#1b1baa>$txt</font>) [<font color=#1b1baa>$txt</font> index {end -1 char}]
    <b><font color=#3a6797>lassign</font></b> [CountQSH <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln</font>] \
      data(CNT_QUOTE,<font color=#1b1baa>$txt</font>) data(CNT_SLASH,<font color=#1b1baa>$txt</font>) data(CNT_COMMENT,<font color=#1b1baa>$txt</font>)
    <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$txt</font> tag ranges tagBRACKET] ne {}}    {<font color=#1b1baa>$txt</font> tag remove tagBRACKET 1.0 end}
    <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$txt</font> tag ranges tagBRACKETERR] ne {}} {<font color=#1b1baa>$txt</font> tag remove tagBRACKETERR 1.0 end}
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> cmd <font color=#1b1baa>$data(CMDPOS,$txt)</font>] ne {}} {
      <i><font color=#4b5d50># run a command after changing position (with the state as arguments)</font></i>
      <b><font color=#3a6797>append</font></b> cmd <font color=#8b2a0e>&quot; <font color=#1b1baa>$</font>txt <font color=#1b1baa>$</font>data(CUR_LEN,<font color=#1b1baa>$</font>txt) <font color=#1b1baa>$</font>ln <font color=#1b1baa>$</font>data(CNT_QUOTE,<font color=#1b1baa>$</font>txt) \</font>
<font color=#8b2a0e>        <font color=#1b1baa>$</font>data(CNT_SLASH,<font color=#1b1baa>$</font>txt) <font color=#1b1baa>$</font>data(CNT_COMMENT,<font color=#1b1baa>$</font>txt)&quot;</font>
      <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>after</font></b> cancel <font color=#1b1baa>$data(CMDATFER,$txt)</font>}
      <b><font color=#3a6797>set</font></b> data(CMDATFER,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>after</font></b> idle <font color=#1b1baa>$cmd</font>]
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::RunCoroAfterIdle></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::RunCoroAfterIdle {txt pos1 pos2 wait args} {
  <i><font color=#4b5d50># Runs a &quot;modified&quot; corotine after idle.</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wait</font>} {
    <b><font color=#3a6797>catch</font></b> {
      <b><font color=#3a6797>after</font></b> cancel <font color=#1b1baa>$data(COROAFTER,$txt)</font>
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$data(COROPOS1,$txt)</font> &lt; <font color=#1b1baa>$pos1</font>} {<b><font color=#3a6797>set</font></b> pos1 <font color=#1b1baa>$data(COROPOS1,$txt)</font>}
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$data(COROPOS2,$txt)</font> &gt; <font color=#1b1baa>$pos2</font>} {<b><font color=#3a6797>set</font></b> pos2 <font color=#1b1baa>$data(COROPOS2,$txt)</font>}
    }
    <b><font color=#3a6797>set</font></b> data(COROPOS1,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$pos1</font>
    <b><font color=#3a6797>set</font></b> data(COROPOS2,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$pos2</font>
  }
  <b><font color=#3a6797>set</font></b> data(COROAFTER,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>after</font></b> idle <font color=#8b2a0e>&quot;::hl_tcl::my::CoroRun <font color=#1b1baa>$</font>txt <font color=#1b1baa>$</font>pos1 <font color=#1b1baa>$</font>pos2 <font color=#1b1baa>$</font>args&quot;</font>]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::Modified></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::Modified {txt oper pos1 args} {
  <i><font color=#4b5d50># Handles modifications of text.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50># Makes a coroutine from this.</font></i>
  <i><font color=#4b5d50># See also: CoroModified</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>set</font></b> ar2 [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$args</font> 0]
  <b><font color=#3a6797>set</font></b> posins [<font color=#1b1baa>$txt</font> index insert]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> pos1 [<b><font color=#3a6797>set</font></b> pos2 [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$pos1</font>]]}]} {
    <b><font color=#3a6797>set</font></b> pos1 [<b><font color=#3a6797>set</font></b> pos2 <font color=#1b1baa>$posins</font>]
  }
  <b><font color=#3a6797>switch</font></b> <font color=#1b1baa>$oper</font> {
    insert {
      <b><font color=#3a6797>set</font></b> pos2 [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$pos1</font> + [<b><font color=#3a6797>llength</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$ar2</font> \n]]}]
    }
    delete {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ar2</font> eq {} || [<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> pos2 [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$ar2</font>]}]} {
        <b><font color=#3a6797>set</font></b> pos2 <font color=#1b1baa>$posins</font>
      }
    }
  }
  RunCoroAfterIdle <font color=#1b1baa>$txt</font> <font color=#1b1baa>$pos1</font> <font color=#1b1baa>$pos2</font> no {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::CoroRun></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::CoroRun {txt pos1 pos2 args} {

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exist data(REG_TXT,<font color=#1b1baa>$txt</font>)] || <font color=#1b1baa>$data(REG_TXT,$txt)</font> eq {} || \
  ![<b><font color=#3a6797>info</font></b> exist data(CUR_LEN,<font color=#1b1baa>$txt</font>)]} {
    <i><font color=#4b5d50># skip changes till the highlighting done</font></i>
    <b><font color=#3a6797>after</font></b> 10 [<b><font color=#3a6797>list</font></b> ::hl_tcl::my::RunCoroAfterIdle <font color=#1b1baa>$txt</font> <font color=#1b1baa>$pos1</font> <font color=#1b1baa>$pos2</font> yes {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>]
    <b><font color=#ca14ca>return</font></b>
  }
  <i><font color=#4b5d50># let them work one by one</font></i>
  <b><font color=#3a6797>set</font></b> i1 [<b><font color=#3a6797>expr</font></b> {int(<font color=#1b1baa>$pos1</font>)}]
  <b><font color=#3a6797>set</font></b> i2 [<b><font color=#3a6797>expr</font></b> {int(<font color=#1b1baa>$pos2</font>)}]
  <b><font color=#3a6797>set</font></b> coroNo [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>incr</font></b> data(CORMOD)] % 10000000}]
  <b><font color=#ca14ca>coroutine</font></b> CoModified<font color=#1b1baa>$coroNo</font> ::hl_tcl::my::CoroModified <font color=#1b1baa>$txt</font> <font color=#1b1baa>$i1</font> <font color=#1b1baa>$i2</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::CoroModified></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::CoroModified {txt {i1 -1} {i2 -1} args} {
  <i><font color=#4b5d50># Handles modifications of text.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   i1 - 1st index of changes</font></i>
  <i><font color=#4b5d50>#   i2 - 2nd index of changes</font></i>
  <i><font color=#4b5d50>#   args - arguments for a command called after the modifications</font></i>
  <i><font color=#4b5d50># See also: Modified</font></i>

  <b><font color=#3a6797>catch</font></b> {
    <b><font color=#3a6797>variable</font></b> data
    <i><font color=#4b5d50># current line:</font></i>
    <b><font color=#3a6797>set</font></b> ln [<b><font color=#3a6797>expr</font></b> {int([<font color=#1b1baa>$txt</font> index insert])}]
    <i><font color=#4b5d50># ending line:</font></i>
    <b><font color=#3a6797>set</font></b> endl [<b><font color=#3a6797>expr</font></b> {int([<font color=#1b1baa>$txt</font> index {end -1 char}])}]
    <i><font color=#4b5d50># range of change:</font></i>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i1</font>!=-1} {
      <b><font color=#3a6797>set</font></b> dl [<b><font color=#3a6797>expr</font></b> {abs(<font color=#1b1baa>$i2</font>-<font color=#1b1baa>$i1</font>)}]
      <b><font color=#3a6797>set</font></b> ln <font color=#1b1baa>$i1</font>
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> dl [<b><font color=#3a6797>expr</font></b> {abs(int(<font color=#1b1baa>$data(CUR_LEN,$txt)</font>) - <font color=#1b1baa>$endl</font>)}]
    }
    <i><font color=#4b5d50># begin and end of changes:</font></i>
    <b><font color=#3a6797>set</font></b> ln1 [<b><font color=#3a6797>set</font></b> lno1 [<b><font color=#3a6797>expr</font></b> {max((<font color=#1b1baa>$ln</font>-<font color=#1b1baa>$dl</font>),1)}]]
    <b><font color=#3a6797>set</font></b> ln2 [<b><font color=#3a6797>set</font></b> lno2 [<b><font color=#3a6797>expr</font></b> {min((<font color=#1b1baa>$ln</font>+<font color=#1b1baa>$dl</font>),<font color=#1b1baa>$endl</font>)}]]
    <b><font color=#3a6797>lassign</font></b> [CountQSH <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln</font>] cntq cnts ccmnt
    <i><font color=#4b5d50># flag &quot;highlight to the end&quot;:</font></i>
    <b><font color=#3a6797>set</font></b> bf1 [<b><font color=#3a6797>expr</font></b> {abs(<font color=#1b1baa>$ln</font>-int(<font color=#1b1baa>$data(CURPOS,$txt)</font>))&gt;1 || <font color=#1b1baa>$dl</font>&gt;1 \
    || <font color=#1b1baa>$cntq</font>!=<font color=#1b1baa>$data(CNT_QUOTE,$txt)</font> \
    || <font color=#1b1baa>$ccmnt</font>!=<font color=#1b1baa>$data(CNT_COMMENT,$txt)</font>}]
    <b><font color=#3a6797>set</font></b> bf2 [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$cnts</font>!=<font color=#1b1baa>$data(CNT_SLASH,$txt)</font>}]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$bf1</font> && !<font color=#1b1baa>$data(MULTILINE,$txt)</font> || <font color=#1b1baa>$bf2</font>} {
      <b><font color=#3a6797>set</font></b> lnt1 <font color=#1b1baa>$ln</font>
      <b><font color=#3a6797>set</font></b> lnt2 [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$ln</font>+1}]
      <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$ln2</font>&lt;<font color=#1b1baa>$endl</font> && <font color=#1b1baa>$lnt1</font>&lt;<font color=#1b1baa>$endl</font> && <font color=#1b1baa>$lnt2</font>&lt;=<font color=#1b1baa>$endl</font> && ( \
      [<font color=#1b1baa>$txt</font> get <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>lnt1.end -1 char&quot;</font> <font color=#1b1baa>$lnt1</font>.end] in {\\ \&quot;} ||
      [<font color=#1b1baa>$txt</font> get <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>lnt2.end -1 char&quot;</font> <font color=#1b1baa>$lnt2</font>.end] in {\\ \&quot;}) || <font color=#1b1baa>$bf2</font>} {
        <b><font color=#3a6797>incr</font></b> lnt1 ;<i><font color=#4b5d50># next lines be handled too, if ended with &quot;\\&quot;</font></i>
        <b><font color=#3a6797>incr</font></b> lnt2
        <b><font color=#3a6797>incr</font></b> ln2
        <b><font color=#3a6797>set</font></b> bf2 0
      }
    }
    <b><font color=#3a6797>set</font></b> tSTR [<font color=#1b1baa>$txt</font> tag ranges tagSTR]
    <b><font color=#3a6797>set</font></b> tCMN [<font color=#1b1baa>$txt</font> tag ranges tagCMN]
    <b><font color=#3a6797>lappend</font></b> tCMN {<b><font color=#3a6797>*</font></b>}[<font color=#1b1baa>$txt</font> tag ranges tagCMN2]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ln1</font>==1} {
      <b><font color=#3a6797>set</font></b> currQtd 0
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> currQtd [LineState <font color=#1b1baa>$txt</font> <font color=#1b1baa>$tSTR</font> <font color=#1b1baa>$tCMN</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln1.0 -1 chars&quot;</font>]
    }
    <font color=#1b1baa>$txt</font> tag add tagSTD <font color=#1b1baa>$ln1</font>.0 <font color=#1b1baa>$ln2</font>.end
    <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$data(PLAINTEXT,$txt)</font>} {
      <b><font color=#3a6797>set</font></b> lnseen 0
      <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$ln1</font>&lt;=<font color=#1b1baa>$ln2</font>} {
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ln1</font>==<font color=#1b1baa>$ln2</font>} {
          <b><font color=#3a6797>set</font></b> bf2 [LineState <font color=#1b1baa>$txt</font> <font color=#1b1baa>$tSTR</font> <font color=#1b1baa>$tCMN</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>ln1.end +1 chars&quot;</font>]
        }
        RemoveTags <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln1</font>.0 <font color=#1b1baa>$ln1</font>.end
        <b><font color=#3a6797>set</font></b> currQtd [HighlightLine <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln1</font> <font color=#1b1baa>$currQtd</font>]
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ln1</font>==<font color=#1b1baa>$ln2</font> && (<font color=#1b1baa>$bf1</font> || <font color=#1b1baa>$bf2</font>!=<font color=#1b1baa>$currQtd</font>) && <font color=#1b1baa>$data(MULTILINE,$txt)</font>} {
          <b><font color=#3a6797>set</font></b> ln2 <font color=#1b1baa>$endl</font>  ;<i><font color=#4b5d50># run to the end</font></i>
        }
        <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>incr</font></b> lnseen]&gt;<font color=#1b1baa>$data(SEEN,$txt)</font>} {
          <b><font color=#3a6797>set</font></b> lnseen 0
          <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>after</font></b> cancel <font color=#1b1baa>$data(COROATFER,$txt)</font>}
          <b><font color=#3a6797>set</font></b> data(COROATFER,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>after</font></b> idle after 1 [<b><font color=#3a6797>info</font></b> coroutine]]
          <b><font color=#ca14ca>yield</font></b>
        }
        <b><font color=#3a6797>incr</font></b> ln1
      }
    }
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> cmd <font color=#1b1baa>$data(CMD,$txt)</font>] ne {}} {
      <i><font color=#4b5d50># run a command after changes done (its arguments are txt, ln1, ln2)</font></i>
      <b><font color=#3a6797>append</font></b> cmd { } <font color=#1b1baa>$txt</font> { } <font color=#1b1baa>$lno1</font> { } <font color=#1b1baa>$lno2</font> { } <font color=#1b1baa>$args</font>
      <b><font color=#3a6797>after</font></b> idle <font color=#1b1baa>$cmd</font>
    }
    MemPos <font color=#1b1baa>$txt</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::InRange></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::InRange {p1 p2 l {c -1}} {
  <i><font color=#4b5d50># Checks if a text position is in a range of text positions.</font></i>
  <i><font color=#4b5d50>#   p1 - 1st position of range</font></i>
  <i><font color=#4b5d50>#   p2 - 2nd position of range</font></i>
  <i><font color=#4b5d50>#   l - line position to check (or 'l.c' if 'c' not set)</font></i>
  <i><font color=#4b5d50>#   c - column position to check</font></i>

  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$c</font>==-1} {<b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$l</font> .] l c}
  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$p1</font> .] l1 c1
  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$p2</font> .] l2 c2
  <b><font color=#3a6797>incr</font></b> c2 -1 ;<i><font color=#4b5d50># text ranges are not right-inclusive</font></i>
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> { \
    (<font color=#1b1baa>$l</font>&gt;=<font color=#1b1baa>$l1</font> && <font color=#1b1baa>$l</font>&lt;<font color=#1b1baa>$l2</font> && <font color=#1b1baa>$c</font>&gt;=<font color=#1b1baa>$c1</font>) || (<font color=#1b1baa>$l</font>&gt;<font color=#1b1baa>$l1</font> && <font color=#1b1baa>$l</font>&lt;=<font color=#1b1baa>$l2</font> && <font color=#1b1baa>$c</font>&lt;=<font color=#1b1baa>$c2</font>) ||
    (<font color=#1b1baa>$l</font>==<font color=#1b1baa>$l1</font> && <font color=#1b1baa>$l1</font>==<font color=#1b1baa>$l2</font> && <font color=#1b1baa>$c</font>&gt;=<font color=#1b1baa>$c1</font> && <font color=#1b1baa>$c</font>&lt;=<font color=#1b1baa>$c2</font>) || (<font color=#1b1baa>$l</font>&gt;<font color=#1b1baa>$l1</font> && <font color=#1b1baa>$l</font>&lt;<font color=#1b1baa>$l2</font>)}]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::SearchTag></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::SearchTag {tagpos l1} {
  <i><font color=#4b5d50># Searches a position in tag ranges.</font></i>
  <i><font color=#4b5d50>#   tagpos - tag position ranges</font></i>
  <i><font color=#4b5d50>#   l1 - the position to find</font></i>
  <i><font color=#4b5d50># Returns a found range's index of -1 if not found.</font></i>

  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$l1</font> .] l c
  <b><font color=#3a6797>set</font></b> i 0
  <b><font color=#3a6797>foreach</font></b> {p1 p2} <font color=#1b1baa>$tagpos</font> {
    <b><font color=#3a6797>if</font></b> {[InRange <font color=#1b1baa>$p1</font> <font color=#1b1baa>$p2</font> <font color=#1b1baa>$l</font> <font color=#1b1baa>$c</font>]} {<b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$i</font>}
    <b><font color=#3a6797>incr</font></b> i 2
  }
  <b><font color=#ca14ca>return</font></b> -1
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::LineState></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::LineState {txt tSTR tCMN l1} {
  <i><font color=#4b5d50># Gets an initial state of line.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   tSTR - ranges of string tags</font></i>
  <i><font color=#4b5d50>#   tCMN - ranges of comment tags</font></i>
  <i><font color=#4b5d50>#   l1 - the line's index</font></i>
  <i><font color=#4b5d50># Returns: 0 if no tags for the line; 1 if the line is a string's continuation; -1 if the line is a comment's continuation.</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>set</font></b> i1 [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$l1</font>]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> prev [<b><font color=#3a6797>string</font></b> first -1 <font color=#1b1baa>$l1</font>]]&gt;-1} {
    <b><font color=#3a6797>set</font></b> i1 [<font color=#1b1baa>$txt</font> index <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i1 -1 chars&quot;</font>]
  }
  <b><font color=#3a6797>set</font></b> ch [<font color=#1b1baa>$txt</font> get <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i1&quot;</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i1 +1 chars&quot;</font>]
  <b><font color=#3a6797>if</font></b> {[SearchTag <font color=#1b1baa>$tCMN</font> [<font color=#1b1baa>$txt</font> index <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i1 -1 chars&quot;</font>]]!=-1} {  ;<i><font color=#4b5d50># is a comment continues?</font></i>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ch</font> eq <font color=#8b2a0e>&quot;\\&quot;</font>} {<b><font color=#ca14ca>return</font></b> -1}
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$data(MULTILINE,$txt)</font> || <font color=#1b1baa>$ch</font> eq <font color=#8b2a0e>&quot;\\&quot;</font>} {         ;<i><font color=#4b5d50># is a string continues?</font></i>
    <b><font color=#3a6797>set</font></b> nl [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$l1</font> .] 0]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$prev</font>&gt;-1} {
      <i><font color=#4b5d50># is the start of line quoted?</font></i>
      <i><font color=#4b5d50># Tk tag ranges refer only to non-empty lines</font></i>
      <i><font color=#4b5d50># =&gt; previous two non-empty chars' coordinates are needed</font></i>
      <i><font color=#4b5d50># to analize whether they:</font></i>
      <i><font color=#4b5d50># - end the range</font></i>
      <i><font color=#4b5d50># - are inside of the range</font></i>
      <i><font color=#4b5d50># - begin the range</font></i>
      <b><font color=#3a6797>set</font></b> co1 [<b><font color=#3a6797>set</font></b> co2 {}]
      <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$nl</font>&gt;1} {
        <b><font color=#3a6797>incr</font></b> nl -1
        <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> line [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$nl</font>.0 <font color=#1b1baa>$nl</font>.end]] ne {}} {
          <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$co2</font> eq {}} {
            <b><font color=#3a6797>set</font></b> co2 [<font color=#1b1baa>$txt</font> index <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>nl.end -1 char&quot;</font>]
            <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$line</font>]&gt;1} {
              <b><font color=#3a6797>set</font></b> co1 [<font color=#1b1baa>$txt</font> index <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>nl.end -2 char&quot;</font>]
              <b><font color=#ca14ca>break</font></b>
            }
          } <b><font color=#3a6797>else</font></b> {
            <b><font color=#3a6797>set</font></b> co1 [<font color=#1b1baa>$txt</font> index <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>nl.end -1 char&quot;</font>]
            <b><font color=#ca14ca>break</font></b>
          }
        }
      }
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$co2</font> eq {}} {<b><font color=#ca14ca>return</font></b> 0}   {<b><font color=#3a6797>set</font></b> f2 [<b><font color=#3a6797>expr</font></b> {[SearchTag <font color=#1b1baa>$tSTR</font> <font color=#1b1baa>$co2</font>]!=-1}]}
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$co1</font> eq {}} {<b><font color=#3a6797>set</font></b> f1 <font color=#1b1baa>$f2</font>} {<b><font color=#3a6797>set</font></b> f1 [<b><font color=#3a6797>expr</font></b> {[SearchTag <font color=#1b1baa>$tSTR</font> <font color=#1b1baa>$co1</font>]!=-1}]}
      <b><font color=#3a6797>set</font></b> ch [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$co2</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>co2 +1 chars&quot;</font>]
      <b><font color=#3a6797>set</font></b> c [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>split</font></b> [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$co2</font>] .] 1]
      <b><font color=#3a6797>if</font></b> {![NotEscaped <font color=#1b1baa>$line</font> <font color=#1b1baa>$c</font>]} {<b><font color=#3a6797>set</font></b> ch {}}
      <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$ch</font> ne {&quot;} && <font color=#1b1baa>$f2</font> || <font color=#1b1baa>$ch</font> eq {&quot;} && !<font color=#1b1baa>$f1</font>}]
    }
    <i><font color=#4b5d50># is the end of line quoted?</font></i>
    <b><font color=#3a6797>set</font></b> line {}
    <b><font color=#3a6797>set</font></b> nltot [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>split</font></b> [<font color=#1b1baa>$txt</font> index end] .] 0]
    <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$nl</font>&lt;<font color=#1b1baa>$nltot</font>} {
      <b><font color=#3a6797>incr</font></b> nl
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> line [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$nl</font>.0 <font color=#1b1baa>$nl</font>.end]] ne {}} <b><font color=#ca14ca>break</font></b>
    }
    <b><font color=#3a6797>set</font></b> i1 <font color=#1b1baa>$nl</font>.0
    <b><font color=#3a6797>set</font></b> ch [<font color=#1b1baa>$txt</font> get <font color=#1b1baa>$i1</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i1 +1 chars&quot;</font>]
    <b><font color=#3a6797>set</font></b> c [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>split</font></b> [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$i1</font>] .] 1]
    <b><font color=#3a6797>if</font></b> {![NotEscaped <font color=#1b1baa>$line</font> <font color=#1b1baa>$c</font>]} {<b><font color=#3a6797>set</font></b> ch {}}
    <b><font color=#3a6797>set</font></b> f1 [<b><font color=#3a6797>expr</font></b> {[SearchTag <font color=#1b1baa>$tSTR</font> [<font color=#1b1baa>$txt</font> index <font color=#1b1baa>$i1</font>]]!=-1}]
    <b><font color=#3a6797>set</font></b> f2 [<b><font color=#3a6797>expr</font></b> {[SearchTag <font color=#1b1baa>$tSTR</font> [<font color=#1b1baa>$txt</font> index <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i1 +1 chars&quot;</font>]]!=-1}]
    <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$ch</font> ne {&quot;} && <font color=#1b1baa>$f1</font> || <font color=#1b1baa>$ch</font> eq {&quot;} && !<font color=#1b1baa>$f2</font>}]
  }
  <b><font color=#ca14ca>return</font></b> 0
}
<a id=HEROIC_EFFORTS_to_highlight_the_matching_brackets></a>
<i><font color=#4b5d50># __________ HEROIC EFFORTS to highlight the matching brackets __________ #</font></i>
<a id=my::MergePosList></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::MergePosList {none args} {
  <i><font color=#4b5d50># Merges lists of numbers that are not-coinciding and sorted.</font></i>
  <i><font color=#4b5d50>#   none - a number to be not allowed in the lists (e.g. less than minimal)</font></i>
  <i><font color=#4b5d50>#   args - list of the lists to be merged</font></i>
  <i><font color=#4b5d50># Returns a list of pairs: index of list + item of list.</font></i>

  <b><font color=#3a6797>set</font></b> itot [<b><font color=#3a6797>set</font></b> ilist 0]
  <b><font color=#3a6797>set</font></b> lind [<b><font color=#3a6797>set</font></b> lout [<b><font color=#3a6797>list</font></b>]]
  <b><font color=#3a6797>foreach</font></b> lst <font color=#1b1baa>$args</font> {
    <b><font color=#3a6797>incr</font></b> ilist
    <b><font color=#3a6797>incr</font></b> itot [<b><font color=#3a6797>set</font></b> llen [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$lst</font>]]
    <b><font color=#3a6797>lappend</font></b> lind [<b><font color=#3a6797>list</font></b> 0 <font color=#1b1baa>$llen</font>]
  }
  <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 0} {<font color=#1b1baa>$i</font>&lt;<font color=#1b1baa>$itot</font>} {<b><font color=#3a6797>incr</font></b> i} {
    <b><font color=#3a6797>set</font></b> min <font color=#1b1baa>$none</font>
    <b><font color=#3a6797>set</font></b> ind -1
    <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> k 0} {<font color=#1b1baa>$k</font>&lt;<font color=#1b1baa>$ilist</font>} {<b><font color=#3a6797>incr</font></b> k} {
      <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$lind</font> <font color=#1b1baa>$k</font>] li llen
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$li</font> &lt; <font color=#1b1baa>$llen</font>} {
        <b><font color=#3a6797>set</font></b> e [<b><font color=#3a6797>lindex</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$args</font> <font color=#1b1baa>$k</font>] <font color=#1b1baa>$li</font>]
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$min</font> == <font color=#1b1baa>$none</font> || <font color=#1b1baa>$min</font> &gt; <font color=#1b1baa>$e</font>} {
          <b><font color=#3a6797>set</font></b> ind <font color=#1b1baa>$k</font>
          <b><font color=#3a6797>set</font></b> min <font color=#1b1baa>$e</font>
          <b><font color=#3a6797>set</font></b> savli [<b><font color=#3a6797>incr</font></b> li]
          <b><font color=#3a6797>set</font></b> savlen <font color=#1b1baa>$llen</font>
        }
      }
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ind</font> == -1} {<b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> error {Error: probably in the input data}}
    <b><font color=#3a6797>lset</font></b> lind <font color=#1b1baa>$ind</font> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$savli</font> <font color=#1b1baa>$savlen</font>]
    <b><font color=#3a6797>lappend</font></b> lout [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$ind</font> <font color=#1b1baa>$min</font>]
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$lout</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::CountChar></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::CountChar {str ch {plistName <font color=#8b2a0e>&quot;&quot;</font>} {escaped yes}} {
  <i><font color=#4b5d50># Counts a character in a string.</font></i>
  <i><font color=#4b5d50>#   str - the string</font></i>
  <i><font color=#4b5d50>#   ch - the character</font></i>
  <i><font color=#4b5d50>#   plistName - variable name for a list of positions of *ch*</font></i>
  <i><font color=#4b5d50>#   escaped - true, if the character is escaped.</font></i>
  <i><font color=#4b5d50># Returns a number of any occurences of character *ch* in string *str*</font></i>
  <i><font color=#4b5d50># if the character is escaped, but if it is not escaped, only non-escaped</font></i>
  <i><font color=#4b5d50># characters are counted.</font></i>

  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$plistName</font> ne {}} {
    <b><font color=#3a6797>upvar</font></b> 1 <font color=#1b1baa>$plistName</font> plist
    <b><font color=#3a6797>set</font></b> plist [<b><font color=#3a6797>list</font></b>]
  }
  <b><font color=#3a6797>set</font></b> icnt [<b><font color=#3a6797>set</font></b> begidx 0]
  <b><font color=#3a6797>while</font></b> {[<b><font color=#3a6797>set</font></b> idx [<b><font color=#3a6797>string</font></b> first <font color=#1b1baa>$ch</font> <font color=#1b1baa>$str</font>]] &gt;= 0} {
    <b><font color=#3a6797>set</font></b> nidx <font color=#1b1baa>$idx</font>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$escaped</font> || ![Escaped <font color=#1b1baa>$str</font> <font color=#1b1baa>$idx</font>]} {
      <b><font color=#3a6797>incr</font></b> icnt
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$plistName</font> ne {}} {<b><font color=#3a6797>lappend</font></b> plist [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$begidx</font>+<font color=#1b1baa>$idx</font>}]}
    }
    <b><font color=#3a6797>incr</font></b> begidx [<b><font color=#3a6797>incr</font></b> idx]
    <b><font color=#3a6797>set</font></b> str [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$str</font> <font color=#1b1baa>$idx</font> end]
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$icnt</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::Escaped></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::Escaped {line curpos} {
  <i><font color=#4b5d50># Checks if a character is escaped in a string.</font></i>
  <i><font color=#4b5d50>#   line - the string</font></i>
  <i><font color=#4b5d50>#   curpos - position of the character in the line</font></i>
  <i><font color=#4b5d50># Returns 1 if the character is escaped in the string.</font></i>

  <b><font color=#3a6797>set</font></b> line [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$line</font> 0 <font color=#1b1baa>$curpos</font>-1]
  <b><font color=#3a6797>set</font></b> linetrim [<b><font color=#3a6797>string</font></b> trimright <font color=#1b1baa>$line</font> \\]
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {([<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$line</font>]-[<b><font color=#3a6797>string</font></b> length <font color=#1b1baa>$linetrim</font>])%2}]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::MatchedBrackets></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::MatchedBrackets {w inplist curpos schar dchar dir} {
  <i><font color=#4b5d50># Finds a match of characters (dchar for schar).</font></i>
  <i><font color=#4b5d50>#   w - text widget's path</font></i>
  <i><font color=#4b5d50>#   inplist - list of strings where to find a match</font></i>
  <i><font color=#4b5d50>#   curpos - position of schar in nl.nc form where nl=1.., nc=0..</font></i>
  <i><font color=#4b5d50>#   schar - source character</font></i>
  <i><font color=#4b5d50>#   dchar - destination character</font></i>
  <i><font color=#4b5d50>#   dir - search direction: 1 to the end, -1 to the beginning of list</font></i>

  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> <font color=#1b1baa>$curpos</font> .] nl nc
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$schar</font> eq {&quot;}} {
    <b><font color=#3a6797>set</font></b> npos <font color=#1b1baa>$nl</font>.<font color=#1b1baa>$nc</font>
    <b><font color=#3a6797>set</font></b> hlpr [<font color=#1b1baa>$w</font> tag prevrange tagSTR <font color=#1b1baa>$npos</font>]
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$hlpr</font>] && [<font color=#1b1baa>$w</font> compare <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>npos +1 char&quot;</font> == [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$hlpr</font> 1]]} {
      <b><font color=#3a6797>set</font></b> dir -1  ;<i><font color=#4b5d50># &lt;- quotes are scanned depending on their range (for tcl/c)</font></i>
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> hlpr [<font color=#1b1baa>$w</font> tag nextrange tagSTR <font color=#1b1baa>$npos</font>]
      <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$hlpr</font>] || [<font color=#1b1baa>$w</font> compare <font color=#1b1baa>$npos</font> != [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$hlpr</font> 0]]} {
        <i><font color=#4b5d50># for plain texts:</font></i>
        <b><font color=#3a6797>if</font></b> {[<font color=#1b1baa>$w</font> search <font color=#653760>-exact</font> \&quot; <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>npos +1 char&quot;</font> end] eq {}} {
          <b><font color=#3a6797>set</font></b> dir -1
        } <b><font color=#3a6797>else</font></b> {
          <b><font color=#3a6797>set</font></b> lfnd [<font color=#1b1baa>$w</font> search <font color=#653760>-backwards</font> <font color=#653760>-all</font> <font color=#653760>-exact</font> \&quot; <font color=#1b1baa>$npos</font> 1.0]
          <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$lfnd</font>] % 2} {
            <b><font color=#3a6797>set</font></b> dir -1
          }
        }
      }
    }
    <b><font color=#3a6797>incr</font></b> nc <font color=#1b1baa>$dir</font>
  }
  <b><font color=#3a6797>set</font></b> escaped [Escaped [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$inplist</font> <font color=#1b1baa>$nl</font>-1] <font color=#1b1baa>$nc</font>]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dir</font>==1} {<b><font color=#3a6797>set</font></b> rng1 <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>nc end&quot;</font>} <b><font color=#3a6797>else</font></b> {<b><font color=#3a6797>set</font></b> rng1 <font color=#8b2a0e>&quot;0 <font color=#1b1baa>$</font>nc&quot;</font>; <b><font color=#3a6797>set</font></b> nc 0}
  <b><font color=#3a6797>set</font></b> retpos {}
  <b><font color=#3a6797>set</font></b> scount [<b><font color=#3a6797>set</font></b> dcount 0]
  <b><font color=#3a6797>incr</font></b> nl -1
  <b><font color=#3a6797>set</font></b> inplen [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$inplist</font>]
  <b><font color=#3a6797>while</font></b> {<font color=#1b1baa>$nl</font>&gt;=0 && <font color=#1b1baa>$nl</font>&lt;<font color=#1b1baa>$inplen</font>} {
    <b><font color=#3a6797>set</font></b> line [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$inplist</font> <font color=#1b1baa>$nl</font>]
    <b><font color=#3a6797>set</font></b> line [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$line</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$rng1</font>]
    <b><font color=#3a6797>set</font></b> sc [CountChar <font color=#1b1baa>$line</font> <font color=#1b1baa>$schar</font> slist <font color=#1b1baa>$escaped</font>]
    <b><font color=#3a6797>set</font></b> dc [CountChar <font color=#1b1baa>$line</font> <font color=#1b1baa>$dchar</font> dlist <font color=#1b1baa>$escaped</font>]
    <b><font color=#3a6797>set</font></b> plen [<b><font color=#3a6797>llength</font></b> [<b><font color=#3a6797>set</font></b> plist [MergePosList -1 <font color=#1b1baa>$slist</font> <font color=#1b1baa>$dlist</font>]]]
    <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$dir</font>&gt;0?0:(<font color=#1b1baa>$plen</font>-1)}]} {<font color=#1b1baa>$i</font>&gt;=0 && <font color=#1b1baa>$i</font>&lt;<font color=#1b1baa>$plen</font>} {<b><font color=#3a6797>incr</font></b> i <font color=#1b1baa>$dir</font>} {
      <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$plist</font> <font color=#1b1baa>$i</font>] src pos
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$src</font>} {<b><font color=#3a6797>incr</font></b> dcount} {<b><font color=#3a6797>incr</font></b> scount}
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$scount</font> &lt;= <font color=#1b1baa>$dcount</font>} {
        <b><font color=#3a6797>set</font></b> retpos [<b><font color=#3a6797>incr</font></b> nl].[<b><font color=#3a6797>incr</font></b> pos <font color=#1b1baa>$nc</font>]
        <b><font color=#ca14ca>break</font></b>
      }
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$retpos</font> ne {}} <b><font color=#ca14ca>break</font></b>
    <b><font color=#3a6797>set</font></b> nc 0
    <b><font color=#3a6797>set</font></b> rng1 {0 end}
    <b><font color=#3a6797>incr</font></b> nl <font color=#1b1baa>$dir</font>
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$retpos</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightBrackets></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::my::HighlightBrackets {w} {
  <i><font color=#4b5d50># Highlights matching brackets if any.</font></i>
  <i><font color=#4b5d50>#   w - text widget's path</font></i>

  <b><font color=#3a6797>variable</font></b> data
  <b><font color=#3a6797>set</font></b> curpos [ShowCurrentLine <font color=#1b1baa>$w</font>]
  <b><font color=#3a6797>set</font></b> curpos2 [<font color=#1b1baa>$w</font> index {insert -1 chars}]
  <b><font color=#3a6797>set</font></b> ch [<font color=#1b1baa>$w</font> get <font color=#1b1baa>$curpos</font>]
  <b><font color=#3a6797>set</font></b> il [<b><font color=#3a6797>string</font></b> first <font color=#1b1baa>$ch</font> <font color=#1b1baa>$data(LBR)</font>]
  <b><font color=#3a6797>set</font></b> ir [<b><font color=#3a6797>string</font></b> first <font color=#1b1baa>$ch</font> <font color=#1b1baa>$data(RBR)</font>]
  <b><font color=#3a6797>set</font></b> txt [<b><font color=#3a6797>split</font></b> [<font color=#1b1baa>$w</font> get 1.0 end] \n]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$il</font>&gt;-1} {
    <b><font color=#3a6797>set</font></b> brcpos [MatchedBrackets <font color=#1b1baa>$w</font> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$curpos</font> \
      [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(LBR)</font> <font color=#1b1baa>$il</font>] [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(RBR)</font> <font color=#1b1baa>$il</font>] 1]
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$ir</font>&gt;-1} {
    <b><font color=#3a6797>set</font></b> brcpos [MatchedBrackets <font color=#1b1baa>$w</font> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$curpos</font> \
      [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(RBR)</font> <font color=#1b1baa>$ir</font>] [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(LBR)</font> <font color=#1b1baa>$ir</font>] -1]
  } <b><font color=#3a6797>elseif</font></b> {[<b><font color=#3a6797>set</font></b> il [<b><font color=#3a6797>string</font></b> first [<font color=#1b1baa>$w</font> get <font color=#1b1baa>$curpos2</font>] <font color=#1b1baa>$data(LBR)</font>]]&gt;-1} {
    <b><font color=#3a6797>set</font></b> curpos <font color=#1b1baa>$curpos2</font>
    <b><font color=#3a6797>set</font></b> brcpos [MatchedBrackets <font color=#1b1baa>$w</font> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$curpos</font> \
      [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(LBR)</font> <font color=#1b1baa>$il</font>] [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(RBR)</font> <font color=#1b1baa>$il</font>] 1]
  } <b><font color=#3a6797>elseif</font></b> {[<b><font color=#3a6797>set</font></b> ir [<b><font color=#3a6797>string</font></b> first [<font color=#1b1baa>$w</font> get <font color=#1b1baa>$curpos2</font>] <font color=#1b1baa>$data(RBR)</font>]]&gt;-1} {
    <b><font color=#3a6797>set</font></b> curpos <font color=#1b1baa>$curpos2</font>
    <b><font color=#3a6797>set</font></b> brcpos [MatchedBrackets <font color=#1b1baa>$w</font> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$curpos</font> \
      [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(RBR)</font> <font color=#1b1baa>$ir</font>] [<b><font color=#3a6797>string</font></b> index <font color=#1b1baa>$data(LBR)</font> <font color=#1b1baa>$ir</font>] -1]
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$brcpos</font> ne {}} {
    <font color=#1b1baa>$w</font> tag add tagBRACKET <font color=#1b1baa>$brcpos</font>
    <font color=#1b1baa>$w</font> tag add tagBRACKET <font color=#1b1baa>$curpos</font>
  } <b><font color=#3a6797>else</font></b> {
    <font color=#1b1baa>$w</font> tag add tagBRACKETERR <font color=#1b1baa>$curpos</font>
  }
  <b><font color=#ca14ca>return</font></b>
}
<a id=INTERFACE_procedures></a>
<i><font color=#4b5d50># _________________________ INTERFACE procedures ________________________ #</font></i>
<a id=hl_tcl::hl_readonly></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_readonly {txt {ro -1} {com2 <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Makes the text widget be readonly or gets its 'read-only' state.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   ro - flag &quot;the text widget is readonly&quot;</font></i>
  <i><font color=#4b5d50>#   com2 - command to be called at viewing and after changes</font></i>
  <i><font color=#4b5d50># If 'ro' argument is omitted, returns the widget's 'read-only' state.</font></i>

  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ro</font>==-1} {
    <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(READONLY,<font color=#1b1baa>$txt</font>)] && <font color=#1b1baa>$::hl_tcl::my::data(READONLY,$txt)</font>}]
  }
  <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(READONLY,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$ro</font>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$com2</font> ne {}} {<b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(CMD,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$com2</font>}
  <b><font color=#3a6797>set</font></b> newcom <font color=#8b2a0e>&quot;::<font color=#1b1baa>$</font>txt.internal&quot;</font>
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> commands <font color=#1b1baa>$newcom</font>] eq <font color=#8b2a0e>&quot;&quot;</font>} {<b><font color=#3a6797>rename</font></b> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$newcom</font>}
  <b><font color=#3a6797>set</font></b> com <font color=#8b2a0e>&quot;<font color=#1b1baa>[</font>namespace current<font color=#1b1baa>]</font>::my::Modified <font color=#1b1baa>$</font>txt&quot;</font>
  <i><font color=#4b5d50>#if {$com2 ne &quot;&quot;} {append com &quot; ; $com2&quot;}</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$ro</font>} {<b><font color=#ca14ca>proc</font></b> ::<font color=#1b1baa>$txt</font> {args} <font color=#8b2a0e>&quot; \</font>
<font color=#8b2a0e>    if <font color=#1b1baa>{</font>!\[winfo exists <font color=#1b1baa>$</font>txt\]<font color=#1b1baa>}</font> <font color=#1b1baa>{</font>return 0<font color=#1b1baa>}</font> ; \</font>
<font color=#8b2a0e>    switch -exact -- \[lindex \$args 0\] \{ \</font>
<font color=#8b2a0e>      insert \{<font color=#1b1baa>$</font>com2\} \</font>
<font color=#8b2a0e>      delete \{<font color=#1b1baa>$</font>com2\} \</font>
<font color=#8b2a0e>      replace \{<font color=#1b1baa>$</font>com2\} \</font>
<font color=#8b2a0e>      default \{ return \[eval <font color=#1b1baa>$</font>newcom \$args\] \} \</font>
<font color=#8b2a0e>    \}&quot;</font>
  } <b><font color=#3a6797>else</font></b> {<b><font color=#ca14ca>proc</font></b> ::<font color=#1b1baa>$txt</font> {args} <font color=#8b2a0e>&quot; \</font>
<font color=#8b2a0e>    if <font color=#1b1baa>{</font>!\[winfo exists <font color=#1b1baa>$</font>txt\]<font color=#1b1baa>}</font> <font color=#1b1baa>{</font>return 0<font color=#1b1baa>}</font> ; \</font>
<font color=#8b2a0e>    switch -exact -- \[lindex \$args 0\] \{ \</font>
<font color=#8b2a0e>      delete \{<font color=#1b1baa>$</font>com <font color=#1b1baa>{</font>*<font color=#1b1baa>}</font>\$args\} \</font>
<font color=#8b2a0e>      insert \{<font color=#1b1baa>$</font>com <font color=#1b1baa>{</font>*<font color=#1b1baa>}</font>\$args\} \</font>
<font color=#8b2a0e>      replace \{<font color=#1b1baa>$</font>com <font color=#1b1baa>{</font>*<font color=#1b1baa>}</font>\$args\} \</font>
<font color=#8b2a0e>    \} ; \</font>
<font color=#8b2a0e>    set _res_ \[eval <font color=#1b1baa>$</font>newcom \$args\] ; \</font>
<font color=#8b2a0e>    return \$_res_&quot;</font>
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_init></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_init {txt args} {
  <i><font color=#4b5d50># Initializes highlighting.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>
  <i><font color=#4b5d50>#   args - dict of options</font></i>
  <i><font color=#4b5d50># The 'args' options include:</font></i>
  <i><font color=#4b5d50>#   -- - means that only args' options will be initialized (defaults skipped)</font></i>
  <i><font color=#4b5d50>#   -dark - flag &quot;the text widget has dark background&quot;</font></i>
  <i><font color=#4b5d50>#   -readonly - flag &quot;read-only&quot;</font></i>
  <i><font color=#4b5d50>#   -optRE - flag &quot;use of RE to highlight options&quot;</font></i>
  <i><font color=#4b5d50>#   -multiline - flag &quot;allowed multi-line strings&quot;</font></i>
  <i><font color=#4b5d50>#   -cmd - command to watch editing/viewing</font></i>
  <i><font color=#4b5d50>#   -cmdpos - command to watch cursor positioning</font></i>
  <i><font color=#4b5d50>#   -colors - list of colors as set in hl_tcl::hl_colorNames</font></i>
  <i><font color=#4b5d50>#   -font - attributes of font</font></i>
  <i><font color=#4b5d50>#   -seen - lines seen at start</font></i>
  <i><font color=#4b5d50>#   -keywords - additional commands to highlight (as Tk ones)</font></i>
  <i><font color=#4b5d50>#   -dobind - if yes, forces key bindings</font></i>
  <i><font color=#4b5d50># This procedure has to be called before writing a text in the text widget.</font></i>
  <i><font color=#4b5d50># See also: hl_colorNames</font></i>

  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> setonly [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$args</font> 0] eq {--}}]]} {
    <b><font color=#3a6797>set</font></b> args [<b><font color=#3a6797>lrange</font></b> <font color=#1b1baa>$args</font> 1 end]
  }
  iscurline <font color=#1b1baa>$txt</font> 1
  <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(REG_TXT,<font color=#1b1baa>$txt</font>) {}  ;<i><font color=#4b5d50># disables Modified at changing the text</font></i>
  <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(KEYWORDS,<font color=#1b1baa>$txt</font>) {}
  <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(DOBIND,<font color=#1b1baa>$txt</font>) 0
  <i><font color=#4b5d50># get default options from text's ones</font></i>
  <b><font color=#3a6797>set</font></b> defopts [<b><font color=#3a6797>list</font></b> <font color=#653760>-insertwidth</font>]
  <b><font color=#3a6797>foreach</font></b> defopt <font color=#1b1baa>$defopts</font> {
    <b><font color=#3a6797>set</font></b> opt [OptName <font color=#1b1baa>$txt</font> <font color=#1b1baa>$defopt</font>]
    <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(<font color=#1b1baa>$opt</font>)]} {
      <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(<font color=#1b1baa>$opt</font>,DEFAULT) [<font color=#1b1baa>$txt</font> cget <font color=#1b1baa>$defopt</font>]
    }
  }
  <b><font color=#3a6797>foreach</font></b> {opt val} {<font color=#653760>-dark</font> 0 <font color=#653760>-readonly</font> 0 <font color=#653760>-cmd</font> {} <font color=#653760>-cmdpos</font> {} <font color=#653760>-optRE</font> 1 <font color=#653760>-dobind</font> 0 \
  <font color=#653760>-multiline</font> 1 <font color=#653760>-seen</font> 500 <font color=#653760>-plaintext</font> no <font color=#653760>-plaincom</font> {} <font color=#653760>-insertwidth</font> {} <font color=#653760>-keywords</font> {}} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>dict</font></b> exists <font color=#1b1baa>$args</font> <font color=#1b1baa>$opt</font>]} {
      <b><font color=#3a6797>set</font></b> val [<b><font color=#3a6797>dict</font></b> get <font color=#1b1baa>$args</font> <font color=#1b1baa>$opt</font>]
    } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$setonly</font>} {
      <b><font color=#ca14ca>continue</font></b>  ;<i><font color=#4b5d50># only those set in args are taken into account</font></i>
    }
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data([OptName <font color=#1b1baa>$txt</font> <font color=#1b1baa>$opt</font>]) <font color=#1b1baa>$val</font>
  }
  <i><font color=#4b5d50># reget default options from text's ones</font></i>
  <b><font color=#3a6797>foreach</font></b> defopt <font color=#1b1baa>$defopts</font> {
    <b><font color=#3a6797>set</font></b> opt [OptName <font color=#1b1baa>$txt</font> <font color=#1b1baa>$defopt</font>]
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(<font color=#1b1baa>$opt</font>)] && <font color=#1b1baa>$::hl_tcl::my::data($opt)</font> eq {}} {
      <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(<font color=#1b1baa>$opt</font>) <font color=#1b1baa>$::hl_tcl::my::data($opt,DEFAULT)</font>
    }
  }
  <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(CMD_TK_EXP) [<b><font color=#3a6797>lsort</font></b> [<b><font color=#3a6797>list</font></b> \
    {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$::hl_tcl::my::data(CMD_TK)</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$::hl_tcl::my::data(KEYWORDS,$txt)</font>]]
  <b><font color=#3a6797>unset</font></b> ::hl_tcl::my::data(KEYWORDS,<font color=#1b1baa>$txt</font>)
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>dict</font></b> exists <font color=#1b1baa>$args</font> <font color=#653760>-colors</font>]} {
    <b><font color=#3a6797>set</font></b> colors [<b><font color=#3a6797>dict</font></b> get <font color=#1b1baa>$args</font> <font color=#653760>-colors</font>]
    <b><font color=#3a6797>lassign</font></b> [addingColors <font color=#1b1baa>$::hl_tcl::my::data(DARK,$txt)</font>] clrCURL clrCMN2
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> llen [<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$colors</font>]]==8} {
      <b><font color=#3a6797>lappend</font></b> colors <font color=#1b1baa>$clrCURL</font>  ;<i><font color=#4b5d50># add curr.line color if omitted</font></i>
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$llen</font>==9} {
      <b><font color=#3a6797>lappend</font></b> colors <font color=#1b1baa>$clrCMN2</font>  ;<i><font color=#4b5d50># add #TODO color if omitted</font></i>
    }
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(COLORS,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$colors</font>
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(SETCOLORS,<font color=#1b1baa>$txt</font>) 1
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(COLORS,<font color=#1b1baa>$txt</font>)]}  {
      addingColors <font color=#1b1baa>$::hl_tcl::my::data(DARK,$txt)</font> <font color=#1b1baa>$txt</font>
    }
  }
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$setonly</font>} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>dict</font></b> exists <font color=#1b1baa>$args</font> <font color=#653760>-font</font>]} {
      <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(FONT,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>dict</font></b> get <font color=#1b1baa>$args</font> <font color=#653760>-font</font>]
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(FONT,<font color=#1b1baa>$txt</font>) [<b><font color=#134070>font</font></b> actual TkFixedFont]
    }
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(ISPLAINCOM,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$::hl_tcl::my::data(PLAINCOM,$txt)</font> ne {}}]
  }
  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$setonly</font> || [<b><font color=#3a6797>dict</font></b> exists <font color=#1b1baa>$args</font> <font color=#653760>-readonly</font>]} {
    hl_readonly <font color=#1b1baa>$txt</font> <font color=#1b1baa>$::hl_tcl::my::data(READONLY,$txt)</font>
  }
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>string</font></b> first ::hl_tcl:: [<b><font color=#134070>bind</font></b> <font color=#1b1baa>$txt</font>]]&lt;0} {
    my::BindToEvent <font color=#1b1baa>$txt</font> &lt;FocusIn&gt; ::hl_tcl::my::ShowCurrentLine <font color=#1b1baa>$txt</font>
  }
  <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(_INSPOS_,<font color=#1b1baa>$txt</font>) {}
  my::MemPos <font color=#1b1baa>$txt</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_text></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_text {txt} {
  <i><font color=#4b5d50># Highlights Tcl code of a text widget.</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path</font></i>

  <b><font color=#3a6797>set</font></b> font0 <font color=#1b1baa>$::hl_tcl::my::data(FONT,$txt)</font>
  <b><font color=#3a6797>set</font></b> font1 [<b><font color=#3a6797>set</font></b> font2 <font color=#1b1baa>$font0</font>]
  <font color=#1b1baa>$txt</font> tag configure tagSTD <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font0&quot;</font>
  <font color=#1b1baa>$txt</font> tag add tagSTD 1.0 end
  <b><font color=#3a6797>dict</font></b> set font1 <font color=#653760>-weight</font> bold
  <b><font color=#3a6797>dict</font></b> set font2 <font color=#653760>-slant</font> italic
  <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$::hl_tcl::my::data(COLORS,$txt)</font> \
    clrCOM clrCOMTK clrSTR clrVAR clrCMN clrPROC clrOPT clrBRA clrCURL clrCMN2
  <font color=#1b1baa>$txt</font> tag configure tagCOM <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font1&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrCOM</font>
  <font color=#1b1baa>$txt</font> tag configure tagCOMTK <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font1&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrCOMTK</font>
  <font color=#1b1baa>$txt</font> tag configure tagSTR <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font0&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrSTR</font>
  <font color=#1b1baa>$txt</font> tag configure tagVAR <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font0&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrVAR</font>
  <font color=#1b1baa>$txt</font> tag configure tagCMN <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font2&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrCMN</font>
  <font color=#1b1baa>$txt</font> tag configure tagCMN2 <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font2&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrCMN2</font> ;<i><font color=#4b5d50>#red</font></i>
  <font color=#1b1baa>$txt</font> tag configure tagPROC <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font1&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrPROC</font>
  <font color=#1b1baa>$txt</font> tag configure tagOPT <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font0&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrOPT</font>
  <font color=#1b1baa>$txt</font> tag configure tagBRACKET <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font0&quot;</font> <font color=#653760>-foreground</font> <font color=#1b1baa>$clrBRA</font>
  <font color=#1b1baa>$txt</font> tag configure tagBRACKETERR <font color=#653760>-font</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>font0&quot;</font> <font color=#653760>-foreground</font> white <font color=#653760>-background</font> red
  <font color=#1b1baa>$txt</font> tag configure tagCURLINE <font color=#653760>-background</font> <font color=#1b1baa>$clrCURL</font>
  <font color=#1b1baa>$txt</font> tag raise sel
  <font color=#1b1baa>$txt</font> tag raise tagBRACKETERR
  <b><font color=#3a6797>catch</font></b> {<font color=#1b1baa>$txt</font> tag raise hilited;  <font color=#1b1baa>$txt</font> tag raise hilited2} ;<i><font color=#4b5d50># for apave package</font></i>
  my::HighlightAll <font color=#1b1baa>$txt</font>
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(BIND_TXT,<font color=#1b1baa>$txt</font>)] ||
  [<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(DOBIND,<font color=#1b1baa>$txt</font>)] && <font color=#1b1baa>$::hl_tcl::my::data(DOBIND,$txt)</font>} {
    my::BindToEvent <font color=#1b1baa>$txt</font> &lt;FocusIn&gt; ::hl_tcl::my::MemPos <font color=#1b1baa>$txt</font>
    my::BindToEvent <font color=#1b1baa>$txt</font> &lt;KeyPress&gt; ::hl_tcl::my::MemPos1 <font color=#1b1baa>$txt</font> yes %K %s
    my::BindToEvent <font color=#1b1baa>$txt</font> &lt;KeyRelease&gt; ::hl_tcl::my::MemPos <font color=#1b1baa>$txt</font>
    my::BindToEvent <font color=#1b1baa>$txt</font> &lt;ButtonRelease-1&gt; ::hl_tcl::my::MemPos <font color=#1b1baa>$txt</font>
    <b><font color=#3a6797>foreach</font></b> ev {Enter KeyRelease ButtonRelease-1} {
      my::BindToEvent <font color=#1b1baa>$txt</font> &lt;<font color=#1b1baa>$ev</font>&gt; ::hl_tcl::my::HighlightBrackets <font color=#1b1baa>$txt</font>
    }
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(BIND_TXT,<font color=#1b1baa>$txt</font>) yes
  }
  <b><font color=#3a6797>set</font></b> ro <font color=#1b1baa>$::hl_tcl::my::data(READONLY,$txt)</font>
  <b><font color=#3a6797>set</font></b> com2 <font color=#1b1baa>$::hl_tcl::my::data(CMD,$txt)</font>
  <b><font color=#3a6797>set</font></b> txtattrs [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ro</font> <font color=#1b1baa>$com2</font>]
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(LIST_TXT)] || \
  [<b><font color=#3a6797>set</font></b> i [<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-index</font> 0 <font color=#653760>-exact</font> <font color=#1b1baa>$::hl_tcl::my::data(LIST_TXT)</font> <font color=#1b1baa>$txt</font>]]==-1} {
    <b><font color=#3a6797>lappend</font></b> ::hl_tcl::my::data(LIST_TXT) <font color=#1b1baa>$txtattrs</font>
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(LIST_TXT) [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$::hl_tcl::my::data(LIST_TXT)</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$txtattrs</font>]
  }
  hl_readonly <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ro</font> <font color=#1b1baa>$com2</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_all></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_all {args} {
  <i><font color=#4b5d50># Updates (&quot;rehighlights&quot;) all highlighted and existing text widgets.</font></i>
  <i><font color=#4b5d50>#   args - dict of options</font></i>
  <i><font color=#4b5d50># See also: hl_init</font></i>

  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(LIST_TXT)]} {
    <b><font color=#3a6797>foreach</font></b> wattrs <font color=#1b1baa>$::hl_tcl::my::data(LIST_TXT)</font> {
      <b><font color=#3a6797>lassign</font></b> <font color=#1b1baa>$wattrs</font> txt ro com2
      <b><font color=#3a6797>if</font></b> {[<b><font color=#134070>winfo</font></b> exists <font color=#1b1baa>$txt</font>]} {
        <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(SETCOLORS,<font color=#1b1baa>$txt</font>)]} {
          <b><font color=#3a6797>unset</font></b> ::hl_tcl::my::data(COLORS,<font color=#1b1baa>$txt</font>) ;<i><font color=#4b5d50># colors defined by DARK</font></i>
        }
        <i><font color=#4b5d50># args (if set) override the appropriate settings for $txt</font></i>
        hl_init <font color=#1b1baa>$txt</font> -- {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>
        hl_text <font color=#1b1baa>$txt</font>
      }
    }
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_colorNames></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_colorNames {} {
  <i><font color=#4b5d50># Returns a list of color names for syntax highlighting.</font></i>

  <b><font color=#3a6797>list</font></b> clrCOM clrCOMTK clrSTR clrVAR clrCMN clrPROC clrOPT clrBRA
}

<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_colors></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_colors {txt {dark <font color=#8b2a0e>&quot;&quot;</font>} args} {
  <i><font color=#4b5d50># Gets/sets the main colors for highlighting (except for &quot;curr.line&quot;).</font></i>
  <i><font color=#4b5d50>#   txt - text widget's path or {} or an index of default colors</font></i>
  <i><font color=#4b5d50>#   dark - flag &quot;dark scheme&quot;</font></i>
  <i><font color=#4b5d50>#   args - a list of colors to set for *txt*</font></i>
  <i><font color=#4b5d50># Returns a list of colors for COM COMTK STR VAR CMN PROC OPT BRAC \</font></i>
<i><font color=#4b5d50>   or, if the colors aren't initialized, &quot;standard&quot; colors.</font></i>

  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>llength</font></b> <font color=#1b1baa>$args</font>]} {
    <b><font color=#3a6797>set</font></b> ::hl_tcl::my::data(COLORS,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$args</font>
    <b><font color=#ca14ca>return</font></b>
  }
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists ::hl_tcl::my::data(COLORS,<font color=#1b1baa>$txt</font>)]}  {
    <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$::hl_tcl::my::data(COLORS,$txt)</font>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dark</font> eq {}} {<b><font color=#3a6797>set</font></b> dark <font color=#1b1baa>$::hl_tcl::my::data(DARK,$txt)</font>}
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>string</font></b> is integer <font color=#653760>-strict</font> <font color=#1b1baa>$txt</font>] || <font color=#1b1baa>$txt</font>&lt;0 || <font color=#1b1baa>$txt</font>&gt;3} {<b><font color=#3a6797>set</font></b> txt 0}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dark</font>} {<b><font color=#3a6797>set</font></b> dark 1} {<b><font color=#3a6797>set</font></b> dark 0}
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$::hl_tcl::my::data(SYNTAXCOLORS,$txt)</font> <font color=#1b1baa>$dark</font>]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_line></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_line {txt} {
  <i><font color=#4b5d50># Updates a current line's highlighting.</font></i>
  <i><font color=#4b5d50>#   txt - text's path</font></i>

  <b><font color=#3a6797>if</font></b> {!<font color=#1b1baa>$::hl_tcl::my::data(PLAINTEXT,$txt)</font>} {
    <b><font color=#3a6797>set</font></b> ln0 [<b><font color=#3a6797>expr</font></b> {int([<font color=#1b1baa>$txt</font> index insert])}]
    <b><font color=#3a6797>set</font></b> ln2 [<b><font color=#3a6797>expr</font></b> {int([<font color=#1b1baa>$txt</font> index end])}]
    <b><font color=#3a6797>set</font></b> ln1 [<b><font color=#3a6797>expr</font></b> {max (1,<font color=#1b1baa>$ln0</font>-1)}]
    <b><font color=#3a6797>set</font></b> ln2 [<b><font color=#3a6797>expr</font></b> {min (<font color=#1b1baa>$ln2</font>,<font color=#1b1baa>$ln0</font>+1)}]
    <i><font color=#4b5d50># update lines: previous, current, next</font></i>
    ::hl_tcl::my::RunCoroAfterIdle <font color=#1b1baa>$txt</font> <font color=#1b1baa>$ln1</font> <font color=#1b1baa>$ln2</font> no
  }
  ::hl_tcl::my::MemPos <font color=#1b1baa>$txt</font> yes
  <font color=#1b1baa>$txt</font> configure <font color=#653760>-insertwidth</font> <font color=#1b1baa>$::hl_tcl::my::data(INSERTWIDTH,$txt)</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::addingColors></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::addingColors {{dark <font color=#8b2a0e>&quot;&quot;</font>} {txt <font color=#8b2a0e>&quot;&quot;</font>} {cs <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Sets/gets colors for a text syntax highlighting.</font></i>
  <i><font color=#4b5d50>#   dark - yes, if the current theme is dark</font></i>
  <i><font color=#4b5d50>#   txt - path to the text or {}</font></i>
  <i><font color=#4b5d50>#   cs - color scheme</font></i>
  <i><font color=#4b5d50># If *txt* omitted, returns a list of resting colors.</font></i>
  <i><font color=#4b5d50># The resting colors are:</font></i>
  <i><font color=#4b5d50>#   - current line's background</font></i>
  <i><font color=#4b5d50>#   - #TODO and #! comment's foreground</font></i>

  <b><font color=#3a6797>variable</font></b> my::data
  <i><font color=#4b5d50># try to get color options from current apave settings</font></i>
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> clrCURL [<b><font color=#3a6797>lindex</font></b> [::apave::obj csGet <font color=#1b1baa>$cs</font>] 16]}]} {
    <b><font color=#3a6797>set</font></b> clrCURL {}
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dark</font> eq {}} {
    <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> dark [::apave::obj csDark]}]} {
      <b><font color=#3a6797>set</font></b> dark no
    }
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dark</font>} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$clrCURL</font> eq {}} {<b><font color=#3a6797>set</font></b> clrCURL #29383c}
    <b><font color=#3a6797>set</font></b> clrCMN2 #ff7272
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$clrCURL</font> eq {}} {<b><font color=#3a6797>set</font></b> clrCURL #efe0cd}
    <b><font color=#3a6797>set</font></b> clrCMN2 #ff0000
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$txt</font> eq {}} {
    <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$clrCURL</font> <font color=#1b1baa>$clrCMN2</font>]
  }
  <b><font color=#3a6797>set</font></b> my::data(COLORS,<font color=#1b1baa>$txt</font>) [<b><font color=#3a6797>list</font></b> {<b><font color=#3a6797>*</font></b>}[hl_colors <font color=#1b1baa>$txt</font>] <font color=#1b1baa>$clrCURL</font> <font color=#1b1baa>$clrCMN2</font>]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::hl_commands></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::hl_commands {} {
  <i><font color=#4b5d50># Lists all Tcl/Tk commands registered here.</font></i>

  <b><font color=#3a6797>variable</font></b> my::data
  <b><font color=#3a6797>list</font></b> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$my::data(PROC_TCL)</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$my::data(CMD_TCL)</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$my::data(CMD_TK)</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::iscurline></a>
<b><font color=#ca14ca>proc</font></b> hl_tcl::iscurline {txt {flag <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Sets / gets &quot;highlight a current line&quot; flag for a text.</font></i>
  <i><font color=#4b5d50>#   txt - the text's path</font></i>
  <i><font color=#4b5d50>#   flag - the flag</font></i>

  <b><font color=#ca14ca>return</font></b> [my::IsCurline <font color=#1b1baa>$txt</font> <font color=#1b1baa>$flag</font>]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::isdone></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::isdone {txt} {
  <i><font color=#4b5d50># Checks if the highlighting of the text is done.</font></i>
  <i><font color=#4b5d50>#   txt - text's path</font></i>

  <b><font color=#3a6797>variable</font></b> my::data
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>info</font></b> exist my::data(REG_TXT,<font color=#1b1baa>$txt</font>)] && <font color=#1b1baa>$my::data(REG_TXT,$txt)</font> ne {}}]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::clearup></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::clearup {txt} {
  <i><font color=#4b5d50># Clears data related to text (esp. at deleting it).</font></i>
  <i><font color=#4b5d50>#   txt - text's path</font></i>

  <b><font color=#3a6797>variable</font></b> my::data
  <b><font color=#3a6797>foreach</font></b> key [<b><font color=#3a6797>array</font></b> names my::data *,<font color=#1b1baa>$txt</font>] {
    <b><font color=#3a6797>unset</font></b> my::data(<font color=#1b1baa>$key</font>)
  }
  <b><font color=#3a6797>foreach</font></b> i [<b><font color=#3a6797>lsearch</font></b> <font color=#653760>-all</font> <font color=#653760>-exact</font> <font color=#653760>-index</font> 0 <font color=#1b1baa>$my::data(LIST_TXT)</font> <font color=#1b1baa>$txt</font>] {
    <b><font color=#3a6797>set</font></b> my::data(LIST_TXT) [<b><font color=#3a6797>lreplace</font></b> <font color=#1b1baa>$my::data(LIST_TXT)</font> <font color=#1b1baa>$i</font> <font color=#1b1baa>$i</font>]
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::cget></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::cget {txt opt} {
  <i><font color=#4b5d50># Gets a highlighting option's value.</font></i>
  <i><font color=#4b5d50>#   txt - text's path</font></i>
  <i><font color=#4b5d50>#   opt - option's name</font></i>

  <b><font color=#3a6797>variable</font></b> my::data
  <b><font color=#3a6797>set</font></b> opt [<b><font color=#3a6797>string</font></b> toupper [<b><font color=#3a6797>string</font></b> trimleft <font color=#1b1baa>$opt</font> -]]
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists my::data(<font color=#1b1baa>$opt</font>,<font color=#1b1baa>$txt</font>)]} {
    <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$my::data($opt,$txt)</font>
  }
  <b><font color=#ca14ca>return</font></b> {}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=hl_tcl::configure></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::configure {txt opt val} {
  <i><font color=#4b5d50># Sets a highlighting option's value.</font></i>
  <i><font color=#4b5d50>#   txt - text's path</font></i>
  <i><font color=#4b5d50>#   opt - option's name</font></i>
  <i><font color=#4b5d50>#   val - option's value</font></i>

  <b><font color=#3a6797>variable</font></b> my::data
  <b><font color=#3a6797>set</font></b> opt [<b><font color=#3a6797>string</font></b> toupper [<b><font color=#3a6797>string</font></b> trimleft <font color=#1b1baa>$opt</font> -]]
  <b><font color=#3a6797>set</font></b> my::data(<font color=#1b1baa>$opt</font>,<font color=#1b1baa>$txt</font>) <font color=#1b1baa>$val</font>
}
<a id=Helpers></a>
<i><font color=#4b5d50># ________________________ Helpers _________________________ #</font></i>
<a id=hl_tcl::OptName></a>
<b><font color=#ca14ca>proc</font></b> ::hl_tcl::OptName {txt opt} {
  <i><font color=#4b5d50># Gets hl_tcl option's name.</font></i>
  <i><font color=#4b5d50>#   txt - text's path</font></i>
  <i><font color=#4b5d50>#   opt - option</font></i>

  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>string</font></b> toupper [<b><font color=#3a6797>string</font></b> range <font color=#1b1baa>$opt</font> 1 end]],<font color=#1b1baa>$txt</font>
}
<a id=EOF></a>
<i><font color=#4b5d50># _________________________________ EOF _________________________________ #</font></i>

</pre>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../index.html"><font color=#1a1a1a size=6>  <b>hl_tcl.tcl</b></font></div></td></table>

</section>
<script>
  writeFooter('Generated by <a href="'+homeLINK()+'/en/tcl/alited/index.html">alited</a> &amp; <a href="'+homeLINK()+'/en/tcl/mulster/index.html">mulster</a></a>');
</script>
</div>
</body>
</html>