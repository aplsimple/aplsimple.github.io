<!DOCTYPE html><html><head><meta charset="utf-8"/>
<meta name="author" content="aplsimple">
<meta name="description" content="aplsimple's home page">
<meta name="keywords" content="aplsimple,home">
</head>
<style>
table{
background-color: #f9f9f9;
margin: 0%;
margin-bottom: 2%;
padding: 0%;
box-shadow: none;
filter: none;
}
pre{
margin: 0%;
margin-bottom: 2%;
padding: 0%;
}
</style>
<script>
function homeLINK() {
  homelink = document.baseURI;
  ilen = 19
  ibase = homelink.indexOf('aplsimple.github');
  if (ibase<0) { ibase = homelink.indexOf('aplsimple_github'); ilen += 10 };
  if (ibase>=0) { homelink = homelink.substring(0,ibase+ilen) };
  return homelink;
};
document.write(' \
<link rel="stylesheet" href="'+homeLINK()+'/en/tcl/printer/zoo/style.css">');
document.write(' \
<link rel="icon" type="image/jpg" href="'+homeLINK()+'/zoo/favicon.jpg">');
document.write('<'+'script src="'+homeLINK()+'/zoo/funcs.js">'+'<'+'/script>');
document.write('<'+'script src="'+homeLINK()+'/en/tcl/printer/zoo/this.js">'+'<'+'/script>');
</script>
<body>
<div id="wrapper">
<div name="divd1" ALIGN="CENTER"> <FONT SIZE=5em color=#b01c20><B>
<noscript>THIS PAGE IS NOT WORKING WITHOUT JAVASCRIPT!
<BR>
<BR>PLEASE, SWITCH ON JAVASCRIPT IN SETTINGS OF YOUR BROWSER AND RELOAD THE PAGE.
</noscript>
</B></FONT></div>
<div id='doc3' class='yui-t2'>
<section id=sec2>
<div id='hd' class='banner'>
<link rel="stylesheet" href="../../../css/style.css">

<title>klnd.tcl</title>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../../index.html"><font color=#1a1a1a size=6>  <b>README.md</b></font></div></td></table>

<div id="bodyContent" class="dokuwiki">
<div id="dw__toc" class="dw__toc">
<h3 class="toggle open" style="cursor: pointer;">klnd.tcl</h3>
<div aria-expanded="true" style="">

<ul class="toc">
<li><b><a href="#klnd.tcl">klnd.tcl</a></b></li>
<li><b><a href="#klnd">klnd</a></b></li>
<li><b><a href="#my">my</a></b></li>
<li><b><a href="#Go_month/year">&nbsp;&nbsp;Go month/year</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::TrimN">TrimN</a><span class=tooltiptext> my::TrimN : Strips day/month of leading 0 and space.
n - day/month</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::IsDay">IsDay</a><span class=tooltiptext> my::IsDay : Check if a button shows a day.
i - button index</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::GoYear">GoYear</a><span class=tooltiptext> my::GoYear : Shifts the year backward/forward.
i - increment for the current year
dobreak - yes when called from 'bind'</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::GoMonth">GoMonth</a><span class=tooltiptext> my::GoMonth : Shifts the month backward/forward.
i - increment for the current month
dobreak - yes when called from 'bind'</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::WeekNumbers">WeekNumbers</a><span class=tooltiptext> my::WeekNumbers : Gets the list of week numbers for a month.
day1st - 1st day of months
ttls - list of calender button's titles</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::ShowMonth">ShowMonth</a><span class=tooltiptext> my::ShowMonth : Displays a month's days.
m - month
y -year
dopopup - yes, if bind a popup menu</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::MapYMD">MapYMD</a><span class=tooltiptext> my::MapYMD : Gets a script with %y, %m, %d wildcards.</span></div></li></ul>
<li><b><a href="#Current_day">&nbsp;&nbsp;Current day</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::CurrentDate">CurrentDate</a><span class=tooltiptext> my::CurrentDate : Gets the current date.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::SetCurrentDay">SetCurrentDay</a><span class=tooltiptext> my::SetCurrentDay : Goes to the current date.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::HighlightCurrentDay">HighlightCurrentDay</a><span class=tooltiptext> my::HighlightCurrentDay : Highlights the current day's button.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::ChosenDay">ChosenDay</a><span class=tooltiptext> my::ChosenDay : Formats a chosen day and displays it at need.
show - if yes, displays the result</span></div></li></ul>
<li><b><a href="#Event_handlers">&nbsp;&nbsp;Event handlers</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::PickDay">PickDay</a><span class=tooltiptext> my::PickDay : Processes choosing a button.
i - button index
ret - returned "-code break", for double-click</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::KeyPress">KeyPress</a><span class=tooltiptext> my::KeyPress : Processes the key presses on buttons.
i - button index
K - pressed key
s - key's state</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::Enter">Enter</a><span class=tooltiptext> my::Enter : Highlights a button and makes it current.
i - button index
focusin - yes, if the button is clicked and focused
ret - "return -code"</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::Leave">Leave</a><span class=tooltiptext> my::Leave : Unhighlights a button.
i - button index</span></div></li></ul>
<li><b><a href="#Initializing">&nbsp;&nbsp;Initializing</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#my::InitSettings">InitSettings</a><span class=tooltiptext> my::InitSettings : Gets initial settings, once only.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::InitCalendar">InitCalendar</a><span class=tooltiptext> my::InitCalendar : Initializes the settings of the calendar.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::MainWidgets">MainWidgets</a><span class=tooltiptext> my::MainWidgets : Forms main widgets of calendar.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#my::DefaultLocale">DefaultLocale</a><span class=tooltiptext> my::DefaultLocale : Gets a default locale currently used in a system.</span></div></li></ul>
<li><b><a href="#UI">UI</a></b></li>
<ul class=toc><li><div class=tooltip><a href="#klnd::minYear">minYear</a><span class=tooltiptext> klnd::minYear : Gets minimal year that is correct.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::maxYear">maxYear</a><span class=tooltiptext> klnd::maxYear : Gets maximal year that is correct.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::currentYearMonthDay">currentYearMonthDay</a><span class=tooltiptext> klnd::currentYearMonthDay : Gets current year, month, day.
Returns a list of current year, month, day.</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::months">months</a><span class=tooltiptext> klnd::months : Gets a list of months according to a locale.
loc - the locale</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::weekdays">weekdays</a><span class=tooltiptext> klnd::weekdays : Gets a list of week days according to a locale.
loc - the locale
Return list of weekdays and week format (%u or %w)</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::clearup">clearup</a><span class=tooltiptext> klnd::clearup : Clearance for klnd data (variable my::p).</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::clearArgs">clearArgs</a><span class=tooltiptext> klnd::clearArgs : Removes specific options from args.
args - list of options</span></div></li></ul>
<ul class=toc><li><div class=tooltip><a href="#klnd::calendar">calendar</a><span class=tooltiptext> klnd::calendar : The main procedure of the calendar's toplevel.
args - options of the calendar</span></div></li></ul>
<li><b><a href="#EOF">EOF</a></b></li>

</ul>

</div>
</div>
</div>
<!-- TOC END -->

The <i><font color=#1b1baa>klnd</font></i> package provides a calendar widget to use along with <a href="../pave/index.html">apave</a> package.
</p><p>
  Features:
</p><p>
<li>displays localized days' and months' names</li>
<li>gets a chosen day through <code><font color=#653760>-value</font></code> or <code><font color=#653760>-tvar</font></code> (variable name) option</li>
<li>uses arrow keys to navigate through days, months and years</li>
<li>provides hot keys to navigate through months and years</li>
<li>provides buttons to navigate through months and years</li>
<li>provides a button and a hot key to set a current date</li>
<li>buttons' tips</li>
<li>shown at +X+Y coordinates / under a widget / in a parent's center / in a screen's center or under the mouse pointer</li>
<li>customizable title, date format, first week day (Sunday/Monday)</li>
<li>themeable (with ttk and <a href="../pave/index.html">apave</a> themes)</li>
<li>may be a modal (by default) or non-modal window</li>
</p><p>
  The calendar looks like this:
</p><p>
  <img src="../pave/files/widgdat2.png" class="media" alt="">
</p><p>
<h1><font color=#ca14ca> Synopsis</font></h1>
</p><p>
  To directly call the calendar, use the following commands:
<pre class="code"><b><font color=#3a6797>package</font></b> require klnd
klnd::calendar ?-option value ... ?

<i><font color=#4b5d50># or this way</font></i>
<b><font color=#3a6797>source</font></b> [<b><font color=#3a6797>file</font></b> join <font color=#1b1baa>$::apave::apaveDir</font> pickers klnd klnd.tcl]
klnd::calendar ?-option value ... ?</pre>  where <code><font color=#653760>-option</font></code> may be:
<pre class="code"><font color=#653760>-value</font> - sets an input date (omittable)
<font color=#653760>-tvar</font> - sets a variable name to hold the input/output value (omittable)
<font color=#653760>-dateformat</font> - sets the input/output date format (%D by default)
<font color=#653760>-weekday</font> - sets a first week day: %w for Sunday, %u for Monday (default)
<font color=#653760>-modal</font> - `yes` if the calendar should be a modal window (default)
<font color=#653760>-title</font> - sets the calendar's title
<font color=#653760>-geometry</font> - sets the calendar's geometry
<font color=#653760>-entry</font> - sets a widget's path to show the calendar under
<font color=#653760>-parent</font> - sets a parent toplevel window to center the calendar in
<font color=#653760>-centerme</font> - `yes` if the calendar should be centered in the screen</pre>  If <code><font color=#653760>-value</font></code> and <code><font color=#653760>-tvar</font></code> options are both set, the <code><font color=#653760>-tvar</font></code> is preferred. If both omitted, a current system date is used as input.
</p><p>
  The calendar returns a chosen date (setting also the <code><font color=#653760>-tvar</font></code> variable if any) or "" at no choice.
</p><p>
  The priority of geometry options: <code><font color=#653760>-geometry</font>, <font color=#653760>-entry</font>, <font color=#653760>-parent</font>, <font color=#653760>-centerme</font></code>. At no geometry option given, the calendar is shown under the mouse pointer.
</p><p>
  The <code><font color=#653760>-parent</font></code> option may be used along with <code><font color=#653760>-geometry</font>, <font color=#653760>-entry</font></code>, as it allows a child window to inherit the parent's attributes.
</p><p>
<h1><font color=#ca14ca> Hot keys</font></h1>
</p><p>
  The calendar provides the hotkeys Left, Right, Up, Down, PageUp, PageDown, Home, End and F3 to navigate through days, months and years.
</p><p>
  The Enter / Space keys or Double-Click are used to pick a date.
</p><p>
<h1><font color=#ca14ca> Usage in apave package</font></h1>
</p><p>
  With <a href="../pave/index.html">apave</a> package, the calendar can be used in two forms: <em>date picker</em> and <em>embedded calendar</em>:
</p><p>
<li><em>date picker</em> presents an entry field to hold an input/output date and a button to choose a date from the picker</li>
</p><p>
<li><em>embedded calendar</em> presents a full set of widgets to display a selected month of year</li>
</p><p>
  An example of using <em>date picker</em> for <a href="../pave/index.html">apave</a> layout:
<pre class="code">{dat1 labDat1 L 1 1 {} {<font color=#653760>-tvar</font> ::N::dat1 <font color=#653760>-title</font> {Date of the event} <font color=#653760>-dateformat</font> %d.%m.%Y <font color=#653760>-weekday</font> %w}}</pre>  This example includes <code><font color=#653760>-tvar</font></code> option meaning a variable name to hold the date.
</p><p>
The <em>embedded calendar</em> differs from this with <code>daT</code> type of widget used instead of <code>dat</code>. Also, this form of calendar doesn't allow using the keyboard; only the mouse is used in it.
</p><p>
  The below example is taken from <a href="../alited/index.html">alited</a>'s source:
<pre class="code">{.daT - - - - {<b><font color=#134070>pack</font></b> <font color=#653760>-fill</font> both} {<font color=#653760>-tvar</font> alited::project::klnddata(date) <font color=#653760>-com</font> {alited::project::KlndUpdate} <font color=#653760>-dateformat</font> <font color=#1b1baa>$alited::project::klnddata(dateformat)</font> <font color=#653760>-tip</font> {alited::project::KlndTip %W %D}}}</pre>  This example includes <code><font color=#653760>-com</font></code> option to run a command at clicking a day. This command can use <code>::klnd::update</code> to highlight some days in the calendar. In <a href="../alited/index.html">alited</a> these days contain  reminders of TODOs being dead-lines.
</p><p>
  Options of embedded calendar:
<pre class="code"><font color=#653760>-com</font>, <font color=#653760>-command</font> - a command to run at left-click
<font color=#653760>-popup</font> - a command to run at right-click
<font color=#653760>-currentmonth</font> - a current month to display, in form of <font color=#8b2a0e>&quot;year/month&quot;</font>
<font color=#653760>-united</font> - if yes, means <font color=#8b2a0e>&quot;united&quot;</font> calendars
<font color=#653760>-daylist</font> - a list of selected days for <font color=#8b2a0e>&quot;united&quot;</font> calendars
<font color=#653760>-hllist</font> - a list of highlighted days
<font color=#653760>-tip</font> - a command to get a day's tip</pre>A command of <code><font color=#653760>-com</font>, <font color=#653760>-command</font>, <font color=#653760>-popup</font></code> options can use wildcards: <code>%y</code>, <code>%m</code>, <code>%d</code> for year, month, day, <code>%X</code>, <code>%Y</code> for mouse pointer's coordinates.
</p><p>
A command of <code><font color=#653760>-tip</font></code> option can use wildcards: <code>%W</code> for a day widget's path, <code>%D</code> for a day.
</p><p>
  UI procedures of embedded calendar:
</p><p>
<li><code>::klnd::labelPath</code> - gets a title label's path, to change its attributes</li>
<li><code>::klnd::selectedDay</code> - gets a selected day</li>
<li><code>::klnd::getDaylist</code> - gets a list of selected days (for united calendars)</li>
<li><code>::klnd::update</code> - redraws a calendar for a month</li>
</p><p>
  The procedures use <code>obj</code> argument, which is just an index of a calendar (beginning with 1). If omitted or equal to {}, <code>obj</code> means a last created calendar.
</p><p>
  The multiple embedded calendars may be united with <code><font color=#653760>-united</font> yes</code> option, so that a user can select a list of days inside them.
</p><p>

</p>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../../index.html"><font color=#1a1a1a size=6>  <b>klnd.tcl</b></font></div></td></table>

<pre class="code"><i><font color=#4b5d50>###########################################################<a id=klnd.tcl></a></font></i>
<i><font color=#4b5d50># Name:    klnd.tcl</font></i>
<i><font color=#4b5d50># Author:  Alex Plotnikov  (aplsimple@gmail.com)</font></i>
<i><font color=#4b5d50># Date:    01/18/2022</font></i>
<i><font color=#4b5d50># Brief:   Handles calendar picker for apave package.</font></i>
<i><font color=#4b5d50># License: MIT.</font></i>
<i><font color=#4b5d50>###########################################################</font></i>

<b><font color=#3a6797>package</font></b> require Tk
<b><font color=#3a6797>package</font></b> provide klnd 1.4
<a id=klnd></a>
<i><font color=#4b5d50># ________________________ klnd _________________________ #</font></i>

<b><font color=#ca14ca>namespace</font></b> eval ::klnd {
  <b><font color=#3a6797>namespace</font></b> export calendar
  <b><font color=#ca14ca>namespace</font></b> eval my {
    <b><font color=#3a6797>variable</font></b> msgdir [<b><font color=#3a6797>file</font></b> normalize [<b><font color=#3a6797>file</font></b> join [<b><font color=#3a6797>file</font></b> dirname [<b><font color=#3a6797>info</font></b> script]] msgs]]
    <b><font color=#3a6797>variable</font></b> p
    <b><font color=#3a6797>variable</font></b> locales
    <i><font color=#4b5d50># locale 1st day of week: %u means Mon (default), %w means Sun</font></i>
    <b><font color=#3a6797>array</font></b> set locales [<b><font color=#3a6797>list</font></b> \
      en_uk %u \
      en_us %w \
      ru %u \
      ru_ru %u \
      ru_ua %u \
      uk %u \
      ua %u \
      uk_ua %u \
      ua_ua %u \
      by %u \
      be_by %u \
    ]
  }
}

<a id=my></a>
<i><font color=#4b5d50># ________________________ my _________________________ #</font></i>
<a id=Go_month/year></a>
<i><font color=#4b5d50>## ________________________ Go month/year _________________________ ##</font></i>
<a id=my::TrimN></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::TrimN {n} {
  <i><font color=#4b5d50># Strips day/month of leading 0 and space.</font></i>
  <i><font color=#4b5d50>#   n - day/month</font></i>

  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>string</font></b> trimleft <font color=#1b1baa>$n</font> { 0}]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::IsDay></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::IsDay {i} {
  <i><font color=#4b5d50># Check if a button shows a day.</font></i>
  <i><font color=#4b5d50>#   i - button index</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>expr</font></b> {![<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> w [<font color=#1b1baa>$p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$i</font>]}] && [<font color=#1b1baa>$w</font> cget <font color=#653760>-takefocus</font>]}]
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::GoYear></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::GoYear {i {dobreak no}} {
  <i><font color=#4b5d50># Shifts the year backward/forward.</font></i>
  <i><font color=#4b5d50>#   i - increment for the current year</font></i>
  <i><font color=#4b5d50>#   dobreak - yes when called from 'bind'</font></i>

  <b><font color=#3a6797>variable</font></b> p
  ShowMonth <font color=#1b1baa>$p(mvis)</font> [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$p(yvis)</font>+(<font color=#1b1baa>$i</font>)}] yes
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dobreak</font>} {<b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> break}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::GoMonth></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::GoMonth {i {dobreak no}} {
  <i><font color=#4b5d50># Shifts the month backward/forward.</font></i>
  <i><font color=#4b5d50>#   i - increment for the current month</font></i>
  <i><font color=#4b5d50>#   dobreak - yes when called from 'bind'</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>set</font></b> m [<b><font color=#3a6797>expr</font></b> {<font color=#1b1baa>$p(mvis)</font>+(<font color=#1b1baa>$i</font>)}]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$m</font>&gt;12} {<b><font color=#3a6797>set</font></b> m 1; <b><font color=#3a6797>incr</font></b> p(yvis)}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$m</font>&lt;1} {<b><font color=#3a6797>set</font></b> m 12; <b><font color=#3a6797>incr</font></b> p(yvis) -1}
  ShowMonth <font color=#1b1baa>$m</font> <font color=#1b1baa>$p(yvis)</font> yes
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dobreak</font>} {<b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> break}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::WeekNumbers></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::WeekNumbers {day1st ttls} {
  <i><font color=#4b5d50># Gets the list of week numbers for a month.</font></i>
  <i><font color=#4b5d50>#   day1st - 1st day of months</font></i>
  <i><font color=#4b5d50>#   ttls - list of calender button's titles</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>set</font></b> res [<b><font color=#3a6797>list</font></b>]
  <b><font color=#3a6797>set</font></b> secw <font color=#1b1baa>$day1st</font>
  <b><font color=#3a6797>set</font></b> incd 0
  <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 1} {<font color=#1b1baa>$i</font>&lt;7} {<b><font color=#3a6797>incr</font></b> i} {
    <b><font color=#3a6797>set</font></b> dtext [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$secw</font> <font color=#653760>-format</font> %V]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$p(weeks)</font>==2} {
      <i><font color=#4b5d50># 2nd (vulgar) mode of week numeration</font></i>
      <b><font color=#3a6797>set</font></b> month [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$secw</font> <font color=#653760>-format</font> %m]
      <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$secw</font> <font color=#653760>-format</font> %Y]&gt;[<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$day1st</font> <font color=#653760>-format</font> %Y]} {
        <b><font color=#3a6797>set</font></b> dtext {}
      } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$i</font>==1 && <font color=#1b1baa>$month</font> eq {01} && <font color=#1b1baa>$dtext</font> ne {01}} {
        <b><font color=#3a6797>set</font></b> dtext {01}
        <b><font color=#3a6797>set</font></b> incd 1
      } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$month</font>==12 && <font color=#1b1baa>$dtext</font> eq {01}} {
        <b><font color=#3a6797>set</font></b> dtext [<b><font color=#3a6797>incr</font></b> dtextprev]
      } <b><font color=#3a6797>else</font></b> {
        <b><font color=#3a6797>set</font></b> dtext [<b><font color=#3a6797>string</font></b> range 0[<b><font color=#3a6797>expr</font></b> {[<b><font color=#3a6797>string</font></b> trimleft <font color=#1b1baa>$dtext</font> 0]+<font color=#1b1baa>$incd</font>}] end-1 end]
      }
      <b><font color=#3a6797>set</font></b> dtextprev <font color=#1b1baa>$dtext</font>
    }
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i</font>==5 && [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$ttls</font> 28] eq {} || <font color=#1b1baa>$i</font>==6 && [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$ttls</font> 35] eq {}} {
      <b><font color=#3a6797>set</font></b> dtext {}
    }
    <b><font color=#3a6797>lappend</font></b> res <font color=#1b1baa>$dtext</font>
    <b><font color=#3a6797>set</font></b> w [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$secw</font> <font color=#653760>-format</font> %w]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$w</font>} {<b><font color=#3a6797>set</font></b> w [<b><font color=#3a6797>expr</font></b> {8-<font color=#1b1baa>$w</font>}]} {<b><font color=#3a6797>set</font></b> w 1}
    <b><font color=#3a6797>set</font></b> secw [<b><font color=#3a6797>clock</font></b> add <font color=#1b1baa>$secw</font> <font color=#1b1baa>$w</font> days]
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$res</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::ShowMonth></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::ShowMonth {m y {dopopup no}} {
  <i><font color=#4b5d50># Displays a month's days.</font></i>
  <i><font color=#4b5d50>#   m - month</font></i>
  <i><font color=#4b5d50>#   y -year</font></i>
  <i><font color=#4b5d50>#   dopopup - yes, if bind a popup menu</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>set</font></b> sec [CurrentDate]
  <b><font color=#3a6797>set</font></b> y [<b><font color=#3a6797>expr</font></b> {max(<font color=#1b1baa>$y</font>,1753)}]
  ::baltip::tip [<font color=#1b1baa>$p(obj)</font> BuT_IM_KLND_0] \
    <font color=#8b2a0e>&quot;<font color=#1b1baa>[</font>::msgcat::mc <font color=#1b1baa>{</font>Current date<font color=#1b1baa>}]</font>: <font color=#1b1baa>[</font>clock format <font color=#1b1baa>$</font>sec -format <font color=#1b1baa>$</font>p(dformat) -locale <font color=#1b1baa>$</font>p(loc)<font color=#1b1baa>]</font>\n(F3)&quot;</font> <font color=#653760>-under</font> 5
  <i><font color=#4b5d50># display month & year</font></i>
  [<font color=#1b1baa>$p(obj)</font> LabMonth] configure <font color=#653760>-text</font>  <font color=#8b2a0e>&quot;<font color=#1b1baa>[</font>lindex <font color=#1b1baa>$</font>p(months) <font color=#1b1baa>[</font>expr <font color=#1b1baa>{$</font>m-1<font color=#1b1baa>}]]</font> <font color=#1b1baa>$</font>y&quot;</font> \
    <font color=#653760>-font</font> [::apave::obj boldDefFont [<b><font color=#3a6797>expr</font></b> {[::apave::obj basicFontSize]+2}]]
  <i><font color=#4b5d50># display day names</font></i>
  <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 1} {<font color=#1b1baa>$i</font>&lt;8} {<b><font color=#3a6797>incr</font></b> i} {
    [<font color=#1b1baa>$p(obj)</font> LabDay<font color=#1b1baa>$i</font>] configure <font color=#653760>-text</font> <font color=#8b2a0e>&quot; <font color=#1b1baa>[</font>lindex <font color=#1b1baa>$</font>p(days) <font color=#1b1baa>$</font>i-1<font color=#1b1baa>]</font> &quot;</font>
  }
  <i><font color=#4b5d50># 1st day of the month's first week:</font></i>
  <b><font color=#3a6797>set</font></b> day1st [<b><font color=#3a6797>clock</font></b> scan <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>m/1/<font color=#1b1baa>$</font>y&quot;</font> <font color=#653760>-format</font> %D]
  <b><font color=#3a6797>set</font></b> i0 [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$day1st</font> <font color=#653760>-format</font> %w]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$p(weekday)</font> eq <font color=#8b2a0e>&quot;%u&quot;</font>} {<b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i0</font>} {<b><font color=#3a6797>incr</font></b> i0 -1} {<b><font color=#3a6797>set</font></b> i0 6}}
  <i><font color=#4b5d50># get the last day of month</font></i>
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>set</font></b> yl <font color=#1b1baa>$y</font>] && [<b><font color=#3a6797>set</font></b> ml <font color=#1b1baa>$m</font>]==12} {<b><font color=#3a6797>set</font></b> ml 1; <b><font color=#3a6797>incr</font></b> yl}
  <b><font color=#3a6797>set</font></b> lday [<b><font color=#3a6797>clock</font></b> format [<b><font color=#3a6797>clock</font></b> scan <font color=#8b2a0e>&quot;<font color=#1b1baa>[</font>incr ml<font color=#1b1baa>]</font>/1/<font color=#1b1baa>$</font>yl 1 day ago&quot;</font>] <font color=#653760>-format</font> %d]
  <b><font color=#3a6797>set</font></b> iday [<b><font color=#3a6797>set</font></b> p(icurr) 0]
  <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 1} {<font color=#1b1baa>$i</font>&lt;38} {<b><font color=#3a6797>incr</font></b> i} {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i</font>&lt;=<font color=#1b1baa>$i0</font> || <font color=#1b1baa>$iday</font>&gt;=<font color=#1b1baa>$lday</font>} {
      <b><font color=#3a6797>set</font></b> ttl {    }
      <b><font color=#3a6797>set</font></b> att <font color=#8b2a0e>&quot;-takefocus 0 -activebackground <font color=#1b1baa>$</font>p(bg1) -overrelief flat&quot;</font>
      <b><font color=#3a6797>set</font></b> script {}
    } <b><font color=#3a6797>else</font></b> {
      <b><font color=#3a6797>set</font></b> ttl [<b><font color=#3a6797>incr</font></b> iday]
      <b><font color=#3a6797>set</font></b> att <font color=#8b2a0e>&quot;-takefocus 1 -activeforeground <font color=#1b1baa>$</font>p(fg0) -activebackground <font color=#1b1baa>$</font>p(bg0) -overrelief raised&quot;</font>
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$iday</font>==<font color=#1b1baa>$p(dvis)</font> || (<font color=#1b1baa>$iday</font>==<font color=#1b1baa>$lday</font> && <font color=#1b1baa>$iday</font>&lt;<font color=#1b1baa>$p(dvis)</font>)} {
        <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>info</font></b> exists p(after)]} {<b><font color=#3a6797>set</font></b> af 20} {<b><font color=#3a6797>set</font></b> af 200} ;<i><font color=#4b5d50># less at key pressing tight</font></i>
        <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>after</font></b> cancel <font color=#1b1baa>$p(after)</font>}
        <b><font color=#3a6797>set</font></b> p(after) [<b><font color=#3a6797>after</font></b> <font color=#1b1baa>$af</font> <font color=#8b2a0e>&quot;::klnd::my::Enter <font color=#1b1baa>$</font>i; ::klnd::my::HighlightCurrentDay&quot;</font>]
      }
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$iday</font>==1} {<b><font color=#3a6797>set</font></b> p(d1st) <font color=#1b1baa>$i</font>}
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$y</font>==<font color=#1b1baa>$p(y)</font> && <font color=#1b1baa>$m</font>==<font color=#1b1baa>$p(m)</font> && <font color=#1b1baa>$iday</font>==<font color=#1b1baa>$p(d)</font>} {
        <b><font color=#3a6797>set</font></b> p(icurr) <font color=#1b1baa>$i</font>  ;<i><font color=#4b5d50># button's index of the current date</font></i>
      }
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dopopup</font>} {
        <b><font color=#3a6797>set</font></b> script [MapYMD <font color=#1b1baa>$p(popup)</font> <font color=#1b1baa>$y</font> <font color=#1b1baa>$m</font> <font color=#1b1baa>$iday</font>]
      }
    }
    <b><font color=#3a6797>lappend</font></b> ttls [<b><font color=#3a6797>string</font></b> trim <font color=#1b1baa>$ttl</font>]
    <b><font color=#3a6797>set</font></b> wbut [<font color=#1b1baa>$p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$i</font>]
    <font color=#1b1baa>$wbut</font> configure {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$att</font> <font color=#653760>-fg</font> <font color=#1b1baa>$p(fg1)</font> <font color=#653760>-bg</font> <font color=#1b1baa>$p(bg1)</font> <font color=#653760>-relief</font> flat <font color=#653760>-text</font> <font color=#1b1baa>$ttl</font>
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$dopopup</font> && <font color=#1b1baa>$p(popup)</font> ne {}} {
      <b><font color=#134070>bind</font></b> <font color=#1b1baa>$wbut</font> &lt;Button-3&gt; <font color=#1b1baa>$script</font>
    }
  }
  <b><font color=#3a6797>set</font></b> wnums [WeekNumbers <font color=#1b1baa>$day1st</font> <font color=#1b1baa>$ttls</font>]
  <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 0} {<font color=#1b1baa>$i</font>&lt;6} {} {
    <b><font color=#3a6797>set</font></b> wnum [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$wnums</font> <font color=#1b1baa>$i</font>]
    <b><font color=#3a6797>set</font></b> wbut [<font color=#1b1baa>$p(obj)</font> BuTW[<b><font color=#3a6797>incr</font></b> i]]
    <font color=#1b1baa>$wbut</font> configure {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$::klnd::TMPATTW</font> <font color=#653760>-text</font> <font color=#1b1baa>$wnum</font>
  }
  <b><font color=#3a6797>set</font></b> p(mvis) <font color=#1b1baa>$m</font>  ;<i><font color=#4b5d50># month & year currently visible</font></i>
  <b><font color=#3a6797>set</font></b> p(yvis) <font color=#1b1baa>$y</font>
}

<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::MapYMD></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::MapYMD {script y m d} {
  <i><font color=#4b5d50># Gets a script with %y, %m, %d wildcards.</font></i>

  <b><font color=#3a6797>string</font></b> map [<b><font color=#3a6797>list</font></b> %y <font color=#1b1baa>$y</font> %m <font color=#1b1baa>$m</font> %d <font color=#1b1baa>$d</font>] <font color=#1b1baa>$script</font>
}
<a id=Current_day></a>
<i><font color=#4b5d50>## ________________________ Current day _________________________ ##</font></i>
<a id=my::CurrentDate></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::CurrentDate {} {

  <i><font color=#4b5d50># Gets the current date.</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>set</font></b> sec [<b><font color=#3a6797>clock</font></b> seconds]
  <b><font color=#3a6797>lassign</font></b> [<b><font color=#3a6797>split</font></b> [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$sec</font> <font color=#653760>-format</font> <font color=#1b1baa>$p(FINT)</font>] /] p(y) p(m) p(d)
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$sec</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::SetCurrentDay></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::SetCurrentDay {} {
  <i><font color=#4b5d50># Goes to the current date.</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>set</font></b> p(dvis) 0
  ShowMonth <font color=#1b1baa>$p(m)</font> <font color=#1b1baa>$p(y)</font>
  Enter <font color=#1b1baa>$p(icurr)</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::HighlightCurrentDay></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::HighlightCurrentDay {} {
  <i><font color=#4b5d50># Highlights the current day's button.</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>catch</font></b> {[<font color=#1b1baa>$p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$p(icurr)</font>] configure <font color=#653760>-fg</font> <font color=#1b1baa>$p(fg2)</font> <font color=#653760>-bg</font> <font color=#1b1baa>$p(bg2)</font>}
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::ChosenDay></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::ChosenDay {{show no}} {
  <i><font color=#4b5d50># Formats a chosen day and displays it at need.</font></i>
  <i><font color=#4b5d50>#   show - if yes, displays the result</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>set</font></b> res {}
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$p(dvis)</font>} {
    <b><font color=#3a6797>set</font></b> res [<b><font color=#3a6797>clock</font></b> format [<b><font color=#3a6797>clock</font></b> scan <font color=#1b1baa>$p(mvis)</font>/<font color=#1b1baa>$p(dvis)</font>/<font color=#1b1baa>$p(yvis)</font> <font color=#653760>-format</font> %D] <font color=#653760>-format</font> <font color=#1b1baa>$p(dformat)</font>]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$show</font>} {[<font color=#1b1baa>$p(obj)</font> ButOK] configure <font color=#653760>-text</font> <font color=#1b1baa>$res</font>}
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$res</font>
}
<a id=Event_handlers></a>
<i><font color=#4b5d50>## ________________________ Event handlers _________________________ ##</font></i>
<a id=my::PickDay></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::PickDay {{i -1} {ret <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Processes choosing a button.</font></i>
  <i><font color=#4b5d50>#   i - button index</font></i>
  <i><font color=#4b5d50>#   ret - returned &quot;-code break&quot;, for double-click</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i</font>==-1} {<b><font color=#3a6797>set</font></b> i <font color=#1b1baa>$p(ienter)</font>}
  <b><font color=#3a6797>if</font></b> {[IsDay <font color=#1b1baa>$i</font>]} {<font color=#1b1baa>$p(obj)</font> res <font color=#1b1baa>$p(win)</font> 1}
  <b><font color=#ca14ca>return</font></b> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$ret</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::KeyPress></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::KeyPress {i K s} {
  <i><font color=#4b5d50># Processes the key presses on buttons.</font></i>
  <i><font color=#4b5d50>#   i - button index</font></i>
  <i><font color=#4b5d50>#   K - pressed key</font></i>
  <i><font color=#4b5d50>#   s - key's state</font></i>

  <b><font color=#3a6797>variable</font></b> p
  Leave <font color=#1b1baa>$i</font>
  <b><font color=#3a6797>switch</font></b> <font color=#653760>-glob</font> <font color=#1b1baa>$K</font> {
    Left {<b><font color=#3a6797>incr</font></b> i -1}
    Right {<b><font color=#3a6797>incr</font></b> i}
    Up {<b><font color=#3a6797>incr</font></b> i -7}
    Down {<b><font color=#3a6797>incr</font></b> i 7}
    Enter - Return - space {<font color=#1b1baa>$p(obj)</font> res <font color=#1b1baa>$p(win)</font> 1}
    F3 {SetCurrentDay; <b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> break}
    *Tab* {
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$s</font>%2} {<b><font color=#3a6797>set</font></b> b Close} {<b><font color=#3a6797>set</font></b> b OK}
      <b><font color=#134070>focus</font></b> [<font color=#1b1baa>$p(obj)</font> But<font color=#1b1baa>$b</font>]
      <b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> break
    }
    <b><font color=#3a6797>default</font></b> {Enter <font color=#1b1baa>$i</font>; <b><font color=#ca14ca>return</font></b>}
  }
  <b><font color=#3a6797>if</font></b> {[IsDay <font color=#1b1baa>$i</font>]} {
    Enter <font color=#1b1baa>$i</font>
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$K</font> in {Left Up}} {
    GoMonth -1
  } <b><font color=#3a6797>else</font></b> {
    GoMonth 1
  }
  <b><font color=#ca14ca>return</font></b> <font color=#653760>-code</font> break
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::Enter></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::Enter {i {focusin 0} {ret <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Highlights a button and makes it current.</font></i>
  <i><font color=#4b5d50>#   i - button index</font></i>
  <i><font color=#4b5d50>#   focusin - yes, if the button is clicked and focused</font></i>
  <i><font color=#4b5d50>#   ret - &quot;return -code&quot;</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>if</font></b> {![IsDay <font color=#1b1baa>$i</font>]} {<b><font color=#ca14ca>return</font></b> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$ret</font>}
  Leave
  [<b><font color=#3a6797>set</font></b> w [<font color=#1b1baa>$p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$i</font>]] configure <font color=#653760>-fg</font> <font color=#1b1baa>$p(fgsel)</font> <font color=#653760>-bg</font> <font color=#1b1baa>$p(bgsel)</font>
  <b><font color=#3a6797>set</font></b> p(ienter) <font color=#1b1baa>$i</font>
  <b><font color=#3a6797>set</font></b> p(dvis) [<font color=#1b1baa>$w</font> cget <font color=#653760>-text</font>]
  <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>after</font></b> cancel <font color=#1b1baa>$p(after2)</font>}
  <b><font color=#3a6797>set</font></b> p(after2) [<b><font color=#3a6797>after</font></b> 10 <font color=#8b2a0e>&quot;if \[winfo exists <font color=#1b1baa>$</font>w\] <font color=#1b1baa>{</font>focus -force <font color=#1b1baa>$</font>w<font color=#1b1baa>}</font>&quot;</font>]
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$focusin</font> && <font color=#1b1baa>$p(com)</font> ne {}} {
    <b><font color=#3a6797>eval</font></b> [MapYMD <font color=#1b1baa>$p(com)</font> <font color=#1b1baa>$p(yvis)</font> <font color=#1b1baa>$p(mvis)</font> <font color=#1b1baa>$p(dvis)</font>]
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::Leave></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::Leave {{i 0}} {
  <i><font color=#4b5d50># Unhighlights a button.</font></i>
  <i><font color=#4b5d50>#   i - button index</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i</font> && ![[<font color=#1b1baa>$p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$i</font>] cget <font color=#653760>-takefocus</font>]} <b><font color=#ca14ca>return</font></b>
  <b><font color=#3a6797>foreach</font></b> n [<b><font color=#3a6797>list</font></b> <font color=#1b1baa>$i</font> <font color=#1b1baa>$p(ienter)</font>] {
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$n</font>} {[<font color=#1b1baa>$p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$n</font>] configure <font color=#653760>-fg</font> <font color=#1b1baa>$p(fg1)</font> <font color=#653760>-bg</font> <font color=#1b1baa>$p(bg1)</font>}
  }
  HighlightCurrentDay
}
<a id=Initializing></a>
<i><font color=#4b5d50>## ________________________ Initializing _________________________ ##</font></i>
<a id=my::InitSettings></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::InitSettings {} {
  <i><font color=#4b5d50># Gets initial settings, once only.</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>variable</font></b> msgdir
  <b><font color=#3a6797>array</font></b> set p [<b><font color=#3a6797>list</font></b> FINT %Y/%N/%e days {} months {} \
    d 0 m 0 y 0 dvis 0 mvis 0 yvis 0 icurr 0 ienter 0 weekday {} \
    d1st 1 width 2 loc en_uk]
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>info</font></b> exists :klnd::my::prevY]} {
    <b><font color=#3a6797>foreach</font></b> {i icon} {0 date 1 previous2 2 previous 3 next 4 next2} {
      <b><font color=#134070>image</font></b> create photo IM_KLND_<font color=#1b1baa>$i</font> <font color=#653760>-data</font> [::apave::iconData <font color=#1b1baa>$icon</font> small]
    }
    <b><font color=#3a6797>lassign</font></b> [::apave::obj csGet] p(fg0) p(fg1) p(bg0) p(bg1) - p(bgsel) p(fgsel) - - p(fgh) - - - - p(fg2) p(bg2)
    <i><font color=#4b5d50># localized stuff</font></i>
    <b><font color=#3a6797>catch</font></b> {::msgcat::mcload <font color=#1b1baa>$msgdir</font>}
    <b><font color=#3a6797>set</font></b> ::klnd::my::prevY [::msgcat::mc {Previous year}]
    <b><font color=#3a6797>set</font></b> ::klnd::my::prevM [::msgcat::mc {Previous month}]
    <b><font color=#3a6797>set</font></b> ::klnd::my::nextY [::msgcat::mc {Next year}]
    <b><font color=#3a6797>set</font></b> ::klnd::my::nextM [::msgcat::mc {Next month}]
    <b><font color=#3a6797>set</font></b> ::klnd::my::Close [::msgcat::mc Close]
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::InitCalendar></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::InitCalendar {args} {
  <i><font color=#4b5d50># Initializes the settings of the calendar.</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>variable</font></b> locales
  InitSettings
  <b><font color=#3a6797>lassign</font></b> [::apave::parseOptions <font color=#1b1baa>$args</font> <font color=#653760>-locale</font> [::msgcat::mclocale] \
  <font color=#653760>-title</font> {} <font color=#653760>-value</font> {} <font color=#653760>-tvar</font> {} <font color=#653760>-parent</font> {} <font color=#653760>-dateformat</font> %D <font color=#653760>-weeks</font> 0 \
  <font color=#653760>-weekday</font> {} <font color=#653760>-centerme</font> {} <font color=#653760>-geometry</font> {} <font color=#653760>-entry</font> {} <font color=#653760>-com</font> {} <font color=#653760>-command</font> {} \
  <font color=#653760>-currentmonth</font> {} <font color=#653760>-united</font> no <font color=#653760>-daylist</font> {-} <font color=#653760>-hllist</font> {} <font color=#653760>-popup</font> {} <font color=#653760>-tip</font> {} <font color=#653760>-width</font> 2] \
    loc title datevalue tvar parent p(dformat) p(weeks) \
    p(weekday) centerme geo entry com1 com2 \
    p(currentmonth) p(united) p(daylist) p(hllist) p(popup) p(tip) p(width)
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$com2</font> eq {}} {<b><font color=#3a6797>set</font></b> p(com) <font color=#1b1baa>$com1</font>} {<b><font color=#3a6797>set</font></b> p(com) <font color=#1b1baa>$com2</font>}
  <i><font color=#4b5d50># get localized week day names</font></i>
  <b><font color=#3a6797>lassign</font></b> [::klnd::weekdays <font color=#1b1baa>$loc</font>] p(days) p(weekday)
  <i><font color=#4b5d50># get localized month names</font></i>
  <b><font color=#3a6797>set</font></b> p(months) [::klnd::months <font color=#1b1baa>$loc</font>]
  <b><font color=#3a6797>set</font></b> p(loc) <font color=#1b1baa>$loc</font>
  <b><font color=#3a6797>set</font></b> p(tvar) <font color=#1b1baa>$tvar</font>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$tvar</font> ne {}} {
    <b><font color=#3a6797>set</font></b> datevalue [<b><font color=#3a6797>set</font></b> <font color=#1b1baa>$tvar</font>]
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$p(daylist)</font> ne {-}} {
    <b><font color=#3a6797>set</font></b> datevalue [<b><font color=#3a6797>lindex</font></b> <font color=#1b1baa>$p(daylist)</font> 0]
  }
  <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>unset</font></b> p(after)} ;<i><font color=#4b5d50># to pause more at start</font></i>
  <i><font color=#4b5d50># colors to be used</font></i>
  CurrentDate
  <b><font color=#3a6797>set</font></b> p(yvis) <font color=#1b1baa>$p(y)</font>  ;<i><font color=#4b5d50># by default, the selected date = the current date</font></i>
  <b><font color=#3a6797>set</font></b> p(mvis) <font color=#1b1baa>$p(m)</font>
  <b><font color=#3a6797>set</font></b> p(dvis) <font color=#1b1baa>$p(d)</font>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$title</font> eq {}} {<b><font color=#3a6797>set</font></b> title [::msgcat::mc Calendar]}
  <b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> p(dformat) [<b><font color=#3a6797>subst</font></b> <font color=#1b1baa>$p(dformat)</font>]}
  <i><font color=#4b5d50># get the day to display at start</font></i>
  <b><font color=#3a6797>if</font></b> {![<b><font color=#3a6797>catch</font></b> {<b><font color=#3a6797>set</font></b> ym [<b><font color=#3a6797>clock</font></b> scan <font color=#1b1baa>$datevalue</font> <font color=#653760>-format</font> <font color=#1b1baa>$p(dformat)</font>]}]} {
    <b><font color=#3a6797>set</font></b> p(m) [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$ym</font> <font color=#653760>-format</font> %N]
    <b><font color=#3a6797>set</font></b> p(y) [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$ym</font> <font color=#653760>-format</font> %Y]
    <b><font color=#3a6797>set</font></b> p(dvis) [<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$ym</font> <font color=#653760>-format</font> %e]
  }
  ::apave::obj untouchWidgets *KLND*
  <b><font color=#3a6797>list</font></b> <font color=#1b1baa>$title</font> <font color=#1b1baa>$datevalue</font> <font color=#1b1baa>$tvar</font> <font color=#1b1baa>$parent</font> <font color=#1b1baa>$centerme</font> <font color=#1b1baa>$geo</font> <font color=#1b1baa>$entry</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::MainWidgets></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::MainWidgets {} {
  <i><font color=#4b5d50># Forms main widgets of calendar.</font></i>

  <b><font color=#3a6797>variable</font></b> p
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$p(tip)</font> eq {}} {
    <b><font color=#3a6797>set</font></b> ::klnd::TMPTIP {}
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> tip [<b><font color=#3a6797>string</font></b> map [<b><font color=#3a6797>list</font></b> \{ ( \} )] <font color=#1b1baa>$p(tip)</font>] ;<i><font color=#4b5d50># for a possible bad list</font></i>
    <b><font color=#3a6797>set</font></b> ::klnd::TMPTIP <font color=#8b2a0e>&quot;-tip <font color=#1b1baa>{$</font>tip<font color=#1b1baa>}</font>&quot;</font>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$p(weeks)</font>} {<b><font color=#3a6797>set</font></b> ::klnd::TMPPACKW {}} {<b><font color=#3a6797>set</font></b> ::klnd::TMPPACKW forget}
  <b><font color=#3a6797>if</font></b> {[::iswindows]} {<b><font color=#3a6797>set</font></b> pady 2} {<b><font color=#3a6797>set</font></b> pady 1}
  <b><font color=#3a6797>set</font></b> ::klnd::TMPATTW <font color=#8b2a0e>&quot;-font <font color=#1b1baa>{$</font>::apave::FONTMAIN<font color=#1b1baa>}</font> -padx 0 -pady <font color=#1b1baa>$</font>pady \</font>
<font color=#8b2a0e>    -activeforeground <font color=#1b1baa>$</font>p(fgh) -activebackground <font color=#1b1baa>$</font>p(bg1) -foreground <font color=#1b1baa>$</font>p(fgh) \</font>
<font color=#8b2a0e>    -relief flat -overrelief flat -takefocus 0 -highlightthickness 0 -width 2&quot;</font>
  <b><font color=#ca14ca>return</font></b> {
    {fra - - 1 7 {<font color=#653760>-st</font> new} {}} \
    {.frATool - - 1 7 {<font color=#653760>-st</font> new} {<font color=#653760>-bg</font> <font color=#1b1baa>$::klnd::my::p(bg1)</font>}}
    {.frATool.tool - - - - {<b><font color=#134070>pack</font></b> <font color=#653760>-side</font> top} {<font color=#653760>-array</font> {
      IM_KLND_0 {::klnd::my::SetCurrentDay} sev 2
      IM_KLND_1 {{::klnd::my::GoYear -1} <font color=#653760>-tip</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>::klnd::my::prevY\n(Home)@@-under 5&quot;</font>} h_ 1
      IM_KLND_2 {{::klnd::my::GoMonth -1} <font color=#653760>-tip</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>::klnd::my::prevM\n(PageUp)@@-under 5&quot;</font>} h_ 2
      LabMonth {<font color=#8b2a0e>&quot;&quot;</font> {<font color=#653760>-fill</font> x <font color=#653760>-expand</font> 1} {<font color=#653760>-anchor</font> center <font color=#653760>-w</font> 14}} h_ 1
      IM_KLND_3 {{::klnd::my::GoMonth 1} <font color=#653760>-tip</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>::klnd::my::nextM\n(PageDown)@@-under 5&quot;</font>} h_ 2
      IM_KLND_4 {{::klnd::my::GoYear 1} <font color=#653760>-tip</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>::klnd::my::nextY\n(End)@@-under 5&quot;</font>}
      }}}
    {.frAW .frATool T - - {<font color=#653760>-padx</font> 0} {<font color=#653760>-bg</font> <font color=#1b1baa>$::klnd::my::p(bg1)</font> <font color=#653760>-w</font> 0 <font color=#653760>-borderwidth</font> 0}}
    {.frAW.labw - - 1 1 {<b><font color=#134070>pack</font></b> <font color=#653760>-pady</font> 1}}
    {.frAW.BuTW1 + T 1 1 {<b><font color=#134070>pack</font></b> <font color=#1b1baa>$::klnd::TMPPACKW</font> <font color=#653760>-pady</font> 1} {<font color=#1b1baa>$::klnd::TMPATTW</font>}}
    {.frAW.BuTW2 + T 1 1 {<b><font color=#134070>pack</font></b> <font color=#1b1baa>$::klnd::TMPPACKW</font> <font color=#653760>-pady</font> 1} {<font color=#1b1baa>$::klnd::TMPATTW</font>}}
    {.frAW.BuTW3 + T 1 1 {<b><font color=#134070>pack</font></b> <font color=#1b1baa>$::klnd::TMPPACKW</font> <font color=#653760>-pady</font> 1} {<font color=#1b1baa>$::klnd::TMPATTW</font>}}
    {.frAW.BuTW4 + T 1 1 {<b><font color=#134070>pack</font></b> <font color=#1b1baa>$::klnd::TMPPACKW</font> <font color=#653760>-pady</font> 1} {<font color=#1b1baa>$::klnd::TMPATTW</font>}}
    {.frAW.BuTW5 + T 1 1 {<b><font color=#134070>pack</font></b> <font color=#1b1baa>$::klnd::TMPPACKW</font> <font color=#653760>-pady</font> 1} {<font color=#1b1baa>$::klnd::TMPATTW</font>}}
    {.frAW.BuTW6 + T 1 1 {<b><font color=#134070>pack</font></b> <font color=#1b1baa>$::klnd::TMPPACKW</font> <font color=#653760>-pady</font> 1} {<font color=#1b1baa>$::klnd::TMPATTW</font>}}
    {.frADays .frAW L 1 1 {<font color=#653760>-st</font> nsew} {<font color=#653760>-bg</font> <font color=#1b1baa>$::klnd::my::p(bg1)</font>}}
    {.frADays.tcl {
      <i><font color=#4b5d50># make headers and buttons of days</font></i>
      <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$::tcl_platform(platform)</font> eq {windows}} {
        <b><font color=#3a6797>set</font></b> att {<font color=#653760>-highlightthickness</font> 1}
      } <b><font color=#3a6797>else</font></b> {
        <b><font color=#3a6797>set</font></b> att {<font color=#653760>-highlightthickness</font> 0}
      }
      <b><font color=#3a6797>set</font></b> wt -
      <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 1} {<font color=#1b1baa>$i</font>&lt;45} {<b><font color=#3a6797>incr</font></b> i} {
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i</font>&lt;8} {<b><font color=#3a6797>set</font></b> cur <font color=#8b2a0e>&quot;.frADays.LabDay<font color=#1b1baa>$</font>i&quot;</font>} {<b><font color=#3a6797>set</font></b> cur <font color=#8b2a0e>&quot;.frADays.BuT_KLNDSTD<font color=#1b1baa>[</font>expr <font color=#1b1baa>{$</font>i-7<font color=#1b1baa>}]</font>&quot;</font>}
        <b><font color=#3a6797>if</font></b> {(<font color=#1b1baa>$i</font>%7)!=1} {<b><font color=#3a6797>set</font></b> p L; <b><font color=#3a6797>set</font></b> pw <font color=#1b1baa>$pr</font>} {<b><font color=#3a6797>set</font></b> p T; <b><font color=#3a6797>set</font></b> pw <font color=#1b1baa>$wt</font>; <b><font color=#3a6797>set</font></b> wt <font color=#1b1baa>$cur</font>}
        <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$i</font>&lt;8} {
          <b><font color=#3a6797>set</font></b> lwid <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>cur <font color=#1b1baa>$</font>pw <font color=#1b1baa>$</font>p 1 1 <font color=#1b1baa>{</font>-st ew<font color=#1b1baa>}</font> <font color=#1b1baa>{</font>-anchor center -foreground <font color=#1b1baa>$</font>::klnd::my::p(fgh) -background <font color=#1b1baa>$</font>::klnd::my::p(bg1)<font color=#1b1baa>}</font>&quot;</font>
        } <b><font color=#3a6797>else</font></b> {
          <b><font color=#3a6797>set</font></b> lwid <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>cur <font color=#1b1baa>$</font>pw <font color=#1b1baa>$</font>p 1 1 <font color=#1b1baa>{</font>-st ew<font color=#1b1baa>}</font> <font color=#1b1baa>{</font>-relief flat -overrelief raised -takefocus 0 -padx 8 -pady 1 -font <font color=#1b1baa>{$</font>::apave::FONTMAIN<font color=#1b1baa>}</font> -com <font color=#1b1baa>{</font>::klnd::my::Enter <font color=#1b1baa>[</font>expr <font color=#1b1baa>{$</font>i-7<font color=#1b1baa>}]</font> 1<font color=#1b1baa>}</font> <font color=#1b1baa>$</font>::klnd::TMPTIP <font color=#1b1baa>$</font>att -w 2 -background <font color=#1b1baa>$</font>::klnd::my::p(bg1)<font color=#1b1baa>}</font>&quot;</font>
        }
        %C <font color=#1b1baa>$lwid</font>
        <b><font color=#3a6797>set</font></b> pr <font color=#1b1baa>$cur</font>
      }
    }}
  }
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=my::DefaultLocale></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::my::DefaultLocale {} {
  <i><font color=#4b5d50># Gets a default locale currently used in a system.</font></i>

  <b><font color=#ca14ca>return</font></b> [<b><font color=#3a6797>lindex</font></b> [::msgcat::mcpreferences] 0]
}
<a id=UI></a>
<i><font color=#4b5d50># ________________________ UI _________________________ #</font></i>
<a id=klnd::minYear></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::minYear {} {
  <i><font color=#4b5d50># Gets minimal year that is correct.</font></i>

  <b><font color=#ca14ca>return</font></b> 1753
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::maxYear></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::maxYear {} {
  <i><font color=#4b5d50># Gets maximal year that is correct.</font></i>

  <b><font color=#ca14ca>return</font></b> 9999
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::currentYearMonthDay></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::currentYearMonthDay {} {
  <i><font color=#4b5d50># Gets current year, month, day.</font></i>
  <i><font color=#4b5d50># Returns a list of current year, month, day.</font></i>

  <b><font color=#3a6797>set</font></b> cl [<b><font color=#3a6797>clock</font></b> seconds]
  <b><font color=#3a6797>foreach</font></b> d {Y N e} {<b><font color=#3a6797>lappend</font></b> res {<b><font color=#3a6797>*</font></b>}[<b><font color=#3a6797>clock</font></b> format <font color=#1b1baa>$cl</font> <font color=#653760>-format</font> %<font color=#1b1baa>$d</font>]}
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$res</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::months></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::months {{loc <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Gets a list of months according to a locale.</font></i>
  <i><font color=#4b5d50>#   loc - the locale</font></i>

  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$loc</font> eq {}} {<b><font color=#3a6797>set</font></b> loc [my::DefaultLocale]}
  <b><font color=#3a6797>set</font></b> months [<b><font color=#3a6797>list</font></b>]
  <b><font color=#3a6797>foreach</font></b> i {01 02 03 04 05 06 07 08 09 10 11 12} {
    <b><font color=#3a6797>lappend</font></b> months [<b><font color=#3a6797>clock</font></b> format [<b><font color=#3a6797>clock</font></b> scan <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>i/01/2021&quot;</font> \
      <font color=#653760>-format</font> %D <font color=#653760>-locale</font> <font color=#1b1baa>$loc</font>] <font color=#653760>-format</font> %B <font color=#653760>-locale</font> <font color=#1b1baa>$loc</font>]
  }
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$months</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::weekdays></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::weekdays {{loc <font color=#8b2a0e>&quot;&quot;</font>}} {
  <i><font color=#4b5d50># Gets a list of week days according to a locale.</font></i>
  <i><font color=#4b5d50>#   loc - the locale</font></i>
  <i><font color=#4b5d50># Return list of weekdays and week format (%u or %w)</font></i>

  <b><font color=#3a6797>variable</font></b> my::locales
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$loc</font> eq {}} {<b><font color=#3a6797>set</font></b> loc [my::DefaultLocale]}
  <b><font color=#3a6797>if</font></b> {[<b><font color=#3a6797>array</font></b> names my::locales <font color=#1b1baa>$loc</font>] ne {}} {
    <b><font color=#3a6797>set</font></b> wformat <font color=#1b1baa>$my::locales($loc)</font>
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> wformat %u  ;<i><font color=#4b5d50># by default, 1st day of week is Monday</font></i>
  }
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$wformat</font> eq {%u}} {  ;<i><font color=#4b5d50># Sunday be the last day of week</font></i>
    <b><font color=#3a6797>set</font></b> wdays {1 2 3 4 5 6 7}
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> wdays {0 1 2 3 4 5 6}
  }
  <b><font color=#3a6797>set</font></b> days [<b><font color=#3a6797>list</font></b>]
  <b><font color=#3a6797>foreach</font></b> i <font color=#1b1baa>$wdays</font> {
    <b><font color=#3a6797>lappend</font></b> days [<b><font color=#3a6797>clock</font></b> format [<b><font color=#3a6797>clock</font></b> scan <font color=#8b2a0e>&quot;03/<font color=#1b1baa>[</font>expr <font color=#1b1baa>{</font>14+<font color=#1b1baa>$</font>i<font color=#1b1baa>}]</font>/2021&quot;</font> \
      <font color=#653760>-format</font> %D <font color=#653760>-locale</font> <font color=#1b1baa>$loc</font>] <font color=#653760>-format</font> %a <font color=#653760>-locale</font> <font color=#1b1baa>$loc</font>]
  }
  <b><font color=#3a6797>list</font></b> <font color=#1b1baa>$days</font> <font color=#1b1baa>$wformat</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::clearup></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::clearup {} {
  <i><font color=#4b5d50># Clearance for klnd data (variable my::p).</font></i>

  <b><font color=#3a6797>variable</font></b> my::p
  <b><font color=#3a6797>array</font></b> unset my::p *
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::clearArgs></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::clearArgs {args} {
  <i><font color=#4b5d50># Removes specific options from args.</font></i>
  <i><font color=#4b5d50>#   args - list of options</font></i>

  ::apave::removeOptions <font color=#1b1baa>$args</font> <font color=#653760>-title</font> <font color=#653760>-value</font> <font color=#653760>-tvar</font> <font color=#653760>-locale</font> <font color=#653760>-parent</font> <font color=#653760>-dateformat</font> <font color=#653760>-weekday</font> <font color=#653760>-com</font> <font color=#653760>-command</font> <font color=#653760>-currentmonth</font> <font color=#653760>-united</font> <font color=#653760>-daylist</font> <font color=#653760>-hllist</font> <font color=#653760>-popup</font> <font color=#653760>-tip</font> <font color=#653760>-weeks</font>
}
<i><font color=#4b5d50>#_______________________</font></i>
<a id=klnd::calendar></a>
<b><font color=#ca14ca>proc</font></b> ::klnd::calendar {args} {
  <i><font color=#4b5d50># The main procedure of the calendar's toplevel.</font></i>
  <i><font color=#4b5d50>#   args - options of the calendar</font></i>

  <b><font color=#3a6797>variable</font></b> my::p
  <b><font color=#3a6797>set</font></b> my::p(isWidget) no
  <i><font color=#4b5d50># get options and initialize the calendar's settings</font></i>
  <b><font color=#3a6797>lassign</font></b> [my::InitCalendar {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>] title datevalue tvar parent centerme geo entry
  <b><font color=#3a6797>set</font></b> args [clearArgs {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font>]
  <i><font color=#4b5d50># priority of geometry options: -geometry, -entry, -parent, -centerme</font></i>
  <i><font color=#4b5d50># if no geometry option, show the calendar under the mouse pointer</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$geo</font> ne {}} {
    <b><font color=#3a6797>set</font></b> geo <font color=#8b2a0e>&quot;-geometry <font color=#1b1baa>$</font>geo&quot;</font>
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$entry</font> ne {}} {
    <b><font color=#3a6797>set</font></b> x [<b><font color=#134070>winfo</font></b> rootx <font color=#1b1baa>$entry</font>]
    <b><font color=#3a6797>set</font></b> y [<b><font color=#3a6797>expr</font></b> {[<b><font color=#134070>winfo</font></b> rooty <font color=#1b1baa>$entry</font>]+32}]
    <b><font color=#3a6797>set</font></b> geo <font color=#8b2a0e>&quot;-geometry +<font color=#1b1baa>$</font>x+<font color=#1b1baa>$</font>y&quot;</font>
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$parent</font> ne {}} {
    <b><font color=#3a6797>set</font></b> geo <font color=#8b2a0e>&quot;-centerme <font color=#1b1baa>$</font>parent&quot;</font>    ;<i><font color=#4b5d50># to center in a toplevel window</font></i>
  } <b><font color=#3a6797>elseif</font></b> {<font color=#1b1baa>$centerme</font> ne {}} {
    <b><font color=#3a6797>set</font></b> geo <font color=#8b2a0e>&quot;-centerme <font color=#1b1baa>$</font>centerme&quot;</font>  ;<i><font color=#4b5d50># it's an option of apave's</font></i>
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> geo <font color=#8b2a0e>&quot;-geometry +<font color=#1b1baa>[</font>expr <font color=#1b1baa>{[</font>winfo pointerx .<font color=#1b1baa>]</font>+10<font color=#1b1baa>}]</font>+<font color=#1b1baa>[</font>expr <font color=#1b1baa>{[</font>winfo pointery .<font color=#1b1baa>]</font>+10<font color=#1b1baa>}]</font>&quot;</font>
  }
  <b><font color=#3a6797>set</font></b> parent [<b><font color=#3a6797>string</font></b> trimright <font color=#1b1baa>$parent</font> .]
  <b><font color=#3a6797>set</font></b> win [<b><font color=#3a6797>set</font></b> my::p(win) <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>parent._apave_CALENDAR_&quot;</font>]
  <b><font color=#3a6797>catch</font></b> {<font color=#1b1baa>$my::p(obj)</font> destroy}
  <i><font color=#4b5d50># create apave object and layout its window</font></i>
  <b><font color=#3a6797>set</font></b> my::p(obj) [::apave::APave create APAVE_CLND <font color=#1b1baa>$win</font>]
  <font color=#1b1baa>$my::p(obj)</font> makeWindow <font color=#1b1baa>$win</font>.fra <font color=#1b1baa>$title</font>
  <font color=#1b1baa>$my::p(obj)</font> paveWindow <font color=#1b1baa>$win</font>.fra [<b><font color=#3a6797>list</font></b> \
    {<b><font color=#3a6797>*</font></b>}[my::MainWidgets] \
    {seh fra T 1 7 {<font color=#653760>-pady</font> 0}} \
    {fraBottom seh T 1 7 {<font color=#653760>-st</font> ew <font color=#653760>-pady</font> 1}} \
    {fraBottom.h_ - - - - {<b><font color=#134070>pack</font></b> <font color=#653760>-fill</font> both <font color=#653760>-expand</font> 1 <font color=#653760>-side</font> left} {}} \
    {fraBottom.ButOK - - - - {<b><font color=#134070>pack</font></b> <font color=#653760>-side</font> left} {<font color=#653760>-t</font> OK <font color=#653760>-com</font> ::klnd::my::PickDay}} \
    {fraBottom.ButClose - - - - {<b><font color=#134070>pack</font></b> <font color=#653760>-side</font> left} {<font color=#653760>-t</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>my::Close&quot;</font> <font color=#653760>-com</font> <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>my::p(obj) res <font color=#1b1baa>$</font>win 0&quot;</font>}} \
  ]
  <b><font color=#3a6797>unset</font></b> <font color=#653760>-nocomplain</font> ::klnd::TMPTIP
  <b><font color=#3a6797>unset</font></b> <font color=#653760>-nocomplain</font> ::klnd::TMPPACKW
  <i><font color=#4b5d50># binds for day buttons and 'Close'</font></i>
  <b><font color=#3a6797>foreach</font></b> {ev prc} { &lt;Home&gt; <font color=#8b2a0e>&quot;::klnd::my::GoYear -1 yes&quot;</font> &lt;End&gt; <font color=#8b2a0e>&quot;::klnd::my::GoYear 1 yes&quot;</font> \
  &lt;Prior&gt; <font color=#8b2a0e>&quot;::klnd::my::GoMonth -1 yes&quot;</font> &lt;Next&gt; <font color=#8b2a0e>&quot;::klnd::my::GoMonth 1 yes&quot;</font>} {
    <b><font color=#3a6797>for</font></b> {<b><font color=#3a6797>set</font></b> i 1} {<font color=#1b1baa>$i</font>&lt;38} {<b><font color=#3a6797>incr</font></b> i} {
      <b><font color=#3a6797>set</font></b> but [<font color=#1b1baa>$my::p(obj)</font> BuT_KLNDSTD<font color=#1b1baa>$i</font>]
      <b><font color=#134070>bind</font></b> <font color=#1b1baa>$but</font> <font color=#1b1baa>$ev</font> <font color=#1b1baa>$prc</font>
      <b><font color=#134070>bind</font></b> <font color=#1b1baa>$but</font> &lt;FocusIn&gt; <font color=#8b2a0e>&quot;::klnd::my::Enter <font color=#1b1baa>$</font>i&quot;</font>
      <b><font color=#134070>bind</font></b> <font color=#1b1baa>$but</font> &lt;Button-1&gt; <font color=#8b2a0e>&quot;::klnd::my::Enter <font color=#1b1baa>$</font>i 0 <font color=#1b1baa>{</font>-code break<font color=#1b1baa>}</font>&quot;</font>
      <b><font color=#134070>bind</font></b> <font color=#1b1baa>$but</font> &lt;KeyPress&gt; <font color=#8b2a0e>&quot;::klnd::my::KeyPress <font color=#1b1baa>$</font>i %K %s&quot;</font>
      <b><font color=#134070>bind</font></b> <font color=#1b1baa>$but</font> &lt;Double-1&gt; <font color=#8b2a0e>&quot;::klnd::my::PickDay <font color=#1b1baa>$</font>i <font color=#1b1baa>{</font>-code break<font color=#1b1baa>}</font>&quot;</font>
    }
    <b><font color=#3a6797>catch</font></b> {<b><font color=#134070>bind</font></b> [<font color=#1b1baa>$my::p(obj)</font> ButClose] <font color=#1b1baa>$ev</font> <font color=#1b1baa>$prc</font>}
  }
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$win</font> &lt;F3&gt; ::klnd::my::SetCurrentDay
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$win</font> &lt;KeyPress&gt; <font color=#8b2a0e>&quot;::klnd::my::Leave&quot;</font>
  <b><font color=#3a6797>set</font></b> bok [<font color=#1b1baa>$my::p(obj)</font> ButOK]
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$bok</font> &lt;FocusIn&gt; {::klnd::my::ChosenDay yes}
  <b><font color=#134070>bind</font></b> <font color=#1b1baa>$bok</font> &lt;FocusOut&gt; <font color=#8b2a0e>&quot;<font color=#1b1baa>$</font>bok configure -text OK&quot;</font>
  <i><font color=#4b5d50># show and work with the calendar</font></i>
  <b><font color=#3a6797>after</font></b> idle <font color=#8b2a0e>&quot;::klnd::my::ShowMonth <font color=#1b1baa>$</font>my::p(m) <font color=#1b1baa>$</font>my::p(y) yes&quot;</font>
  <b><font color=#3a6797>set</font></b> res [<font color=#1b1baa>$my::p(obj)</font> showModal <font color=#1b1baa>$win</font> <font color=#653760>-resizable</font> no {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$args</font> {<b><font color=#3a6797>*</font></b>}<font color=#1b1baa>$geo</font>]
  <i><font color=#4b5d50># get the result of the selection if any</font></i>
  <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$res</font> && <font color=#1b1baa>$my::p(dvis)</font>} {
    <b><font color=#3a6797>set</font></b> res [my::ChosenDay]
    <b><font color=#3a6797>if</font></b> {<font color=#1b1baa>$tvar</font> ne {}} {<b><font color=#3a6797>set</font></b> <font color=#1b1baa>$tvar</font> <font color=#1b1baa>$res</font>}
  } <b><font color=#3a6797>else</font></b> {
    <b><font color=#3a6797>set</font></b> res {}
  }
  <b><font color=#3a6797>catch</font></b> {<font color=#1b1baa>$my::p(obj)</font> destroy}
  <b><font color=#3a6797>catch</font></b> {<b><font color=#134070>destroy</font></b> <font color=#1b1baa>$win</font>}
  <b><font color=#ca14ca>return</font></b> <font color=#1b1baa>$res</font>
}
<a id=EOF></a>
<i><font color=#4b5d50># _________________________________ EOF _________________________________ #</font></i>

</pre>

<table border=0 cellPadding=4 cellSpacing=0 width=100%>  <td border=0 bgColor=#bdd7e7><div style=text-align:center>  <a href="../../../index.html"><font color=#1a1a1a size=6>  <b>klnd.tcl</b></font></div></td></table>

</section>
<script>
  writeFooter('Generated by <a href="'+homeLINK()+'/en/tcl/alited/index.html">alited</a> &amp; <a href="'+homeLINK()+'/en/tcl/mulster/index.html">mulster</a></a>');
</script>
</div>
</body>
</html>